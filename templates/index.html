<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat & Document UI</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #f7f7f8;
  color: #000;
  height: 100vh;
}
.sidebar {
  width: 70px;
  background-color: #f8fafc; /* lighter gray */
  border-right: 1px solid #e5e7eb;
  box-shadow: 2px 0 10px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  justify-content: flex-start; /* allow manual centering/bottom placement */
  align-items: center;
  padding: 10px 0;
}
.sidebar .logo {
  font-size: 32px;
  color: orange;
  margin-bottom: 28px;
}
.nav {
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: center;
}
.nav a {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 44px;
  height: 44px;
  border-radius: 6px;
  transition: background 0.3s;
  color: #000;
  font-size: 28px;
}
.nav a:hover {
  background-color: rgba(0,0,0,0.05);
}
/* active icon color blue */
.nav a.active { color: #2563eb; }
/* center and bottom utility groups for primary sidebar */
.nav-center { margin-top: auto; margin-bottom: auto; }
.nav-bottom { margin-top: auto; }
.profile {
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: center;
  color: #000;
  font-size: 18px;
}
/* Profile icons size */
.profile i {
  font-size: 28px;
}
.second-sidebar {
  position: relative;
  width: 260px;
  background-color: #E4E4E7; /* light gray */
  border-right: 1px solid #e5e7eb;
  display: flex;
  flex-direction: column;
  padding: 10px;
  color: #000;
  overflow: hidden;
  transition: width 0.25s ease, padding 0.25s ease;
}

/* Sidebar Header Styles */
.sidebar-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 12px;
  margin-bottom: 20px;
  background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
  border-radius: 12px;
  color: white;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
}

.sidebar-header-icon {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: #ffffff;
}

.sidebar-header-title {
  font-size: 22px;
  font-weight: 600;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  color: white;
}

/* Settings Modal */
.settings-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: flex-start;
  justify-content: flex-start;
  z-index: 1000;
}
.settings-modal-overlay.active { display: flex; }
.settings-modal {
  width: 420px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 12px 36px rgba(0,0,0,0.2);
  overflow: hidden;
  border: 1px solid #e5e7eb;
  position: fixed;
}
.settings-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: #f3f4f6;
  border-bottom: 1px solid #e5e7eb;
}
.settings-modal-header .title { font-weight: 700; }
.settings-modal-header .close-btn { color: #000; }
.settings-modal-body { padding: 12px 16px; }
.settings-item { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f1f5f9; }
.settings-item:last-child { border-bottom: 0; }
.theme-options { display:flex; gap:10px; }
.theme-btn, .theme-icon-btn, .icon-only-btn { padding:6px 10px; border:1px solid #000; border-radius:8px; background:#000; cursor:pointer; color:#fff; }
.theme-btn:hover, .theme-icon-btn:hover, .icon-only-btn:hover { background:#000; color:#fff; opacity:0.9; }
.theme-icon-btn i { font-size:16px; color:#fff; }
.icon-only-btn { display:flex; align-items:center; justify-content:center; width:40px; height:32px; }
.icon-only-btn i { color:#ffffff; }
.theme-btn.active, .theme-icon-btn.active { border-color:#2563eb; color:#93c5fd; }
.settings-modal-footer { display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; background:#f9fafb; border-top:1px solid #e5e7eb; }

/* Dark theme overrides */
body.theme-dark { background:#0f172a; color:#e5e7eb; }
body.theme-dark .sidebar { background:#0b1220; border-color:#1f2937; box-shadow:none; }
body.theme-dark .second-sidebar { background:#111827; border-color:#1f2937; }
body.theme-dark .nav a { color:#e5e7eb; }
body.theme-dark .nav a:hover { background: rgba(255,255,255,0.08); }
body.theme-dark .doc-item { background:#111827; border-color:#1f2937; }
body.theme-dark .doc-item .doc-icon { background:#0b1220; color:#e5e7eb; }
body.theme-dark .doc-item span { color:#ffffff; }
body.theme-dark .second-sidebar .nav-bottom a { background:#0b1220; color:#e5e7eb; border-color:#1f2937; }
body.theme-dark .second-sidebar .nav-bottom a:hover { background:#111827; color:#e5e7eb; }
body.theme-dark .chat-header { background: linear-gradient(135deg, #0b4dd8 0%, #0c2a78 100%) !important; }
body.theme-dark .settings-modal { background:#0b1220; border-color:#1f2937; }
body.theme-dark .settings-modal-header { background:#111827; border-color:#1f2937; }
body.theme-dark .settings-modal-body { color:#e5e7eb; }
body.theme-dark .settings-modal-footer { background:#0b1220; border-color:#1f2937; }
/* Keep modal buttons black even in dark theme */
body.theme-dark .theme-btn, body.theme-dark .theme-icon-btn, body.theme-dark .icon-only-btn { background:#000; border-color:#000; color:#fff; }
body.theme-dark .icon-only-btn i { color:#ffffff; }
body.theme-dark .theme-btn.active, body.theme-dark .theme-icon-btn.active { border-color:#60a5fa; color:#93c5fd; }

.second-sidebar h3 {
  margin-top: 10px;
  font-size: 12px;
  color: #555;
}
/* .second-sidebar .toggle-second {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: #e5e7eb;
  color: #111827;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
} */
.second-sidebar.collapsed {
  width: 16px;
}

/* Cases Container and Collapsible Table */
.cases-container {
  display: flex;
  gap: 20px;
  height: 100%;
}

.cases-table-section {
  flex: 1;
  transition: flex 0.3s ease;
}

.cases-table-section.collapsed {
  flex: 0.4 !important;
  width: 40% !important;
  max-width: 40% !important;
}

/* Analysis Panel */
.analysis-panel {
  width: 450px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  margin-left: 20px;
  position: relative;
  height: fit-content;
  max-height: calc(100vh - 40px);
  z-index: 1000;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.analysis-panel[style*="display: flex"] {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.analysis-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
  color: white;
  position: relative;
  overflow: hidden;
}

.analysis-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.analysis-header h4 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-analysis-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.close-analysis-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

.analysis-content {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
}

.analysis-section {
  margin-bottom: 24px;
  background: #f8fafc;
  border-radius: 12px;
  padding: 16px;
  border: 1px solid #e2e8f0;
  transition: all 0.2s ease;
}

.analysis-section:hover {
  background: #f1f5f9;
  border-color: #cbd5e1;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.analysis-section label {
  display: block;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 12px;
  font-size: 15px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
}

.analysis-section label::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, #3b82f6, #60a5fa);
  border-radius: 1px;
}

.analysis-section label i {
  margin-right: 8px;
  color: #3b82f6;
}

.analysis-text {
  background: #ffffff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 16px;
  min-height: 80px;
  max-height: 150px;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.6;
  color: #334155;
  text-align: justify;
  white-space: pre-wrap;
  word-break: break-word;
  hyphens: auto;
  font-weight: 400;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

.analysis-actions {
  display: flex;
  gap: 16px;
  margin-top: 24px;
  padding-top: 24px;
  border-top: 2px solid #e2e8f0;
  background: #f8fafc;
  padding: 20px;
  margin: 24px -16px -16px -16px;
  border-radius: 0 0 12px 12px;
}

.analysis-actions .btn {
  flex: 1;
  padding: 14px 20px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 10px;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.analysis-actions .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* Dark theme overrides for analysis panel */
body.theme-dark .analysis-panel {
  background: #111827;
  border-color: #1f2937;
}

body.theme-dark .analysis-header {
  background: linear-gradient(135deg, #0b4dd8 0%, #0c2a78 100%);
}

body.theme-dark .analysis-section label {
  color: #e5e7eb;
}

/* Analysis Modal Styles */
.analysis-modal {
  position: fixed;
  top: 0;
  padding-left: 130px;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.analysis-modal.show {
  opacity: 1;
  visibility: visible;
  display: flex !important;
}

.analysis-modal-content {
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow: hidden;
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.analysis-modal.show .analysis-modal-content {
  transform: scale(1);
}

/* Click outside to close functionality */
.analysis-modal {
  cursor: pointer;
}

.analysis-modal-content {
  cursor: default;
}

.analysis-modal-header {
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
  color: white;
  padding: 24px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  overflow: hidden;
}

.analysis-modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
  animation: shimmer 2s infinite;
}

.analysis-modal-header h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.close-analysis-modal-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  font-size: 18px;
}

.close-analysis-modal-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

.analysis-modal-body {
  padding: 32px;
  max-height: 60vh;
  overflow-y: auto;
}

.analysis-modal-section {
  margin-bottom: 32px;
  background: #f8fafc;
  border-radius: 16px;
  padding: 24px;
  border: 1px solid #e2e8f0;
  transition: all 0.2s ease;
}

.analysis-modal-section:hover {
  background: #f1f5f9;
  border-color: #cbd5e1;
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
}

.analysis-modal-section label {
  display: block;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 16px;
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
}

.analysis-modal-section label::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 0;
  width: 40px;
  height: 3px;
  background: linear-gradient(90deg, #3b82f6, #60a5fa);
  border-radius: 2px;
}

.analysis-modal-section label i {
  margin-right: 10px;
  color: #3b82f6;
  font-size: 18px;
}

.analysis-modal-text {
  background: #ffffff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  min-height: 100px;
  max-height: 200px;
  overflow-y: auto;
  font-size: 15px;
  line-height: 1.7;
  color: #334155;
  text-align: justify;
  white-space: pre-wrap;
  word-break: break-word;
  hyphens: auto;
  font-weight: 400;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

.analysis-modal-actions {
  display: flex;
  gap: 20px;
  padding: 24px 32px;
  border-top: 2px solid #e2e8f0;
  background: #f8fafc;
}

.analysis-modal-actions .btn {
  flex: 1;
  padding: 16px 24px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.analysis-modal-actions .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

/* Dark theme overrides for analysis modal */
body.theme-dark .analysis-modal-content {
  background: #111827;
  border-color: #1f2937;
}

body.theme-dark .analysis-modal-header {
  background: linear-gradient(135deg, #0b4dd8 0%, #0c2a78 100%);
}

body.theme-dark .analysis-modal-section {
  background: #1f2937;
  border-color: #374151;
}

body.theme-dark .analysis-modal-section:hover {
  background: #374151;
  border-color: #4b5563;
}

body.theme-dark .analysis-modal-section label {
  color: #e5e7eb;
}

body.theme-dark .analysis-modal-text {
  background: #374151;
  border-color: #4b5563;
  color: #d1d5db;
}

body.theme-dark .analysis-modal-actions {
  background: #1f2937;
  border-color: #374151;
}

body.theme-dark .analysis-text {
  background: #1f2937;
  border-color: #374151;
  color: #e5e7eb;
}

body.theme-dark .analysis-actions {
  border-color: #374151;
}
/* .second-sidebar.collapsed .toggle-second {
  right: -12px; /* keep handle visible */
 */
.second-sidebar .nav-bottom {
  margin-top: auto;     /* push to bottom */
  display: flex;
  flex-direction: column;
  gap: 15px; /* Reduced gap */
  padding: 15px 0; /* Reduced padding */
  align-items: center;
}

.second-sidebar .nav-bottom a {
  color: #333;
  font-size: 16px; /* Reduced font size */
  padding: 12px 16px; /* Match main navigation padding */
  text-decoration: none;
  display: flex;
  align-items: center;
  justify-content: space-between; /* Space between text and icon */
  transition: all 0.3s ease;
  background: #fff; /* Match main navigation background */
  border-radius: 10px; /* Match main navigation border radius */
  border: 1px solid #ddd; /* Match main navigation border */
  width: 85%; /* Reduce width from right side */
  min-height: auto; /* Remove min-height constraint */
  margin: 0; /* Remove margin */
  font-weight: 500; /* Match main navigation font weight */
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; /* Add Segoe UI font */
  margin-bottom: 10px;
}

.second-sidebar .nav-bottom a:hover {
  color: #333; /* Keep text gray on hover, not blue */
  background: #f5f5f5; /* Light gray background on hover */
  transform: none; /* Remove scale effect */
}

.second-sidebar .nav-bottom a.active {
  color: #333; /* Keep text gray when active, not blue */
}

/* User profile box under Logout */
.second-sidebar .user-profile-box {
  margin-top: 10px;
  width: 85%;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}
.second-sidebar .user-profile-box .avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  overflow: hidden;
  background: #111827;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}
.second-sidebar .user-profile-box .avatar img { width:100%; height:100%; object-fit: cover; display:none; }
.second-sidebar .user-profile-box .avatar .initials { font-weight:700; font-size:14px; }
.second-sidebar .user-profile-box .info { display:flex; flex-direction:column; }
.second-sidebar .user-profile-box .name { font-weight: 700; color:#111827; font-size: 14px; }

/* Dark theme profile box */
body.theme-dark .second-sidebar .user-profile-box { background:#0b1220; border-color:#1f2937; }
body.theme-dark .second-sidebar .user-profile-box .name { color:#e5e7eb; }
body.theme-dark .second-sidebar .user-profile-box .email { color:#9ca3af; }

.second-sidebar .nav-bottom a span {
  font-size: 16px;
  font-weight: 700; /* Make text bold */
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; /* Add Segoe UI font */
}

.second-sidebar .nav-bottom a i {
  font-size: 22px; /* Increased icon size from 20px to 22px */
  color: #111827; /* Match main navigation icon color */
}

.second-sidebar .nav-bottom a:hover i {
  color: #111827; /* Keep icon color same on hover, no blue */
}

.second-sidebar .nav-bottom a.active i {
  color: #111827; /* Keep icon color same when active, no blue */
}

.sidebar-title {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: flex-start;
  font-weight: 700;
  color: #333;
  font-size: 22px;
  margin: 8px 0 16px 2px;
}
.chat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
  color: #fff;
  padding: 10px 12px;
  border-radius: 14px;
  margin-bottom: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}
.chat-item span { margin-left: 6px; }
.chat-icon {
  background: rgba(255,255,255,0.2);
  color: #fff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}
.doc-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
  border: 1px solid #ddd;
  padding: 12px 16px; /* Reduced padding to decrease height */
  border-radius: 10px;
  margin-bottom: 12px; /* Reduced margin */
  font-size: 18px;
  font-weight: 500;
  cursor: pointer;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.doc-item:hover {
  background: #fafafa;
}

/* Document action buttons */
.view-doc-btn, .delete-doc-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  margin: 0 2px;
  transition: all 0.2s ease;
}

.view-doc-btn {
  background: #2563eb;
  color: white;
  text-decoration: none;
}

.view-doc-btn:hover {
  background: #1d4ed8;
}

.delete-doc-btn {
  background: #dc2626;
  color: white;
}

.delete-doc-btn:hover {
  background: #b91c1c;
}

/* Action buttons styling */
.action-btn {
  padding: 6px 10px;
  margin: 0 2px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.action-btn i { color:#ffffff; }

.edit-btn { background-color: #2563eb; color: white; }
.edit-btn:hover { background-color: #2563eb; }
.edit-btn:hover i { color:#ffffff; }

.delete-btn { background-color: #dc2626; color: white; }
.delete-btn:hover { background-color: #dc2626; }
.delete-btn:hover i { color:#ffffff; }

/* Center action buttons column */
.admin-table th,
.admin-table td { vertical-align: middle; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
.admin-table td:last-child, .admin-table th:last-child { text-align: center; }
.doc-icon {
  background: #111827; /* slate-900 */
  color: #fff; /* inner icon white */
  border-radius: 6px; /* Reduced from 10px to decrease "carve" */
  width: 32px; /* Reduced from 36px */
  height: 32px; /* Reduced from 36px */
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px; /* Reduced from 18px */
}
.doc-plus {
  background: orange;
  border-radius: 50%;
  color: #fff;
  width: 14px;
  height: 14px;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  position: absolute;
  right: -8px;
}
.doc-item:hover .doc-plus {
  display: flex;
}

/* Selected state for second sidebar items */
.doc-item.active {
  background: #E9E9EA; /* medium gray on selected */
  border-color: #d1d5db;
  color: #111827;
}
.doc-item.active .doc-icon { background: #2563eb; color: #fff; }
.doc-item.active span { color: #000; font-weight: 700; }
.doc-item.active .doc-icon {
  background: #2563eb; /* blue */
  color: #fff; /* inner icon white */
  width: 32px; /* Keep same size as unselected */
  height: 32px; /* Keep same size as unselected */
  font-size: 16px; /* Keep same size as unselected */
}
/* Chat history items */
.history-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border: 1px solid #ddd;
  padding: 8px 10px;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 14px;
  cursor: pointer;
}
.history-item.active { background: #e2e8f0; border-color: #cbd5e1; }
.history-title { max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; }
.history-actions { display: inline-flex; align-items: center; gap: 6px; }
.history-item .delete-btn { display: none; color: #ef4444; }
.history-item:hover .delete-btn { display: inline-flex; }
.history-item:hover .chev { display: none; }
.history-item .delete-btn:hover { color: #b91c1c; }
.main {
  display: flex;
  padding: 0; /* remove inner padding/gaps */
  background-color: #fff;
  /* Ensure proper positioning context */
  position: relative;
}
.chat-panel {
  flex: 1;
  padding: 24px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 16px;
  margin: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
  overflow: hidden;
  position: relative;
}

.chat-panel h3 {
  font-size: 24px;
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e5e7eb;
}

.chat-panel h3 i {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 28px;
}

/* Panel Header */
.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: top;
  margin-bottom: 24px;
  padding: 20px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

.panel-header h3 {
  margin: 0;
  border: none;
  padding: 0;
}
.panel-header h3 i { color: #086ad8; -webkit-text-fill-color: initial; background: none; }

/* Table header center search */
.table-search {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 9999px;
  padding: 8px 14px;
  box-shadow: 0 6px 20px rgba(8,106,216,0.08);
  width: 60%;
  max-width: 800px;
}
.table-search i { color:#6b7280; }
.table-search input {
  border: none;
  outline: none;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
  width: 100%;
}
body.theme-dark .table-search { background:#0b1220; border-color:#1f2937; box-shadow:none; }
body.theme-dark .table-search i { color:#9ca3af; }
body.theme-dark .table-search input { color:#e5e7eb; background:transparent; }

/* Add Button Styling */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn-primary {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  color: #ffffff;
  box-shadow: 0 2px 8px rgba(8, 106, 216, 0.2);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  box-shadow: 0 4px 12px rgba(8, 106, 216, 0.3);
}

.btn-primary:active {
  transform: translateY(1px);
}

.btn-info {
  background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
  color: #ffffff;
  box-shadow: 0 2px 8px rgba(8, 145, 178, 0.2);
}

.btn-info:hover {
  background: linear-gradient(135deg, #0e7490 0%, #155e75 100%);
  box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
}

.btn-info:active {
  transform: translateY(1px);
}



/* Table Styling Enhancement */
.admin-table {
  width: 100%;
  border-collapse: collapse;
  background: #ffffff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border: 1px solid #e5e7eb;
}

.admin-table thead {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
}

.admin-table th {
  padding: 18px 16px;
  text-align: left;
  color: #ffffff;
  font-weight: 600;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.admin-table td {
  padding: 16px;
  border-bottom: 1px solid #f3f4f6;
  color: #374151;
  font-size: 14px;
  vertical-align: middle;
}

.admin-table tbody tr {
  transition: all 0.2s ease;
}

.admin-table tbody tr:hover {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  transform: translateX(4px);
}

.admin-table tbody tr:last-child td {
  border-bottom: none;
}

/* Action Buttons Enhancement */
.action-btn {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  margin: 0 4px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  min-width: 36px;
  height: 36px;
}

.edit-btn { background:#2563eb; color:#ffffff; box-shadow:none; }
.edit-btn:hover { transform:none; box-shadow:none; background:#2563eb; }

.delete-btn { background:#dc2626; color:#ffffff; box-shadow:none; }
.delete-btn:hover { transform:none; box-shadow:none; background:#dc2626; }

.action-btn:active {
  transform: translateY(0);
}

.chat-welcome {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: #555;
  font-size: 14px;
}
.message {
  background-color: #f0f0f0;
  padding: 10px 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  font-size: 15px;
  width: 50%;
}
.message.agent { align-self: flex-start; background: #f8fafc; border: 1px solid #e2e8f0; }
.message.user { align-self: flex-end; background: #e5e7eb; border: 1px solid #cbd5e1; }
.message p { margin: 4px 0; }
.message ul { margin: 6px 0 6px 18px; padding: 0; list-style: disc; }
.message li { margin: 2px 0; }
.message h4 { margin: 6px 0; font-size: 18px; font-weight: 700; }
.input-area {
  display: flex;
  gap: 6px;
  align-items: center;
  justify-content: center;
}
.input-area input {
  flex: 0 1 400px;
  padding: 6px 10px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-size: 26px; /* user-typed text size */
  height: 38px;
  line-height: 26px;
  margin: 0 auto;
}
.input-area input::placeholder { font-size: 14px; }
.icon-button {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  border: none;
  color: white;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 46px;
  height: 46px;
  box-shadow: 0 2px 8px rgba(8, 106, 216, 0.3);
  transition: all 0.2s ease;
}
.icon-button:hover {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(8, 106, 216, 0.4);
}
.chat-footer-note {
  text-align: center;
  font-size: 12px;
  color: #777;
  margin-top: 6px;
}
/* Upload section styling - removed duplicate */

/* Utilities */
.hidden { display: none !important; }

/* Auth Screens */
.auth-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: #fff;
}
.auth-split {
  height: 100%;
  display: grid;
  grid-template-columns: 1fr 1fr;
}
.auth-left {
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}
.auth-left .form-wrap { width: 420px; max-width: 86%; display: flex; flex-direction: column; gap: 12px; }
.auth-title { font-size: 28px; font-weight: 700; margin-bottom: 18px; color: #0f172a; }
.auth-field { width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; }
.auth-label { font-size: 12px; color: #64748b; margin: 10px 0 6px; display: block; }
.auth-btn { width: 60%; max-width: 280px; padding: 12px 14px; background: linear-gradient(180deg, #0A7CE6 0%, #086AD8 100%); border: none; color: #fff; border-radius: 10px; font-weight: 700; cursor: pointer; display: block; margin: 10px auto; }
/* Keep hover same (no color change) */
.auth-btn:hover { background: linear-gradient(180deg, #0A7CE6 0%, #086AD8 100%); }
.auth-muted { font-size: 12px; color: #6b7280; text-align: center; margin-top: 10px; }
.auth-link { color: #2563eb; text-decoration: none; cursor: pointer; }
.auth-google { width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; box-sizing: border-box; margin: 0; }
.auth-google i { color: #ea4335; }
.auth-right { background: #0b0b0c; color: #fff; display: flex; align-items: center; justify-content: center; text-align: center; padding: 40px; }
.admin-leftbar:not(.hidden) ~ .auth-right { display: none; }
.auth-brand { max-width: 520px; }
.brand-icon { font-size: 64px; background: #fff; color: #0b0b0c; border-radius: 22px; padding: 18px 22px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 18px; }
.brand-title { font-size: 28px; font-weight: 800; margin: 12px 0; }
.brand-text { color: #e5e7eb; line-height: 1.6; }
.brand-powered { margin-top: 18px; color: #cbd5e1; font-size: 12px; }

/* Admin sidebar within Sign In */
.auth-admin-container { width: 760px; max-width: 92%; display: grid; grid-template-columns: 220px 1fr; gap: 14px; align-items: start; }
.admin-sidebar { background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
.admin-title { font-weight: 800; color: #0f172a; display:flex; align-items:center; gap:8px; margin-bottom: 6px; }
.admin-link { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; font-weight:700; color:#111827; cursor:pointer; display:flex; align-items:center; gap:8px; }
.admin-link:hover { background:#f1f5f9; }

/* Admin Modal */
.admin-modal { 
  position: absolute; 
  top: 0;
  left: 400px; /* shift overlay to the right to expose left area */
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5); 
  z-index: 10000; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  backdrop-filter: blur(4px);
  /* Ensure modal is contained within its parent */
  overflow: hidden;
  /* Force modal to be contained within its positioned parent */
  position: absolute !important;
}

@media (max-width: 900px) {
  .admin-modal { left: 0; }
}

.admin-modal.hidden { 
  display: none; 
}

.admin-modal-content { 
  background: #fff; 
  width: 800px; 
  max-width: 95%; 
  max-height: 85vh; 
  border-radius: 16px; 
  overflow: hidden; 
  display: flex; 
  flex-direction: column; 
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  border: 1px solid #e5e7eb;
  /* Ensure modal content is properly contained */
  box-sizing: border-box;
  margin: auto;
  /* Better responsive sizing */
  min-width: 320px;
}
.admin-modal-header { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  padding: 16px 20px; 
  border-bottom: 1px solid #e5e7eb; 
  background: #f8fafc; 
  border-radius: 8px 8px 0 0;
}

.admin-modal-header h3 { 
  margin: 0; 
  font-size: 20px; 
  font-weight: 700; 
  color: #111827;
}

.admin-modal-close { 
  background: none; 
  border: none; 
  font-size: 18px; 
  cursor: pointer; 
  color: #6b7280; 
  border-radius: 6px; 
  width: 32px; 
  height: 32px; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  transition: all 0.2s ease;
}

.admin-modal-close:hover { 
  background: #e5e7eb; 
  color: #374151;
}

.admin-modal-body { 
  padding: 24px; 
  overflow: auto; 
  background: #fff;
  /* Better modal body styling */
  flex: 1;
  display: flex;
  flex-direction: column;
}
.admin-table { 
  width: 100%; 
  background: #fff;
  border-radius: 8px;
  /* Allow scrolling when table is wider than modal */
  overflow-x: auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.admin-table table { 
  width: 100%; 
  border-collapse: collapse; 
}

.admin-table th, .admin-table td { 
  text-align: left; 
  border-bottom: 1px solid #e5e7eb; 
  padding: 12px 16px; 
  font-size: 13px; 
}

.admin-table th { 
  background: #f8fafc; 
  font-weight: 600;
  color: #374151;
  font-size: 16px;
  border-bottom: 2px solid #e5e7eb;
}

.admin-table tr:hover {
  background: #f9fafb;
}

.admin-table td:last-child {
  text-align: center;
}

/* Status indicators */
.status-approved {
  color: #16a34a;
  font-weight: 600;
  background: #f0fdf4;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid #bbf7d0;
  display: inline-block;
}

.status-rejected {
  color: #dc2626;
  font-weight: 600;
  background: #fef2f2;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid #fecaca;
  display: inline-block;
}

.status-pending {
  color: #d97706;
  font-weight: 600;
  background: #fffbeb;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid #fed7aa;
  display: inline-block;
}

/* Switch Buttons (segmented control) */
.auth-switch-buttons { 
  display: inline-flex; 
  gap: 2px; 
  padding: 3px; 
  background: #e5e7eb; 
  border-radius: 8px; 
  margin: 0 0 20px 0; /* Left side positioning */
  align-items: center; 
  border: 1px solid #d1d5db;
  width: fit-content;           /* prevent stretching */
  align-self: flex-start;       /* keep tight to left */
  white-space: nowrap;          /* keep buttons on one line */
}
.auth-switch-buttons.hidden { display: none; }

.switch-btn {
  padding: 8px 16px; 
  background: transparent;
  border: none;
  color: #6b7280;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: none;             /* keep hover the same */
  font-size: 13px;
  min-width: 80px;
  text-align: center;
}

.switch-btn:hover {
  background: transparent;      /* no hover background change */
  color: inherit;               /* no hover color change */
}

.switch-btn.active {
  background: #333333;
  color: #ffffff;
  box-shadow: none;
}

.switch-btn:focus { 
  outline: none; 
}

/* Fixed left admin bar inside auth overlay */
.admin-leftbar { 
  position: fixed; 
  top: 0; 
  left: 0; 
  height: 100vh; 
  width: 220px; 
  background: #f8fafc; 
  border-right: 1px solid #e5e7eb; 
  z-index: 10000; 
  padding: 20px 16px; 
  box-sizing: border-box;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.admin-leftbar .leftbar-footer {
  position: absolute;
  left: 16px;
  right: 16px;
  bottom: 16px;
}

.admin-leftbar .leftbar-title { 
  font-weight: 800; 
  color: #0f172a; 
  display: flex; 
  align-items: center; 
  gap: 10px; 
  margin-bottom: 20px; 
  font-size: 18px;
  padding: 12px 16px;
  background: #fff;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.admin-leftbar .leftbar-link { 
  display: flex; 
  align-items: center; 
  gap: 12px; 
  background: #fff; 
  border: 1px solid #e5e7eb; 
  border-radius: 8px; 
  padding: 12px 16px; 
  font-weight: 600; 
  color: #374151; 
  cursor: pointer; 
  margin-bottom: 12px;
  transition: all 0.2s ease;
  font-size: 14px;
}

.admin-leftbar .leftbar-link:hover { 
  background: #f1f5f9; 
  border-color: #d1d5db;
  transform: translateX(2px);
}
.auth-left .form-wrap { margin-left: 0; }
.admin-leftbar:not(.hidden) ~ .form-wrap { margin-left: 260px; }
.admin-content { position: fixed; top: 0; right: 0; left: 260px; bottom: 0; background: #ffffff; z-index: 9000; overflow: auto; padding: 24px; }
.admin-content.hidden { display: none; }
.admin-content .page-title { font-size: 22px; font-weight: 800; margin-bottom: 16px; }
.admin-content .page-subtitle { color:#6b7280; margin-bottom: 20px; }
.admin-content .admin-table table { width: 100%; border-collapse: collapse; }
.admin-content .admin-table th, .admin-content .admin-table td { border:1px solid #e5e7eb; padding:10px; text-align:left; }
.admin-content .admin-table th { background:#f8fafc; }
.signin-header { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e5e7eb;
}

.signin-title { 
  display: flex; 
  align-items: center; 
  gap: 12px; 
  font-size: 28px; 
  font-weight: 700; 
  color: #0f172a; 
}

.mini-note { font-size:11px; color:#6b7280; margin-top:6px; }
.admin-actions { display:flex; gap:8px; align-items:center; }

/* Approval and Rejection Buttons */
.cta-btn { 
  padding: 8px 16px; 
  background: #16a34a; 
  color: #fff; 
  border: none; 
  border-radius: 8px; 
  font-weight: 600; 
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s ease;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  min-width: 100px;
}

.cta-btn:hover {
  background: #15803d;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

.cta-btn.secondary { 
  background: #ef4444; 
  color: #fff;
}

.cta-btn.secondary:hover {
  background: #b91c1c;
}

.cta-btn:active {
  transform: translateY(0);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.cta-btn:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.3);
}

.cta-btn.secondary:focus {
  box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.3);
}

/* Document Assistant (Upload Summary) */
.assistant-title { 
  margin: 0 0 20px 0; 
  font-size: 18px; 
  display: flex; 
  align-items: center; 
  gap: 8px; 
}
.upload-grid { 
  width: 100%; 
  display: grid; 
  grid-template-columns: 1fr; /* make main column full width */ 
  gap: 16px; 
}
.dropzone { 
  border: 2px dashed #d1d5db; 
  background: #f9fafb; 
  border-radius: 6px; 
  padding: 20px; 
  text-align: center; 
  cursor: pointer; 
  margin-bottom: 16px;
}
.dropzones { 
  display: grid; 
  grid-template-columns: 1fr 1fr; /* half-half */
  gap: 20px; 
  margin-bottom: 16px; 
}
@media (max-width: 1000px){
  .dropzones { 
    grid-template-columns: 1fr; 
    margin-bottom: 20px;
  }
}
.dropzone:hover { 
  background: #f3f4f6; 
  border-color: #9ca3af; 
}
.dropzone.highlight {
  background: #f3f4f6;
  border-color: #9ca3af;
}
.dropzone i { 
  font-size: 24px; 
  color: #fbbf24; 
  margin-bottom: 8px; 
}
.help-text { 
  color: #6b7280; 
  font-size: 13px; 
  margin-top: 4px; 
}
.section-label { 
  display: inline-block; 
  margin-bottom: 12px; 
  color: #374151; 
  font-weight: 600; 
  font-size: 14px; 
}
.preview-card { 
  background: #fff; 
  border: 1px solid #eee; 
  border-radius: 12px; 
  min-height: 260px; 
  padding: 12px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  overflow: auto; 
}
.preview-card pre { 
  white-space: pre-wrap; 
  word-break: break-word; 
  font-size: 12px; 
  color: #222; 
}
.preview-card .placeholder { 
  color: #888; 
  font-size: 14px; 
}
.actions { 
  margin-top: 12px; 
  display: flex; 
  gap: 8px; 
}
.footer-actions {
  margin-top: 16px;
  display: flex;
  gap: 8px;
  align-items: center;
}
.input-text {
  flex: 1;
  min-width: 160px;
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  background: #ffffff;
}
.input-select {
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  background: #ffffff;
}
.right-actions { 
  display: flex; 
  gap: 8px; 
  align-items: center; 
  margin-top: 10px; 
}
.audio-section { 
  margin-top: 14px; 
}
/* Summary textarea */
.summary-section { margin-top: 12px; }
.summary-section label { 
  display: block; 
  font-size: 13px; 
  color: #555; 
  margin-bottom: 6px; 
  font-weight: 600; 
}
.summary-textarea { 
  width: 100%; 
    min-height: 420px; 
  resize: vertical; 
  border-radius: 8px; 
  border: 1px solid #ddd; 
  padding: 12px 14px; 
  font-size: 15px; 
  font-family: "Segoe UI", Arial, sans-serif;
  color: #222; 
  box-sizing: border-box; 
  line-height: 1.6; 
  white-space: pre-wrap; 
}

/* Formatted summary preview */
.summary-render {
  margin-top: 10px;
  padding: 14px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background: #fafafa;
  color: #111827;
  line-height: 1.7;
  font-size: 16px;
  max-height: 420px;
  overflow: auto;
}
.summary-render h1, .summary-render h2, .summary-render h3 {
  margin: 16px 0 8px;
  font-weight: 800;
}
.summary-render h1 { font-size: 24px; }
.summary-render h2 { font-size: 22px; }
.summary-render h3 { font-size: 20px; }
.summary-render p { margin: 8px 0; }
.summary-render ul, .summary-render ol { margin: 8px 0 8px 22px; }
.summary-render strong { font-weight: 700; }
.formatted-preview { margin-top: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; padding: 14px; }
.formatted-preview h4 { margin: 0 0 8px; color: #111827; }

.btn { 
  border: none; 
  padding: 10px 14px; 
  border-radius: 8px; 
  cursor: pointer; 
  font-weight: 600; 
  display: inline-flex; 
  align-items: center; 
  gap: 8px; 
}
.btn-primary { 
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%); 
  color: #fff; 
  border-radius: 8px;
  padding: 10px 16px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}
.btn-primary:hover { 
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); 
  transform: translateY(-1px);
}
.btn-secondary { 
  background: #f3f4f6;
  color: #374151; 
  border-radius: 8px;
  padding: 10px 16px;
  font-weight: 600;
  border: 1px solid #d1d5db;
  cursor: pointer;
  transition: all 0.2s ease;
}
.btn-secondary:hover { 
  background: #e5e7eb;
  border-color: #9ca3af;
}

.right-pane { 
  display: flex; 
  flex-direction: column; 
  min-height: calc(100vh - 140px); /* make preview tall */ 
  max-width: 100%;
  box-sizing: border-box;
}
.format-options { 
  display: flex; 
  align-items: center; 
  gap: 12px; 
  margin-bottom: 8px; 
}
.format-options .radio { 
  display: inline-flex; 
  align-items: center; 
  gap: 6px; 
  font-size: 13px; 
}

.input-area {
  display: flex;
  gap: 6px;
  align-items: center;
}
.input-area input {
  flex: 1;
  padding: 6px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-size: 12px;
}
.icon-button {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  border: none;
  color: white;
  padding: 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 34px;
  height: 34px;
  transition: all 0.2s ease;
}
.icon-button:hover {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  transform: translateY(-1px);
}
/* Upload section styling - removed duplicate */

/* Only inside PDF Auto Fill panel, show upload-section by default */
#pdfAutoFillPanel {
  position: relative;
}

#pdfAutoFillPanel .upload-section {
  background: #fff;
  border-radius: 12px;
  padding: 32px;
  flex: 1;
  display: flex !important;
  flex-direction: column;
  align-items: flex-start;
  justify-content: flex-start;
  border: 2px dashed #e5e7eb;
  color: #374151;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  margin-top: 24px;
}

/* When hidden class is applied, override all other display rules */
#pdfAutoFillPanel .upload-section.hidden {
  display: none !important;
}



.full-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  z-index: 9999;
  overflow: auto;
}

/* Main container */
.pdf-container {
  max-width: 600px;
  margin: 40px auto;
  background: #fff;
  padding: 32px;
  border-radius: 12px;
  box-shadow: 0 2px 16px rgba(0,0,0,0.05);
}

/* Hidden utility */
.hidden { 
  display: none !important; 
}

/* Prevent scrolling when review form is open */
body.review-open {
  overflow: hidden;
}

/* Review Popup Styling */
.review-popup {
  position: fixed;
  top: 0;
  left: 280px; /* Start after the fixed sidebar */
  width: calc(100% - 260px); /* Width excluding sidebar */
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
}

.review-popup-content {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: popupSlideIn 0.3s ease-out;
}

.review-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px;
  border-bottom: 1px solid #eee;
  background: #f8f9fa;
  border-radius: 12px 12px 0 0;
}

.review-popup-header h2 {
  margin: 0;
  color: #333;
  font-size: 24px;
  font-weight: 600;
}

.close-popup-btn {
  background: none;
  border: none;
  font-size: 20px;
  color: #666;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.2s ease;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-popup-btn:hover {
  background: #f0f0f0;
  color: #333;
}

#pdf-form {
  padding: 25px;
}

@keyframes popupSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Responsive design for review popup */
@media (max-width: 768px) {
  .review-popup {
    left: 0;
    width: 100%;
  }
  
  .review-popup-content {
    max-width: 95%;
    margin: 10px;
  }
}

/* Style for the Download PDF button */
.download-pdf-btn {
  background: linear-gradient(135deg, rgba(67, 233, 123, 0.4) 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(5, 146, 52, 0.4);
  text-decoration: none;
  display: inline-block;
  margin: 10px 0;
  width: auto;
  max-width: 200px;
}

.download-pdf-btn i {
  color: rgba(67, 233, 123, 0.4);
}

.download-pdf-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(67, 233, 123, 0.4);
}

.download-pdf-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
}

/* Headings */
.pdf-container h1 {
  text-align: center;
  color: #333;
  font-size: 28px;
  margin-bottom: 10px;
}

.description {
  text-align: center;
  color: #666;
  margin-bottom: 25px;
  font-size: 15px;
}

.file-input-group {
  margin-bottom: 28px;
  width: 100%;
}

.file-input-group label {
  display: block;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 12px;
  font-size: 15px;
}

.file-input-group input[type="file"] {
  width: 100%;
  padding: 16px;
  border: 2px dashed #d1d5db;
  background: #f9fafb;
  border-radius: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.file-input-group input[type="file"]:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.file-input-group small {
  display: block;
  margin-top: 8px;
  color: #6b7280;
  font-size: 13px;
  line-height: 1.4;
}

/* Buttons */
button[type="submit"], .success-message a {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  color: white;
  border: none;
  padding: 16px 32px;
  font-size: 16px;
  font-weight: 600;
  width: 100%;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  box-shadow: 0 4px 16px rgba(8, 106, 216, 0.25);
}

button[type="submit"]:hover {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(8, 106, 216, 0.35);
}

/* Success */
.success-message {
  text-align: center;
}

.success-message h2 {
  color: #28a745;
  margin-bottom: 15px;
}

.success-message a {
  display: inline-block;
  background: #28a745;
  padding: 12px 20px;
  border-radius: 6px;
}

.success-message a:hover {
  background: #218838;
}

/* Success section download button specific styling */
.success-message .download-pdf-btn {
  width: auto;
  max-width: 200px;
  margin: 10px auto;
  display: block;
}

/* Error */
.error-message {
  text-align: center;
}

.error-message p {
  color: #dc3545;
  font-weight: bold;
  font-size: 16px;
}

/* Review Section */
#review-section {
  background: #fefefe;
  padding: 25px;
  border-radius: 8px;
  border: 1px solid #ddd;
  margin-top: 0px;
  padding-left: 50px;
}

.form-field {
  margin-bottom: 20px;
}

.form-field label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: #444;
}

.form-field input[type="text"] {
  width: 100%;
  padding: 12px;
  border: 2px dashed #ccc;
  border-radius: 6px;
  background: #fafafa;
  font-size: 14px;
}
.hidden {
  display: none;
}

/* Drafting */
  #draftingPanel {
    background: #fff;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    max-width: 1000px;
    margin: 30px auto;
    font-family: Arial, sans-serif;
    position: relative;
  }

  #draftingPanel h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
  }

  /* Two-column layout */
  .drafting-container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
  }

  .section2 {
    margin: 0 0 12px 0;
    padding: 0;
    border: none;
    border-radius: 0;
    background: transparent;
  }

  .section2 h3 {
    margin-bottom: 8px;
    color: #444;
  }

  input[type="file"] {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fff;
    width: 100%;
    margin-bottom: 10px;
  }

  button {
    background: #4CAF50;
    color: #fff;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }

  button:hover {
    background: #45a049;
  }

  textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ddd;
    resize: vertical;
    font-size: 14px;
    min-height: 100px;
  }

  /* Drafting Results Popup Styling */
  .drafting-results-popup {
    position: absolute;
    inset: 0;
    margin: auto;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
  }

  .drafting-results-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: popupSlideIn 0.3s ease-out;
  }

  .drafting-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #eee;
    background: #f3f4f6; /* gray header */
    color: #111827;
    border-radius: 12px 12px 0 0;
  }

  .drafting-results-header h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .drafting-results-header h2 i {
    font-size: 28px;
    color: #ffd700;
  }

  .close-drafting-popup-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: #fff;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.2s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-drafting-popup-btn:hover {
    background: rgba(255,255,255,0.2);
    color: #fff;
    transform: scale(1.1);
  }

  .drafting-results-body {
    padding: 24px;
  }

  .drafting-result-item {
    margin-bottom: 32px;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
    transition: all 0.3s ease;
  }

  .drafting-result-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .result-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #667eea;
  }

  .result-header i {
    font-size: 24px;
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    padding: 8px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .result-header h3 {
    margin: 0;
    font-size: 20px;
    color: #333;
    font-weight: 600;
  }

  .drafting-result-item textarea {
    margin-bottom: 16px;
    border: 1px solid #ddd;
    background: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.5;
  }

  .drafting-result-item .download-pdf-btn {
    background: #f3f4f6; /* gray-100 */
    color: #111827; /* gray-900 */
    border: 1px solid #e5e7eb; /* gray-200 */
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    width: auto;
    max-width: 220px;
  }
  .drafting-result-item .download-pdf-btn i {
    background: #111827; /* dark icon chip */
    color: #ffffff;
    border-radius: 8px;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }
  .drafting-result-item .download-pdf-btn:hover {
    background: #e5e7eb;
  }

  /* Drafting Process Button Styling */
  .drafting-process-btn {
    background: linear-gradient(135deg, #fde047 0%, #f59e0b 100%); /* yellow gradient */
    color: #111827;
    border: 1px solid #f59e0b;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
    transition: none;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .drafting-process-btn:hover { filter: none; background: linear-gradient(135deg, #fde047 0%, #f59e0b 100%); }

  .drafting-process-btn:active {
    transform: translateY(0);
  }

/* Review Popup Styling - Duplicate removed */

.close-popup-btn {
  background: none;
  border: none;
  font-size: 20px;
  color: #666;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.2s ease;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-popup-btn:hover {
  background: #f0f0f0;
  color: #333;
}

#pdf-form {
  padding: 25px;
}

@keyframes popupSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Download PDF button styling - Duplicate removed */

/* Headings */
.pdf-container h1 {
  text-align: center;
  color: #333;
  font-size: 28px;
  margin-bottom: 10px;
}

.description {
  text-align: center;
  color: #666;
  margin-bottom: 25px;
  font-size: 15px;
}



.file-input-group {
  margin-bottom: 20px;
}

.file-input-group label {
  display: block;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

.file-input-group input[type="file"] {
  width: 100%;
  padding: 12px;
  border: 2px dashed #ccc;
  background: #fff;
  border-radius: 6px;
}

.file-input-group small {
  display: block;
  margin-top: 6px;
  color: #888;
  font-size: 13px;
}

/* Buttons */
button[type="submit"], .success-message a {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 12px 24px;
  font-size: 16px;
  width: 100%;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s ease;
  text-align: center;
}

button[type="submit"]:hover {
  background-color: #0056b3;
}

/* Success */
.success-message {
  text-align: center;
}

.success-message h2 {
  color: #28a745;
  margin-bottom: 15px;
}

.success-message a {
  display: inline-block;
  background: #28a745;
  padding: 12px 20px;
  border-radius: 6px;
}

.success-message a:hover {
  background: #218838;
}

/* Success section download button specific styling */
.success-message .download-pdf-btn {
  width: auto;
  max-width: 200px;
  margin: 10px auto;
  display: block;
}

/* Error */
.error-message {
  text-align: center;
}

.error-message p {
  color: #dc3545;
  font-weight: bold;
  font-size: 16px;
}


.form-field {
  margin-bottom: 20px;
}

.form-field label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: #444;
}

.form-field input[type="text"] {
  width: 100%;
  padding: 12px;
  border: 2px dashed #ccc;
  border-radius: 6px;
  background: #fafafa;
  font-size: 14px;
}
.hidden {
  display: none;
}

/* Drafting */
  #draftingPanel {
    background: #fff;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    max-width: 1000px;
    margin: 30px auto;
    font-family: Arial, sans-serif;
  }

  #draftingPanel h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
  }

  /* Two-column layout */
  .drafting-container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
  }

  .section2 {
    margin-bottom: 20px;
    padding: 16px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
  }

  .section2 h3 {
    margin-bottom: 8px;
    color: #444;
  }

  input[type="file"] {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fff;
    width: 100%;
    margin-bottom: 10px;
  }

  button {
    background: #4CAF50;
    color: #fff;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }

  button:hover {
    background: #45a049;
  }

  textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ddd;
    resize: vertical;
    font-size: 14px;
    min-height: 100px;
  }

/* Modal Box */
/* Modal Background */
.admin-modal {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(8px);
  /* Ensure modal is contained within its parent */
  overflow: hidden;
  /* Force modal to be contained within its positioned parent */
  position: absolute !important;
}
.admin-modal.hidden { display: none; }

/* Modal Box */
.admin-modal-content {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  padding: 32px;
  border-radius: 20px;
  width: 90%;
  max-width: 1200px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 25px 80px rgba(0,0,0,0.15);
  border: 1px solid rgba(255, 255, 255, 0.2);
  position: relative;
}

/* Title */
.admin-modal-content h2 {
  text-align: center;
  margin-bottom: 28px;
  font-size: 26px;
  font-weight: 700;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
}

.admin-modal-content h2::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 3px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 2px;
}



















/* Floating Chat Icon */
.floating-chat-icon {
  position: absolute;
  bottom: 30px;
  right: 30px;
  width: 70px;
  height: 70px;
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 8px 32px rgba(8, 106, 216, 0.35);
  transition: all 0.3s ease;
  z-index: 1000;
  border: 3px solid #ffffff;
}

.floating-chat-icon:hover {
  transform: scale(1.15) translateY(-5px);
  box-shadow: 0 12px 40px rgba(8, 106, 216, 0.55);
  border-color: #f0f0f0;
}

.floating-chat-icon:active {
  transform: scale(1.05) translateY(-2px);
}

.floating-chat-icon i {
  color: white;
  font-size: 28px;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

/* Chat Modal */
.chat-modal {
  position: absolute;
  top: 0;
  left: 20px; /* shift more to the right per request */
  width: calc(100% - 20px);
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

@media (max-width: 900px) {
  .chat-modal { left: 0; width: 100%; }
}

.chat-modal.hidden {
  display: none;
}

.chat-modal-content {
  background: white;
  width: 90%;
  max-width: 800px;
  height: 80vh;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.chat-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 24px 28px;
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  border-bottom: 1px solid #e5e7eb;
  border-radius: 16px 16px 0 0;
}

.chat-modal-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 22px;
  font-weight: 700;
  color: #ffffff;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.chat-modal-title i {
  color: #ffffff;
  font-size: 26px;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

.chat-modal-actions {
  display: flex;
  gap: 8px;
}

.chat-action-btn {
  background: #ffffff;
  border: 2px solid #e5e7eb;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  color: #374151;
  transition: all 0.3s ease;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.chat-action-btn:hover {
  background: #2563eb;
  color: #ffffff;
  border-color: #2563eb;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.chat-action-btn:active {
  transform: translateY(0);
}

.chat-modal-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-history-panel {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-bottom: 1px solid #e5e7eb;
  padding: 20px;
  max-height: 200px;
  overflow-y: auto;
  border-radius: 0 0 16px 16px;
}

.chat-history-panel h4 {
  margin: 0 0 16px 0;
  color: #1e293b;
  font-size: 18px;
  font-weight: 700;
  text-align: center;
}

.chat-messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #fff;
}

.chat-messages-container .chat-welcome {
  text-align: center;
  color: #6b7280;
  padding: 60px 20px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 20px;
  margin: 20px;
  border: 2px dashed #cbd5e1;
}

.chat-messages-container .chat-welcome h3 {
  margin: 0 0 12px 0;
  color: #1e293b;
  font-size: 24px;
  font-weight: 700;
}

.chat-messages-container .chat-welcome p {
  margin: 0;
  font-size: 16px;
  line-height: 1.6;
}

.chat-input-container {
  padding: 24px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-top: 1px solid #e5e7eb;
  border-radius: 0 0 20px 20px;
}

.chat-input-area {
  display: flex;
  gap: 8px;
  align-items: center;
}

.chat-input-area input {
  flex: 1;
  padding: 14px 18px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 15px;
  background: white;
  transition: all 0.3s ease;
}

.chat-input-area input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  transform: translateY(-1px);
}

.chat-send-btn, .chat-voice-btn {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  border: none;
  color: white;
  padding: 12px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(8, 106, 216, 0.3);
}

.chat-send-btn:hover, .chat-voice-btn:hover {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(8, 106, 216, 0.4);
}

.chat-send-btn:active, .chat-voice-btn:active {
  transform: translateY(0);
}

/* Modal Chat Messages */
.chat-messages-container .message {
  background-color: #f8fafc;
  padding: 16px 20px;
  border-radius: 16px;
  margin-bottom: 16px;
  font-size: 15px;
  max-width: 75%;
  line-height: 1.5;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #e5e7eb;
}

.chat-messages-container .message.agent {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1px solid #e2e8f0;
  align-self: flex-start;
  border-left: 4px solid #086ad8;
}

.chat-messages-container .message.user {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  color: white;
  align-self: flex-end;
  margin-left: auto;
  border: 1px solid #1e40af;
  border-right: 4px solid #1e40af;
}

/* Update main layout to remove first sidebar */
.main {
  margin-left: 260px !important;
  width: calc(100% - 260px);
  min-height: 100vh;
  overflow-x: hidden;
  box-sizing: border-box;
}

/* Ensure all panels within main container respect boundaries */
.main > div {
  max-width: 100%;
  box-sizing: border-box;
  overflow-x: auto;
}

.second-sidebar {
  width: 260px;
  background-color: #E4E4E7;
  border-right: 1px solid #e5e7eb;
  display: flex;
  flex-direction: column;
  padding: 10px;
  color: #000;
  overflow: hidden;
  transition: width 0.25s ease, padding 0.25s ease;
  position: fixed;
  left: 0;
  top: 0;
  height: 100vh;
  z-index: 100;
}

/* Simple & Compact Form Styling */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  padding: 16px 0;
  max-width: 100%;
  box-sizing: border-box;
}

/* Responsive form layout */
@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
    gap: 16px;
    padding: 16px 0;
  }
  
  .form-group.full-width {
    grid-column: span 1;
  }
}

.form-group {
  display: flex;
  flex-direction: column;
  width: 100%;
  margin-bottom: 16px;
}

.form-group.full-width {
  grid-column: span 2;
}

/* Form section dividers */
.form-section {
  grid-column: span 2;
  border-top: 1px solid #e5e7eb;
  margin-top: 24px;
  padding-top: 16px;
}

.form-section-title {
  font-size: 14px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 16px;
}

/* Simple Labels */
.form-group label {
  font-weight: 500;
  margin-bottom: 6px;
  color: #374151;
  font-size: 14px;
  display: block;
}

/* Simple Inputs */
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: #ffffff;
  font-size: 14px;
  font-family: inherit;
  line-height: 1.4;
  box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  border-color: #3b82f6;
  outline: none;
}

/* Required field indicators */
.form-group input[required],
.form-group select[required],
.form-group textarea[required] {
  border-left: 2px solid #3b82f6;
  padding-left: 12px;
}

/* Error and success states */
.form-group input:invalid,
.form-group select:invalid,
.form-group textarea:invalid {
  border-color: #ef4444;
}

.form-group input:valid,
.form-group select:valid,
.form-group textarea:valid {
  border-color: #10b981;
}

/* Textarea specific */
textarea {
  min-height: 80px;
  resize: vertical;
}

.form-textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  resize: vertical;
  min-height: 100px;
  background-color: #f9fafb;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.4;
}

/* Simple Panel Header */
.panel-header {
  margin-bottom: 20px;
  padding: 16px 0;
  border-bottom: 1px solid #e5e7eb;
}

.panel-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel-header .description {
  margin: 8px 0 0 0;
  color: #6b7280;
  font-size: 14px;
  line-height: 1.5;
}

/* Simple validation styling */
.form-group input:invalid,
.form-group select:invalid,
.form-group textarea:invalid {
  border-color: #ef4444;
}

.form-group input:valid,
.form-group select:valid,
.form-group textarea:valid {
  border-color: #10b981;
}

/* Simple error and success messages */
.form-group .error-message {
  color: #ef4444;
  font-size: 12px;
  margin-top: 4px;
}

.form-group .success-message {
  color: #10b981;
  font-size: 12px;
  margin-top: 4px;
}

/* Simple file upload design to match the image */
.simple-file-upload {
  position: relative;
  border: 2px dashed #d1d5db;
  background: #f9fafb;
  border-radius: 6px;
  padding: 10px 14px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  min-height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  box-sizing: border-box;
}

.simple-file-upload:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.simple-file-upload input[type="file"] {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
  z-index: 2;
}

.file-upload-placeholder {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
  pointer-events: none;
}

.file-upload-placeholder i {
  font-size: 16px;
  color: #9ca3af;
}

.file-upload-placeholder span {
  color: #3b82f6;
  font-weight: 500;
  font-size: 14px;
}

.file-upload-placeholder small {
  color: #6b7280;
  font-size: 13px;
}

.file-upload-placeholder em {
  color: #9ca3af;
  font-size: 12px;
  font-style: italic;
}

/* Form completion feedback */
.form-completed {
  border: 2px solid #10b981 !important;
  background: #f0fdf4 !important;
  animation: successPulse 0.5s ease-in-out;
}

@keyframes successPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.01); }
  100% { transform: scale(1); }
}

/* Enhanced Select styling */
.form-group select {
  cursor: pointer;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
  appearance: none;
}

/* Enhanced File input styling - More Compact */
.form-group input[type="file"] {
  padding: 12px 14px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 2px dashed #cbd5e1;
  cursor: pointer;
  text-align: center;
  transition: all 0.3s ease;
  font-weight: 500;
  color: #6b7280;
}

.form-group input[type="file"]:hover {
  border-color: #667eea;
  background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
  color: #374151;
}

.form-group input[type="file"]:focus {
  border-color: #667eea;
  background: #ffffff;
  color: #374151;
}

/* Enhanced Required field styling */
.form-group input[required] + label::after,
.form-group select[required] + label::after,
.form-group textarea[required] + label::after {
  content: ' *';
  color: #ef4444;
  font-weight: 700;
}

/* Better accessibility */
.form-group input:focus-visible,
.form-group select:focus-visible,
.form-group textarea:focus-visible {
  outline: 2px solid #667eea;
  outline-offset: 2px;
}

/* Form loading state */
.form-group.loading input,
.form-group.loading select,
.form-group.loading textarea {
  opacity: 0.7;
  pointer-events: none;
}

/* Form submission feedback */
.form-submitting {
  position: relative;
  pointer-events: none;
}

.form-submitting::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  z-index: 1;
}

.form-submitting::before {
  content: 'Saving...';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #667eea;
  font-weight: 600;
  z-index: 2;
}

/* Simple Modal Actions - Matching Sign In/Sign Up button design */
.modal-actions {
  grid-column: span 2;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 16px;
  margin-top: 32px;
  padding-top: 20px;
  border-top: 2px solid #e5e7eb;
  flex-wrap: wrap;
}

.modal-actions .btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  width: 140px;
  height: 48px;
  justify-content: center;
}

.modal-actions .btn-primary {
  background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%);
  color: #ffffff;
  box-shadow: 0 2px 8px rgba(8, 106, 216, 0.2);
}

.modal-actions .btn-primary:hover {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  box-shadow: 0 4px 12px rgba(8, 106, 216, 0.3);
  transform: translateY(-1px);
}

.modal-actions .btn-secondary {
  background: #f3f4f6;
  color: #374151;
  border: 1px solid #d1d5db;
}

.modal-actions .btn-secondary:hover {
  background: #e5e7eb;
  border-color: #9ca3af;
  transform: translateY(-1px);
}

/* Responsive design for mobile */
@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
    gap: 18px;
  }
  
  .form-group.full-width {
    grid-column: span 1;
  }
  
  .admin-modal-content {
    padding: 20px;
    margin: 16px;
    width: calc(100% - 20px);
  }
  
  .modal-actions {
    flex-direction: column;
    gap: 12px;
  }
  
  .modal-actions button {
    width: 100%;
  }
}

/* Form Animation and Visual Enhancements */
@keyframes formSlideIn {
  from {
    opacity: 0;
    transform: translateY(16px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes formFieldFocus {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.01);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes buttonPulse {
  0% {
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
  }
  50% {
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  100% {
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
  }
}

/* Form Container Animation */
.admin-modal-content {
  animation: formSlideIn 0.3s ease-out;
}

/* Form Group Animations */
.form-group {
  animation: formSlideIn 0.3s ease-out;
  animation-fill-mode: both;
}

.form-group:nth-child(1) { animation-delay: 0.05s; }
.form-group:nth-child(2) { animation-delay: 0.1s; }
.form-group:nth-child(3) { animation-delay: 0.15s; }
.form-group:nth-child(4) { animation-delay: 0.2s; }
.form-group:nth-child(5) { animation-delay: 0.25s; }
.form-group:nth-child(6) { animation-delay: 0.3s; }
.form-group:nth-child(7) { animation-delay: 0.35s; }
.form-group:nth-child(8) { animation-delay: 0.4s; }
.form-group:nth-child(9) { animation-delay: 0.45s; }
.form-group:nth-child(10) { animation-delay: 0.5s; }
.form-group:nth-child(11) { animation-delay: 0.55s; }
.form-group:nth-child(12) { animation-delay: 0.6s; }

/* Enhanced Input Focus Animation */
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  animation: formFieldFocus 0.2s ease-out;
}

/* Enhanced Button Animations */
.modal-actions button {
  animation: formSlideIn 0.4s ease-out;
  animation-fill-mode: both;
}

.modal-actions button:nth-child(1) { animation-delay: 0.5s; }
.modal-actions button:nth-child(2) { animation-delay: 0.55s; }

/* Enhanced Hover Effects */
.form-group:hover label {
  color: #000000;
  transform: translateX(1px);
  transition: all 0.3s ease;
}

/* Enhanced File Input Styling */
.form-group input[type="file"]::before {
  content: '📁 Choose File';
  display: block;
  text-align: center;
  font-weight: 600;
  color: #667eea;
  margin-bottom: 6px;
}

.form-group input[type="file"]::-webkit-file-upload-button {
  visibility: hidden;
  width: 0;
}

.form-group input[type="file"]::after {
  content: 'or drag and drop';
  display: block;
  text-align: center;
  font-size: 11px;
  color: #9ca3af;
  font-style: italic;
}

/* Enhanced Select Dropdown Styling */
.form-group select option {
  padding: 10px;
  background: #ffffff;
  color: #374151;
  font-size: 13px;
}

.form-group select option:hover {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

/* Enhanced Required Field Indicators */
.form-group input[required],
.form-group select[required],
.form-group textarea[required] {
  border-left: 3px solid #667eea;
  padding-left: 16px;
}

/* Enhanced Form Validation Visual Feedback */
.form-group input:invalid:not(:placeholder-shown),
.form-group select:invalid:not(:placeholder-shown),
.form-group textarea:invalid:not(:placeholder-shown) {
  border-color: #ef4444;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.form-group input:valid:not(:placeholder-shown),
.form-group select:valid:not(:placeholder-shown),
.form-group textarea:valid:not(:placeholder-shown) {
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

/* Enhanced Modal Title Animation */
.admin-modal-content h2 {
  animation: formSlideIn 0.2s ease-out;
}

.admin-modal-content h2::after {
  animation: formSlideIn 0.4s ease-out;
  animation-fill-mode: both;
}

/* Professional Form Header Design */
.admin-modal-content h2 {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 24px;
  font-weight: 800;
  text-align: center;
  margin-bottom: 24px;
  padding: 16px 0;
  position: relative;
  letter-spacing: 0.5px;
}

.admin-modal-content h2::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 2px;
}

.admin-modal-content h2::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 120px;
  height: 2px;
  background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
  border-radius: 1px;
}

/* Form Header Icon */
.admin-modal-content h2 i {
  margin-right: 12px;
  font-size: 28px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Form Section Headers */
.form-section-title {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  padding: 12px 16px;
  border-radius: 8px;
  border-left: 4px solid #667eea;
  margin: 20px 0 16px 0;
  font-size: 16px;
  font-weight: 700;
  color: #374151;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.form-section-title::before {
  content: '';
  width: 6px;
  height: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 3px;
}

.form-section-title i {
  color: #667eea;
  font-size: 18px;
}

/* Enhanced Button Loading State */
.modal-actions button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  animation: buttonPulse 1.5s infinite;
}

/* Enhanced Form Grid Responsiveness */
@media (max-width: 1024px) {
  .form-grid {
    grid-template-columns: 1fr 1fr;
    gap: 18px 22px;
  }
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .form-group:nth-child(n) {
    animation-delay: 0.05s !important;
  }
  
  .modal-actions button:nth-child(n) {
    animation-delay: 0.1s !important;
  }
}

/* Enhanced Accessibility */
.form-group input:focus-visible,
.form-group select:focus-visible,
.form-group textarea:focus-visible {
  outline: 2px solid #667eea;
  outline-offset: 2px;
}

/* Enhanced Form Field Spacing */
.form-group + .form-group {
  margin-top: 0;
}

/* Ensure proper form field separation */
.form-group {
  margin-bottom: 0;
  position: relative;
  z-index: 1;
}

.form-group:not(:last-child) {
  margin-bottom: 0;
}

/* Simple form layout */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  padding: 16px 0;
}

.form-section {
  margin-top: 24px;
  padding-top: 16px;
}

/* Simple panel header styling */
.panel-header {
  margin-bottom: 20px;
  padding: 16px 0;
  border-bottom: 1px solid #e5e7eb;
}

.panel-header h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 700;
  color: #1f2937;
  display: flex;
  align-items: center;
  gap: 12px;
}

.panel-header .description {
  margin: 0;
  color: #6b7280;
  font-size: 14px;
  line-height: 1.5;
}

/* Simple form styling */
.form-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 16px;
}

.admin-modal-content {
  max-width: 800px;
  width: 90%;
  margin: 0 auto;
}

/* Enhanced Modal Content Scrolling */
.admin-modal-content {
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 #f1f5f9;
}

.admin-modal-content::-webkit-scrollbar {
  width: 6px;
}

.admin-modal-content::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

.admin-modal-content::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 3px;
}

.admin-modal-content::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

/* Modal Header Design - Matching the second image */
.modal-header {
  background: #ffffff;
  border-radius: 8px;
  padding: 20px;
  margin: -20px -20px 20px -20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  border-bottom: 1px solid #e5e7eb;
}

.header-content {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}

.header-left {
  position: absolute;
  left: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-left i {
  font-size: 24px;
  color: #8064d8;
}

.header-left span {
  font-size: 18px;
  font-weight: 700;
  color: #1f2937;
}

.header-right {
  text-align: center;
  margin-left: 20px;
}

.header-right h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: #374151;
}

/* Panel header button positioning */
.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 20px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  border: 1px solid #e5e7eb;
}

/* Special styling for Audio Upload panel header (title only) */
#voiceAssistant .panel-header {
  justify-content: center;
  order: -1;
}

#voiceAssistant {
  flex-direction: column;
}

/* Special styling for PDF Auto Fill panel header (title only) */
#pdfAutoFillPanel .panel-header {
  justify-content: center;
  order: -1;
}

#pdfAutoFillPanel {
  flex-direction: column;
}

.panel-header h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 700;
  color: #1f2937;
  display: flex;
  align-items: center;
  gap: 12px;
}

.panel-header .btn {
  margin-left: -30px;
}

/* Simple Modal Content */
.admin-modal-content {
  padding: 20px;
  max-height: 80vh;
  border-radius: 12px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.admin-modal-content h2 {
  font-size: 20px;
  margin-bottom: 20px;
  color: #667eea;
  text-align: center;
  position: relative;
  padding-bottom: 12px;
}

.admin-modal-content h2::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 2px;
  background: #667eea;
  border-radius: 1px;
}

/* Simple Modal Actions - Removed duplicate rules */

/* Compact Error Messages */
.form-group .error-message {
  font-size: 10px;
  margin-top: 2px;
}

/* Compact Success Messages */
.form-group .success-message {
  font-size: 10px;
  margin-top: 2px;
}

/* Welcome Screen */
.welcome-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 20px; }
.welcome-card { width: 100%; max-width: 1200px; background: #ffffff; border-radius: 16px; box-shadow: none; padding: 24px 28px; display: grid; grid-template-columns: 200px 1fr; gap: 24px; align-items: start; min-height: 560px; }
.welcome-left { display: flex; align-items: flex-start; justify-content: center; }
.welcome-left img { width: 160px; max-width: 100%; height: auto; display: block; object-fit: contain; }
.welcome-left i { font-size: 72px; background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.welcome-icon { display: flex; align-items: center; justify-content: center; width: 160px; height: 160px; background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%); border-radius: 20px; border: 2px solid #e5e7eb; }
.welcome-icon i { font-size: 80px; background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.welcome-right { display: flex; flex-direction: column; justify-content: flex-start; }
.welcome-banner { background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px 28px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 24px; }
.welcome-right h1 { margin: 0 0 6px 0; text-align: left; font-size: 28px; font-weight: 800; color: #111827; }
.welcome-right p { margin: 0; color: #6b7280; }
.welcome-banner p { text-align: left; font-size: 16px; line-height: 1.5; }
/* right-bottom content box */
.welcome-box { margin: 20px 0 0 -65px; width: 100%; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e5e7eb; border-radius: 16px; padding: 28px 32px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); display: flex; flex-direction: column; min-height: 320px; }
.welcome-features { display:none; }
.welcome-inputs { margin: 12px 0 0 0; display: grid; grid-template-columns: 1fr 1fr; gap: 16px 18px; width: 100%; }
.input-row { display: flex; align-items: center; justify-content: space-between; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); width: 90%; min-height: 70px; cursor: pointer; transition: all 0.3s ease; overflow: hidden; }
.input-row span { color: #374151; font-weight: 600; font-size: 14px; line-height: 1.3; text-align: left; flex: 1; margin-right: 16px; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; }
.input-row i { color: #6b7280; font-size: 16px; transition: all 0.3s ease; }
.input-row:hover { background: #f8fafc; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.input-row:hover i { color: #2563eb; transform: translateX(4px); }

/* Dark theme for welcome */
body.theme-dark .welcome-card { background: #19191D; box-shadow: none; }
body.theme-dark .welcome-right h1 { color: #ffffff; }
body.theme-dark .welcome-right p { color: #e5e7eb; }
body.theme-dark .welcome-box { background: #19191D; border-color: #2A2A30; box-shadow: none; }
body.theme-dark .input-row { background: #19191D; border-color: #2A2A30; box-shadow: none; }
body.theme-dark .input-row span { color: #e5e7eb; }

@media (max-width: 800px) {
  .welcome-card { grid-template-columns: 1fr; padding: 20px; }
  .welcome-left { justify-content: center; margin-bottom: 20px; }
  .welcome-inputs { grid-template-columns: 1fr; }
  .welcome-box { padding: 20px; }
  .welcome-banner { padding: 20px; }
}

</style>
</head>
<body>


  <div id="secondSidebar" class="second-sidebar">
    <!-- <button class="toggle-second" id="toggleSecondBtn" title="Hide/Show">⟨⟩</button> -->

    <!-- Sidebar Header with Title and Icon -->
    <div class="sidebar-header">
      <div class="sidebar-header-icon">
        <i class="fa-solid fa-scale-balanced"></i>
      </div>
      <div class="sidebar-header-title">Legal AI</div>
    </div>

    <!-- Main Navigation Items -->
  <div class="doc-item" onclick="setSecondActive(this); openCustomerPanel()">
    <span>Customer</span>
    <div class="doc-icon"><i class="fa-solid fa-user"></i></div>
  </div>

  <div class="doc-item" onclick="setSecondActive(this); openCasePanel()">
    <span>Case</span>
    <div class="doc-icon"><i class="fa-solid fa-briefcase"></i></div>
  </div>

    <div class="doc-item" onclick="setSecondActive(this); showUploadUI()" style="display: none;">
      <span>Document Upload</span>
      <div class="doc-icon"><i class="fa-solid fa-file-alt"></i></div>
    </div>

    <div class="doc-item" onclick="setSecondActive(this); openVoiceScreen()">
      <span>Audio Upload</span>
      <div class="doc-icon"><i class="fa-solid fa-microphone"></i></div>
    </div>

    <div class="doc-item" onclick="setSecondActive(this); showPdfAutoFillPanel()">
      <span>PDF Auto Fill Form</span>
      <div class="doc-icon"><i class="fa-solid fa-file-signature"></i></div>
    </div>

    <div class="doc-item" onclick="setSecondActive(this); showDraftingPanel()">
      <span>Document Drafting</span>
      <div class="doc-icon"><i class="fa-solid fa-pen-to-square"></i></div>
    </div>

  <!-- Bottom Icons -->
  <div class="nav-bottom">
    <a href="#" data-nav="settings" onclick="openSettingsModal(); setPrimaryActive(this)">
      <span>Settings</span>
      <i class="fa-solid fa-gear"></i>
    </a>
    <a href="#" data-nav="logout" onclick="handleLogout(); setPrimaryActive(this)">
      <span>Logout</span>
      <i class="fa-solid fa-right-from-bracket"></i>
    </a>
  </div>
  <!-- Logged-in user profile (removed on request) -->
  </div>

  <div class="main">
    <!-- Welcome full-screen container -->
    <div id="welcomeScreen" class="welcome-overlay" style="display:flex;">
      <div class="welcome-card">
        <div class="welcome-left">
         
        </div>
        <div class="welcome-right">
          <div class="welcome-banner">
            <h1>Welcome to Legal AI</h1>
            <p>Your AI‑powered workspace for cases, customers, documents, and more. Pick a task below to get started.</p>
          </div>
          <div class="welcome-box">
            <div class="welcome-inputs">
              <div class="input-row"><span>Cases — Track type, document, due date, court</span><i class="fa-solid fa-arrow-right"></i></div>
              <div class="input-row"><span>Customers — Manage client information</span><i class="fa-solid fa-arrow-right"></i></div>
              <div class="input-row"><span>PDF Auto Fill — Upload, auto-generate PDFs</span><i class="fa-solid fa-arrow-right"></i></div>
              <div class="input-row"><span>Document Drafting — Create drafts with AI</span><i class="fa-solid fa-arrow-right"></i></div>
              <div class="input-row"><span>AI Chat — Get instant answers and help</span><i class="fa-solid fa-arrow-right"></i></div>
            </div>
            <p style="margin-top:16px; color:#6b7280; font-size:14px; text-align:center; font-style:italic;">Use the left navigation to begin.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-panel" id="chatPanel" style="display:none;">
      <div class="chat-header" style="padding:8px 10px; border-bottom:1px solid #e5e7eb; margin-bottom:8px; display:flex; align-items:center; gap:8px; background: linear-gradient(135deg, #086ad8 0%, #1e40af 100%); border-radius: 8px; margin: 8px;">
        <i class="fa-solid fa-robot" style="color:#ffffff; font-size:22px;"></i>
        <div class="chat-header-title" style="color: #ffffff; font-weight: 600;">AI Assistant</div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="input-area">
        <input type="text" id="chatInput" placeholder="Type your message..." onkeydown="if(event.key==='Enter'){event.preventDefault(); sendMessage();}">
        <button class="icon-button" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
        <button class="icon-button" onclick="startVoiceToAgent()"><i class="fa-solid fa-microphone"></i></button>
      </div>
      <div class="chat-footer-note">free AI chat assistant — this product is developed by Scalable Solutions</div>
    </div>

    <div id="documentAssistant" class="chat-panel" style="display:none">
      <div class="panel-header">
        <h3><i class="fa-solid fa-file-lines"></i> AI Document Assistant</h3>
      </div>
      <div class="upload-grid">
        <div>
          <div class="dropzones">
            <div id="dropzoneDoc" class="dropzone">
              <i class="fa-solid fa-file-arrow-up"></i>
              <div><strong>Upload Document</strong></div>
              <div class="help-text">.txt, .docx, .pdf, .jpg, .png</div>
              <input id="fileInputDoc" type="file" multiple accept=".txt,.doc,.docx,.pdf,.jpg,.jpeg,.png" style="display:none" />
            </div>
            <div id="dropzoneCase" class="dropzone">
              <i class="fa-solid fa-briefcase"></i>
              <div><strong>Upload Cases</strong></div>
              <div class="help-text">.txt, .docx, .pdf, .jpg, .png</div>
              <input id="fileInputCase" type="file" multiple accept=".txt,.doc,.docx,.pdf,.jpg,.jpeg,.png" style="display:none" />
            </div>
            <div id="docFileName" class="file-name">Document: —</div>
            <div id="caseFileName" class="file-name">Case: —</div>
          </div>
          <div class="actions">
            <button id="submitBtn" class="btn btn-primary hidden"><i class="fa-solid fa-paper-plane"></i> Submit & Analyze</button>
            <button id="testModalBtn" class="btn btn-secondary" onclick="testModal()" style="margin-left: 10px;"><i class="fa-solid fa-chart-line"></i> Test Analysis Modal</button>
          </div>
          <div class="summary-section">
            <label for="docPreviewText">Document Preview (for Agent)</label>
            <textarea id="docPreviewText" class="summary-textarea" placeholder="Document preview will be saved here for AI agent to answer questions..."></textarea>
          </div>
          
          <div class="summary-section">
            <label for="docSummaryText">Analysis Results</label>
            <textarea id="docSummaryText" class="summary-textarea" placeholder="Summary, missing clauses, risks, and suggestions will appear here after Submit & Analyze..."></textarea>
          </div>
          
          <div id="leftActions" class="footer-actions hidden">
            <select id="formatSelect" class="input-select">
              <option value="txt">.txt</option>
              <option value="pdf">.pdf</option>
              <option value="docx">.docx</option>
            </select>
            <button id="downloadBtn" class="btn btn-secondary"><i class="fa-solid fa-download"></i> Download</button>
      </div>
        </div>
  <!-- <div class="right-pane" style="display:none;"></div> -->
    <div class="right-pane" style="display: none;">
          <span class="section-label">Document Preview</span>
          <div id="preview" class="preview-card">
            <div class="placeholder">Preview will appear here...</div>
          </div>
        </div>

      </div>
    </div>
  
    <div id="voiceAssistant" class="chat-panel" style="display:none; position:relative;">
      <div class="panel-header">
        <h3><i class="fa-solid fa-microphone"></i> AI Audio Assistant</h3>
      </div>
      <div class="upload-grid">
        <div>
          <div class="dropzone" id="voiceDropzone" style="margin-bottom:12px;">
            <i class="fa-solid fa-microphone"></i>
            <div><strong>Audio Upload</strong></div>
            <div class="help-text">.mp3, .wav, .m4a, .ogg</div>
            <input id="voiceFileInput" type="file" accept=".mp3,.wav,.m4a,.ogg" style="display:none" />
          </div>
      <div class="actions">
        <button id="voiceSummaryBtn" class="btn btn-primary hidden"><i class="fa-solid fa-align-left"></i> Generate Summary</button>
      </div>
      <div class="summary-section">
        <label for="voiceSummaryText">Summary</label>
        <textarea id="voiceSummaryText" class="summary-textarea" placeholder="Summary will appear here after Generate Summary..."></textarea>
        <div class="footer-actions" id="voiceActions" style="margin-top:8px; display:none;">
          <select id="voiceFormatSelect" class="input-select">
            <option value="txt">.txt</option>
            <option value="pdf">.pdf</option>
            <option value="docx">.docx</option>
          </select>
          <button id="voiceDownloadBtn" class="btn btn-secondary"><i class="fa-solid fa-download"></i> Download</button>
        </div>
      </div>
        </div>
    <div class="right-pane" style="display:none"></div>
      </div>
    </div>

<!-- PDF Auto Fill Container -->
<div id="pdfAutoFillPanel" class="chat-panel pdf-container" style="display:none">
  <div class="panel-header">
    <h3><i class="fa-solid fa-file-signature"></i> PDF Auto Fill AI</h3>
    <p class="description" style="margin: 0; color: #6b7280; font-size: 14px;">
    </p>
  </div>

  <!-- Upload Form -->
  <div id="upload-section" class="upload-section">
    <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 700; color: #1f2937; text-align: center;">Upload Files</h2>
    <form id="upload-form" enctype="multipart/form-data" style="width: 100%; max-width: 500px; margin: 0 auto;">
      <div class="file-input-group">
        <label>Form Template (PDF/DOCX):</label>
        <input type="file" name="template_file" accept=".pdf,.docx" required>
        <small>Upload template with fields like <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">{{name}}</code>, <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">{{dob}}</code></small>
      </div>

      <div class="file-input-group">
        <label>Client Document (PDF/DOCX):</label>
        <input type="file" name="client_file" accept=".pdf,.docx" required>
        <small>Document containing client information.</small>
      </div>

      <button type="submit">Process Documents</button>
    </form>
  </div>

  <!-- Review Section -->
  <div id="review-section" class="hidden review-popup">
    <div class="review-popup-content">
      <div class="review-popup-header">
        <h2>Review & Generate PDF</h2>
        <button type="button" class="close-popup-btn" onclick="showUploadForm()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    <form id="pdf-form">
      <input type="hidden" name="template_path" id="template_path">
      <div id="fields-container">
        <p>No data available. Please process documents first.</p>
      </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="button" onclick="showUploadForm()" style="background-color: #6c757d;">Back to Upload</button>
          <button type="submit" style="flex: 1;">Generate PDF</button>
        </div>
    </form>
    </div>
  </div>

  <!-- Success -->
  <div id="success-section" class="hidden success-message">
    <h2>✅ PDF Generated Successfully</h2>
    <a href="/download-pdf" download class="download-pdf-btn">Download PDF</a>
  </div>

  <!-- Error -->
  <div id="error-section" class="hidden error-message">
    <p id="error-message">Something went wrong. Please try again.</p>
  </div>
 </div>



<div id="draftingPanel"  class="chat-panel" style="display: none; padding-top:8px;">
  <div class="panel-header">
    <h3><i class="fa-solid fa-pen-to-square"></i> Document Drafting</h3>
  </div>

  <!-- Upload Section -->
  <div class="section2" style="margin-top:0;">
    <div class="dropzone" onclick="document.getElementById('draftingFile').click()" style="border:2px dashed #e5e7eb; background:#fff; border-radius:12px; padding:24px; text-align:center; cursor:pointer;">
      <i class="fa-solid fa-file-arrow-up" style="font-size:28px; color:orange;"></i>
      <div style="font-weight:700; margin-top:6px;">Upload Document</div>
      <div style="color:#777; font-size:12px;">.txt, .docx, .pdf, .jpg, .png</div>
      <input type="file" id="draftingFile" accept=".pdf,.docx,.txt,.jpg,.jpeg,.png" style="display:none;" />
    </div>
    <div id="draftingSelectedName" style="margin-top:6px; color:#374151; font-size:13px; display:none;"></div>
    <div style="margin-top:12px;">
      <button onclick="uploadFile()" class="drafting-process-btn">Generate Draft</button>
    </div>
  </div>

  <!-- Drafting Results (Hidden initially) -->
  <div id="draftingResults" class="drafting-results-popup" style="display:none;">
    <div class="drafting-results-content">
      <div class="drafting-results-header">
        <h2><i class="fas fa-file-alt"></i> Document Drafting Results</h2>
        <button type="button" class="close-drafting-popup-btn" onclick="closeDraftingResults()">
          <i class="fas fa-times"></i>
        </button>
    </div>

      <div class="drafting-results-body">
        <div class="drafting-result-item">
          <div class="result-header">
            <i class="fas fa-envelope"></i>
            <h3>Cover Letter</h3>
          </div>
          <textarea id="coverLetter" rows="6" placeholder="Cover letter content will appear here..."></textarea>
          <button onclick="downloadPDF('Cover Letter', document.getElementById('coverLetter').value)" class="download-pdf-btn">
            <i class="fas fa-download"></i> Download PDF
          </button>
    </div>

        <div class="drafting-result-item">
          <div class="result-header">
            <i class="fas fa-list-alt"></i>
            <h3>Form Data</h3>
    </div>
          <textarea id="formData" rows="6" placeholder="Form data will appear here..."></textarea>
          <button onclick="downloadPDF('Form Data', document.getElementById('formData').value)" class="download-pdf-btn">
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>

        <div class="drafting-result-item">
          <div class="result-header">
            <i class="fas fa-file-text"></i>
            <h3>Supporting Statement</h3>
          </div>
          <textarea id="supporting" rows="6" placeholder="Supporting statement will appear here..."></textarea>
          <button onclick="downloadPDF('Supporting Statement', document.getElementById('supporting').value)" class="download-pdf-btn">
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ================= CASE PANEL ================= -->
<div id="casePanel" class="chat-panel" style="display:none; flex-direction:column; position:relative;">
  <div class="panel-header">
    <h3><i class="fa-solid fa-briefcase"></i> Cases</h3>
    <div style="display:flex; align-items:center; gap:12px; flex:1; justify-content:center;">
      <div class="table-search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="caseSearch" type="text" placeholder="Search cases..." oninput="filterCases()">
      </div>
    </div>
    <button id="addCaseBtn" class="btn btn-primary">+ Add New Case</button>
  </div>

  <div class="cases-container">
    <div class="cases-table-section" id="casesTableSection">
  <table class="admin-table">
    <thead>
      <tr>
        <th>Case Name</th>
        <th>Status</th>
        <th>Case Type</th>
        <th>Document Type</th>
        <th>Due Date</th>
        <th>Court Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="caseTableBody"></tbody>
  </table>
    </div>
    
    <!-- Right-side Analysis Panel (hidden by default) -->
    <div class="analysis-panel" id="analysisPanel" style="display: none; visibility: hidden;">
      <div class="analysis-header">
        <h4><i class="fa-solid fa-chart-line"></i> Document Analysis</h4>
        <button class="close-analysis-btn" onclick="closeAnalysisPanel()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="analysis-content">
        <div class="analysis-section">
          <label><i class="fa-solid fa-file-text"></i> Summary</label>
          <div class="analysis-text" id="analysisSummary"></div>
        </div>
        <div class="analysis-section">
          <label><i class="fa-solid fa-exclamation-triangle"></i> Missing Clauses</label>
          <div class="analysis-text" id="analysisMissingClauses"></div>
        </div>
        <div class="analysis-section">
          <label><i class="fa-solid fa-shield-alt"></i> Risky Language</label>
          <div class="analysis-text" id="analysisRiskyLanguage"></div>
        </div>
        <div class="analysis-section">
          <label><i class="fa-solid fa-lightbulb"></i> Suggestions</label>
          <div class="analysis-text" id="analysisSuggestions"></div>
        </div>
        <div class="analysis-actions">
          <button class="btn btn-secondary" onclick="downloadAnalysis()">
            <i class="fa-solid fa-download"></i> Download Analysis
          </button>
          <button class="btn btn-primary" onclick="closeAnalysisPanel()">
            <i class="fa-solid fa-check"></i> Done
          </button>
        </div>
      </div>
    </div>
    
    <!-- New Analysis Modal -->
    <div id="analysisModal" class="analysis-modal hidden">
      <div class="analysis-modal-content">
        <div class="analysis-modal-header">
          <h3><i class="fa-solid fa-chart-line"></i> Document Analysis Results</h3>
          <button class="close-analysis-modal-btn" onclick="closeAnalysisModal()">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
        <div class="analysis-modal-body">
          <div class="analysis-modal-section">
            <label><i class="fa-solid fa-file-text"></i> Summary</label>
            <div class="analysis-modal-text" id="modalAnalysisSummary"></div>
          </div>
          <div class="analysis-modal-section">
            <label><i class="fa-solid fa-exclamation-triangle"></i> Missing Clauses</label>
            <div class="analysis-modal-text" id="modalAnalysisMissingClauses"></div>
          </div>
          <div class="analysis-modal-section">
            <label><i class="fa-solid fa-shield-alt"></i> Risky Language</label>
            <div class="analysis-modal-text" id="modalAnalysisRiskyLanguage"></div>
          </div>
          <div class="analysis-modal-section">
            <label><i class="fa-solid fa-lightbulb"></i> Suggestions</label>
            <div class="analysis-modal-text" id="modalAnalysisSuggestions"></div>
          </div>
        </div>
        <div class="analysis-modal-actions">
          <button class="btn btn-secondary" onclick="downloadAnalysisFromModal()">
            <i class="fa-solid fa-download"></i> Download Analysis
          </button>
          <button class="btn btn-primary" onclick="closeAnalysisModal()">
            <i class="fa-solid fa-check"></i> Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Chat Icon -->
  <div class="floating-chat-icon" onclick="openChatModal()">
    <i class="fa-solid fa-comments"></i>
  </div>

  <!-- ================= CHAT MODAL (INSIDE CASE PANEL) ================= -->
  <div id="chatModal" class="chat-modal hidden">
    <div class="chat-modal-content">
      <div class="chat-modal-header">
        <div class="chat-modal-title">
          <i class="fa-solid fa-robot"></i>
          <span>AI Assistant</span>
        </div>
        <div class="chat-modal-actions">
          <button class="chat-action-btn" onclick="startNewChatInModal()" title="New Chat">
            <i class="fa-solid fa-plus"></i>
          </button>
          <button class="chat-action-btn" onclick="toggleChatHistory()" title="Chat History">
            <i class="fa-solid fa-history"></i>
          </button>
          <button class="chat-action-btn" onclick="closeChatModal()" title="Close">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="chat-modal-body">
        <div class="chat-history-panel hidden" id="chatHistoryPanel">
          <h4>Chat History</h4>
          <div id="modalChatHistory"></div>
        </div>
        
        <div class="chat-messages-container" id="modalChatMessages">
          <!-- Welcome message will be added dynamically -->
        </div>
        
        <div class="chat-input-container">
          <div class="chat-input-area">
            <input type="text" id="modalChatInput" placeholder="Type your message..." onkeydown="if(event.key==='Enter'){event.preventDefault(); sendModalMessage();}">
            <button class="chat-send-btn" onclick="sendModalMessage()">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
            <button class="chat-voice-btn" onclick="startVoiceToModal()">
              <i class="fa-solid fa-microphone"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= CASE MODAL ================= -->
<div id="caseModal" class="admin-modal hidden">
  <div class="admin-modal-content">
    <div class="modal-header">
      <div class="header-content">
        
        <div class="header-right">
    <h2 id="caseModalTitle">Add New Case</h2>
        </div>
      </div>
    </div>
  <form id="caseForm" class="form-grid">
  <input type="hidden" id="caseId"> <!-- Primary Key -->

  <div class="form-group">
    <label for="caseName">Case Name</label>
    <input type="text" id="caseName" required>
  </div>

  <div class="form-group">
    <label for="caseType">Case Type</label>
    <input type="text" id="caseType" placeholder="Civil, Criminal, etc.">
  </div>

  <div class="form-group">
    <label for="caseStatus">Case Status</label>
    <select id="caseStatus">
      <option value="Open">Open</option>
      <option value="In Progress">In Progress</option>
      <option value="Closed">Closed</option>
      <option value="On Hold">On Hold</option>
    </select>
  </div>

  <div class="form-group">
    <label for="casePriority">Case Priority</label>
    <select id="casePriority">
      <option value="Low">Low</option>
      <option value="Medium">Medium</option>
      <option value="High">High</option>
      <option value="Urgent">Urgent</option>
    </select>
  </div>

  <div class="form-group">
    <label for="openedDate">Opened Date</label>
    <input type="date" id="openedDate">
  </div>

  <div class="form-group">
    <label for="closedDate">Closed Date</label>
    <input type="date" id="closedDate">
  </div>

  <div class="form-group">
    <label for="dueDate">Due Date</label>
    <input type="date" id="dueDate">
  </div>

  <div class="form-group">
    <label for="courtName">Court Name</label>
    <input type="text" id="courtName">
  </div>

  <div class="form-group">
    <label for="hearingDate">Hearing Date</label>
    <input type="date" id="hearingDate">
  </div>

  <div class="form-group">
    <label for="judgeName">Judge Name</label>
    <input type="text" id="judgeName">
  </div>

  <div class="form-group">
    <label for="caseCategory">Case Category</label>
    <input type="text" id="caseCategory">
  </div>

  <div class="form-group">
    <label for="jurisdiction">Jurisdiction</label>
    <input type="text" id="jurisdiction">
  </div>

  <div class="form-group">
    <label for="caseFee">Case Fee</label>
    <input type="number" id="caseFee" step="0.01" placeholder="0.00">
  </div>

  <div class="form-group">
    <label for="billingStatus">Billing Status</label>
    <select id="billingStatus">
      <option value="Pending">Pending</option>
      <option value="Paid">Paid</option>
      <option value="Overdue">Overdue</option>
    </select>
  </div>

  <div class="form-group">
    <label for="customerId">Customer ID</label>
    <input type="number" id="customerId" required>
  </div>

  <div class="form-group">
    <label for="caseDocumentType">Document Type</label>
    <select id="caseDocumentType">
      <option value="Case">Case</option>
      <option value="Customer">Customer</option>
    </select>
  </div>

  <div class="form-group full-width">
    <label for="caseDescription">Case Description</label>
    <textarea id="caseDescription"></textarea>
  </div>

  <div class="form-group">
    <label for="caseFile">Upload Document</label>
    <div class="simple-file-upload">
    <input type="file" id="caseFile" multiple onchange="handleCaseFileSelection()">
      <div class="file-upload-placeholder">
        <i class="fa-solid fa-file-arrow-up"></i>
        <span>Choose File</span>
        <small>No file chosen</small>
        <em>or drag and drop</em>
      </div>
    </div>
    <div id="caseSelectedName" style="margin-top:6px; font-size:12px; color:#374151;"></div>
  </div>

  <div class="form-group full-width" style="display: none;">
    <label for="caseDocumentPreview">Document Preview (for Agent)</label>
    <textarea id="caseDocumentPreview" class="form-textarea" placeholder="Document content will be automatically extracted and saved here for AI agent to answer questions..." readonly style="display: none;"></textarea>
  </div>

  <div class="modal-actions">
    <button type="submit" id="caseSubmitBtn" class="btn btn-primary">Submit</button>
    <button type="button" id="analyzeCaseBtn" class="btn btn-info" onclick="analyzeCaseDocument()" style="margin-left: 10px; display: none;">
      <i class="fa-solid fa-chart-line"></i> Analyze
    </button>
    <button type="button" onclick="closeCaseForm()" class="btn btn-secondary">Cancel</button>
  </div>
</form>



  </div>
</div>
</div>

<!-- ================= CUSTOMER PANEL ================= -->
<div id="customerPanel" class="chat-panel" style="display:none; flex-direction:column; position:relative;">
  <div class="panel-header">
    <h3><i class="fa-solid fa-user"></i> Customers</h3>
    <div style="display:flex; align-items:center; gap:12px; flex:1; justify-content:center;">
      <div class="table-search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="customerSearch" type="text" placeholder="Search customers..." oninput="filterCustomers()">
      </div>
    </div>
    <button id="addCustomerBtn" class="btn btn-primary">+ Add New Customer</button>
  </div>

  <table class="admin-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>CNIC</th>
        <th>Occupation</th>
        <th>Company</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="customerTableBody"></tbody>
  </table>

  <!-- ================= CUSTOMER MODAL ================= -->
<div id="customerModal" class="admin-modal hidden">
  <div class="admin-modal-content">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-right">
    <h2 id="customerModalTitle">Add New Customer</h2>
        </div>
      </div>
    </div>
    <form id="customerForm" class="form-grid">
  <input type="hidden" id="customerId">

  <div class="form-group">
    <label for="customerName">Name</label>
    <input type="text" id="customerName" required>
  </div>

  <div class="form-group">
    <label for="customerPhone">Phone</label>
    <input type="text" id="customerPhone">
  </div>

  <div class="form-group">
    <label for="customerEmail">Email</label>
    <input type="email" id="customerEmail">
  </div>

  <div class="form-group">
    <label for="customerCNIC">CNIC</label>
    <input type="text" id="customerCNIC">
  </div>

  <div class="form-group">
    <label for="customerDOB">Date of Birth</label>
    <input type="date" id="customerDOB">
  </div>

  <div class="form-group">
    <label for="customerGender">Gender</label>
    <select id="customerGender">
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
  </div>

  <div class="form-group">
    <label for="customerOccupation">Occupation</label>
    <input type="text" id="customerOccupation">
  </div>

  <div class="form-group">
    <label for="customerCompany">Company Name</label>
    <input type="text" id="customerCompany">
  </div>

  <div class="form-group">
    <label for="customerEmergencyName">Emergency Contact Name</label>
    <input type="text" id="customerEmergencyName">
  </div>

  <div class="form-group">
    <label for="customerEmergencyPhone">Emergency Contact Phone</label>
    <input type="text" id="customerEmergencyPhone">
  </div>

  <div class="form-group full-width">
    <label for="customerAddress">Address</label>
    <textarea id="customerAddress"></textarea>
  </div>

  <div class="form-group full-width">
    <label for="customerContactInfo">Contact Info</label>
    <textarea id="customerContactInfo"></textarea>
  </div>

  <div class="form-group full-width">
    <label for="customerNotes">Notes</label>
    <textarea id="customerNotes"></textarea>
  </div>

  <div class="form-group">
    <label for="customerDocumentType">Document Type</label>
    <select id="customerDocumentType">
      <option value="Case">Case</option>
      <option value="Customer">Customer</option>
    </select>
  </div>

  <div class="form-group">
    <label for="customerFile">Upload Document</label>
    <div class="simple-file-upload">
    <input type="file" id="customerFile" multiple>
      <div class="file-upload-placeholder">
        <i class="fa-solid fa-file-arrow-up"></i>
        <span>Choose File</span>
        <small>No file chosen</small>
        <em>or drag and drop</em>
      </div>
    </div>
  </div>

  <div class="modal-actions">
    <button type="submit" id="customerSubmitBtn" class="btn btn-primary">Submit</button>
    <button type="button" onclick="closeCustomerForm()" class="btn btn-secondary">Cancel</button>
  </div>
</form>

  </div>
</div>


</div>







</div>





  <!-- Auth Overlay -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-split">
      <div class="auth-left">
        <!-- Fixed admin bar (hidden by default) -->
        <div class="admin-leftbar hidden" id="adminLeftBar">
          <div class="leftbar-title"><i class="fa-solid fa-shield-halved" style="color:#2563eb"></i> Admin Panel</div>
          <div class="leftbar-link" onclick="showAdminUsers()"><i class="fa-solid fa-users"></i> Users</div>
          <div class="leftbar-link" onclick="showAdminRequests()"><i class="fa-solid fa-inbox"></i> Signup Requests</div>
          <div class="leftbar-link" style="background:#16a34a; color:#fff; border-color:#16a34a;" onclick="openAppAsAdmin()"><i class="fa-solid fa-arrow-right-to-bracket"></i> Open App</div>
          <div class="leftbar-footer">
            <div class="leftbar-link" style="background:#eef2ff;border-color:#e5e7eb;color:#1f2937" onclick="adminBackToSignin()"><i class="fa-solid fa-arrow-left"></i> Back</div>
          </div>
        </div>
        <div class="form-wrap" id="signinFormWrap">
          <!-- Switch buttons pinned to very top-left as requested -->
          <div class="auth-switch-buttons" id="signinSwitches" style="position:absolute; top:16px; left:16px;">
            <button class="switch-btn active" onclick="switchToUser(this)">User</button>
            <button class="switch-btn" onclick="switchToAdmin(this)">Admin</button>
          </div>
          
          <div id="authLogin" class="auth-view">
            <div class="signin-header">
              <div class="signin-title"><i class="fa-solid fa-user"></i> <span>Sign In</span></div>
            </div>
            <label class="auth-label">Email Address</label>
            <input id="loginEmail" type="email" class="auth-field" placeholder="Enter your email" />
            <label class="auth-label">Password</label>
            <input id="loginPassword" type="password" class="auth-field" placeholder="Enter your password" />
            <div style="height:10px"></div>
            <button class="auth-btn" onclick="handleLogin()">Sign in</button>
            <div class="auth-muted">Don't have an account? <a class="auth-link" onclick="showSignup()">Sign up</a></div>
          </div>
          <div id="authAdmin" class="auth-view hidden">
            <div class="signin-header">
              <div class="signin-title"><i class="fa-solid fa-user-shield"></i> <span>Admin Sign In</span></div>
            </div>
            <label class="auth-label">Admin Email</label>
            <input id="adminEmail" type="email" class="auth-field" placeholder="Enter admin email" />
            <label class="auth-label">Admin Password</label>
            <input id="adminPassword" type="password" class="auth-field" placeholder="Enter your password" />
            <div style="height:10px"></div>
            <button class="auth-btn" onclick="handleAdminLogin()">Sign in</button>
            <div class="mini-note">On success, the Admin Panel opens in a popup with Users and Signup Requests.</div>
          </div>
          <div id="authSignup" class="auth-view hidden">
            <div class="auth-title">Sign Up</div>
            <label class="auth-label">Full Name</label>
            <input id="signupName" type="text" class="auth-field" placeholder="Enter your name" />
            <label class="auth-label">Email Address</label>
            <input id="signupEmail" type="email" class="auth-field" placeholder="Enter your email address" />
            <label class="auth-label">Password</label>
            <input id="signupPassword" type="password" class="auth-field" placeholder="Enter your password" />
            <div style="height:10px"></div>
            <button id="signupBtn" class="auth-btn" onclick="handleSignup()">Sign up</button>
            <div class="auth-muted">Already have an account? <a class="auth-link" onclick="showLogin()">Sign in</a></div>
          </div>
        </div>
      </div>
      <div class="auth-right">
        <div class="auth-brand">
          <div class="brand-icon"><i class="fa-solid fa-scale-balanced"></i><span style="margin-left:10px;font-weight:900;">AI</span></div>
          <div class="brand-title">AI Document Assistant</div>
          <div class="brand-text">
            Legal work is complex, but your processes don't have to be. With AI-powered automation tailored for legal firms, you spend less time on admin and more time on advocacy.
          </div>
          <div class="brand-powered">Powered by Scaleable Solutions</div>
        </div>
      </div>
    </div>
    <!-- Full-screen admin content area (for Users/Requests lists) -->
    <div id="adminContent" class="admin-content hidden"></div>
  </div>
 

  

</body>
  
  <!-- Settings Modal -->
  <div id="settingsOverlay" class="settings-modal-overlay" onclick="if(event.target===this) closeSettingsModal()">
    <div class="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="settings-modal-header">
        <div id="settingsTitle" class="title">Settings</div>
        <button class="icon-button close-btn" onclick="closeSettingsModal()" aria-label="Close" style="border:none;background:transparent;font-size:18px;cursor:pointer">✕</button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-item">
          <div><i class="fa-solid fa-sun"></i> <strong>Theme</strong></div>
          <div class="theme-options">
            <button id="themeLightBtn" class="theme-icon-btn" title="Light" onclick="setTheme('light')"><i class="fa-solid fa-sun"></i></button>
            <button id="themeDarkBtn" class="theme-icon-btn" title="Dark" onclick="setTheme('dark')"><i class="fa-solid fa-moon"></i></button>
          </div>
        </div>
        <div class="settings-item">
          <div><i class="fa-regular fa-message"></i> <strong>Send feedback</strong></div>
          <div style="opacity:0.6; font-size:12px;">Coming soon</div>
        </div>
        <div class="settings-item">
          <div><i class="fa-regular fa-circle-question"></i> <strong>Help</strong></div>
          <button class="icon-only-btn" title="Open Help" onclick="openHelp()"><i class="fa-solid fa-up-right-from-square"></i></button>
        </div>
      </div>
      
    </div>
  </div>

  <script>
// --- Theme handling & Settings modal ---
function openSettingsModal(){
  const o = document.getElementById('settingsOverlay');
  const modal = o ? o.querySelector('.settings-modal') : null;
  const settingsLink = document.querySelector('.second-sidebar .nav-bottom a[data-nav="settings"]');
  if(o && modal && settingsLink){
    const rect = settingsLink.getBoundingClientRect();
    // measure modal
    modal.style.visibility = 'hidden';
    modal.style.display = 'block';
    const modalHeight = modal.offsetHeight || 260;
    const modalWidth = modal.offsetWidth || 420;
    modal.style.display = '';
    modal.style.visibility = '';
    // position to the right of sidebar and clearly above the Settings button
    const top = rect.top - (modalHeight + 12); // place above with 12px gap
    const left = rect.right + 12; // to the right of sidebar/buttons
    modal.style.top = top + 'px';
    modal.style.left = left + 'px';
    o.classList.add('active');
  } else if(o){
    o.classList.add('active');
  }
}
function closeSettingsModal(){
  const o = document.getElementById('settingsOverlay');
  if(o){ o.classList.remove('active'); }
}

function applyThemeButtons(theme){
  const light = document.getElementById('themeLightBtn');
  const dark = document.getElementById('themeDarkBtn');
  if(light && dark){
    light.classList.toggle('active', theme === 'light');
    dark.classList.toggle('active', theme === 'dark');
  }
}

function setTheme(theme){
  const body = document.body;
  if(theme === 'dark'){
    body.classList.add('theme-dark');
    try { localStorage.setItem('theme','dark'); } catch(_){ }
  } else {
    body.classList.remove('theme-dark');
    try { localStorage.setItem('theme','light'); } catch(_){ }
  }
  applyThemeButtons(theme);
}

function initTheme(){
  let t = 'light';
  try { t = localStorage.getItem('theme') || 'light'; } catch(_){ }
  setTheme(t);
}

function openHelp(){
  window.open('https://www.scaleablesolutions.com/', '_blank');
}

document.addEventListener('DOMContentLoaded', initTheme);

// Profile box removed per request
// --- Auth overlay logic ---
function showLogin(){
  document.getElementById('authLogin').classList.remove('hidden');
  document.getElementById('authSignup').classList.add('hidden');
  document.getElementById('authAdmin').classList.add('hidden');
  document.getElementById('authOverlay').classList.remove('hidden');
  const sw = document.getElementById('signinSwitches');
  if (sw) sw.classList.remove('hidden');
  const adminContent = document.getElementById('adminContent');
  if (adminContent) adminContent.classList.add('hidden');
  
  // Update switch button states - show user as active
  document.querySelectorAll('#signinSwitches .switch-btn').forEach(btn => btn.classList.remove('active'));
  const first = document.querySelector('#signinSwitches .switch-btn:first-child');
  if (first) first.classList.add('active');
}
function showSignup(){
  document.getElementById('authSignup').classList.remove('hidden');
  document.getElementById('authLogin').classList.add('hidden');
  document.getElementById('authAdmin').classList.add('hidden');
  document.getElementById('authOverlay').classList.remove('hidden');
  const sw = document.getElementById('signinSwitches');
  if (sw) sw.classList.add('hidden'); // hide on signup per requirement
  
  // Update switch button states - show user as active
  document.querySelectorAll('#signinSwitches .switch-btn').forEach(btn => btn.classList.remove('active'));
  const first2 = document.querySelector('#signinSwitches .switch-btn:first-child');
  if (first2) first2.classList.add('active');
}
function switchToUser(btn){
  // Reset inputs and states when switching
  resetAuthForms();
  document.getElementById('authLogin').classList.remove('hidden');
  document.getElementById('authSignup').classList.add('hidden');
  document.getElementById('authAdmin').classList.add('hidden');
  document.getElementById('adminLeftBar').classList.add('hidden');
  const adminContent = document.getElementById('adminContent');
  if (adminContent) adminContent.classList.add('hidden');
  
  // Update switch button states
  const buttons = document.querySelectorAll('#signinSwitches .switch-btn');
  buttons.forEach(b => b.classList.remove('active'));
  if (!btn) btn = document.querySelector('#signinSwitches .switch-btn:first-child');
  if (btn) btn.classList.add('active');
}

// Clear inputs, messages, button states across auth forms
function resetAuthForms(){
  try {
    const ids = ['loginEmail','loginPassword','adminEmail','adminPassword','signupName','signupEmail','signupPassword'];
    ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    setLoginReadonly(false);
    const signupBtn = document.getElementById('signupBtn');
    if (signupBtn) signupBtn.style.display = '';
  } catch(_) {}
}

function switchToAdmin(btn){
  // Reset inputs and states when switching
  resetAuthForms();
  document.getElementById('authLogin').classList.add('hidden');
  document.getElementById('authSignup').classList.add('hidden');
  document.getElementById('authAdmin').classList.remove('hidden');
  document.getElementById('adminLeftBar').classList.add('hidden');
  const adminContent = document.getElementById('adminContent');
  if (adminContent) adminContent.classList.add('hidden');
  
  // Update switch button states
  const buttons = document.querySelectorAll('#signinSwitches .switch-btn');
  buttons.forEach(b => b.classList.remove('active'));
  if (!btn) btn = document.querySelector('#signinSwitches .switch-btn:nth-child(2)');
  if (btn) btn.classList.add('active');
}

function toggleAdminSignin(){
  // Legacy function - redirect to new switch functions
  switchToAdmin();
}
function adminBackToSignin(){
  // Hide admin panel and show login form + switches
  const leftbar = document.getElementById('adminLeftBar');
  if (leftbar) leftbar.classList.add('hidden');
  const wrap = document.getElementById('signinFormWrap');
  if (wrap) wrap.classList.remove('hidden');
  const sw = document.getElementById('signinSwitches');
  if (sw) sw.classList.remove('hidden');
  const adminContent = document.getElementById('adminContent');
  if (adminContent) adminContent.classList.add('hidden');
  // Ensure user login form is visible
  switchToUser();
}
function handleLogin(){
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    alert("❌ Please fill all required fields.");
    return;
  }

  fetch("http://localhost:5050/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  })
  .then(async res => {
    const data = await res.json();
    if (res.ok) {
      // persist login
      try { localStorage.setItem('auth', '1'); } catch(_) {}
      document.getElementById('authOverlay').classList.add('hidden');
      // Directly open app for user login - show empty screen
      showSecondSidebar();
    } else {
      alert("❌ " + data.message);
    }
  })
  .catch(() => alert("❌ Server error during login."));
}

// Simple admin links
function showAdminUsers(){
  const content = document.getElementById('adminContent');
  if (content) content.classList.remove('hidden');
  fetch('http://localhost:5050/admin/users.json')
    .then(res => res.json())
    .then(data => {
      const rows = (data.users||[]);
      // Only show selected columns in specific order
      const columns = ['id','username','password','email'];
      const headers = ['ID','User Name','Password Hash','Email'];
      const thead = headers.map(c=>`<th>${c}</th>`).join('');
      const body = rows.map(r=>`<tr>${columns.map(c=>`<td>${r[c] ?? ''}</td>`).join('')}</tr>`).join('')
        || '<tr><td colspan="4">No users found.</td></tr>';
      content.innerHTML = `
        <div class="page-title">Users</div>
        <div class="page-subtitle">All user records</div>
        <div class="admin-table">
          <table>
            <thead><tr>${thead}</tr></thead>
            <tbody>${body}</tbody>
          </table>
        </div>`;
    })
    .catch(()=>{
      if (content) content.innerHTML = '<div class="page-title">Users</div><div>Failed to load users.</div>';
    });
}

function showAdminRequests(){
  const content = document.getElementById('adminContent');
  if (content) content.classList.remove('hidden');
  fetch('http://localhost:5050/admin/requests.json')
    .then(res => res.json())
    .then(data => {
      const raw = (data.requests||[]);
      const columns = ['id','username','email','status','created_at'];
      const headers = ['ID','User Name','Email','Status','Created'];
      const thead = headers.map(h=>`<th>${h}</th>`).join('') + '<th>Actions</th>';
      const body = raw.map(r=>{
        const status = (r.status||'pending').toLowerCase();
        const cells = columns.map(c=>`<td>${r[c] ?? ''}</td>`).join('');
        const actions = status === 'pending'
          ? `<button class="cta-btn" onclick="approveRequest(${r.id}, '${r.email}')">Approve</button>
             <button class="cta-btn secondary" onclick="rejectRequest(${r.id}, '${r.email}')">Reject</button>`
          : `<span class="status-${status}">${status.toUpperCase()}</span>`;
        return `<tr>${cells}<td>${actions}</td></tr>`;
      }).join('') || '<tr><td colspan="6">No requests found.</td></tr>';
      content.innerHTML = `
        <div class="page-title">Signup Requests</div>
        <div class="page-subtitle">All user signup requests</div>
        <div class="admin-table">
          <table>
            <thead><tr>${thead}</tr></thead>
            <tbody>${body}</tbody>
          </table>
        </div>`;
    })
    .catch(()=>{
      if (content) content.innerHTML = '<div class="page-title">Signup Requests</div><div>Failed to load requests.</div>';
    });
}
async function handleAdminLogin(){
  const email = document.getElementById('adminEmail').value;
  const password = document.getElementById('adminPassword').value;
  if(!email || !password){ alert('❌ Please fill all admin fields.'); return; }
  try{
    const res = await fetch('http://localhost:5050/admin-login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
    const data = await res.json();
    if(res.ok && data.success){
      // Reveal admin leftbar and open Users list popup with Users list popup by default
      const leftbar = document.getElementById('adminLeftBar');
      if (leftbar) leftbar.classList.remove('hidden');
      // Hide switches and forms while admin panel is open
      const sw = document.getElementById('signinSwitches');
      if (sw) sw.classList.add('hidden');
      const wrap = document.getElementById('signinFormWrap');
      if (wrap) wrap.classList.add('hidden');
      // Show full-screen admin content by default (Users)
      showAdminUsers();
    } else {
      alert('❌ ' + (data.message || 'Admin login failed'));
    }
  } catch(e){
    alert('❌ Server error.');
  }
}

function openAppAsAdmin(){
  document.getElementById('authOverlay').classList.add('hidden');
  showSecondSidebar();
}
async function handleAdminSignup(){
  // Removed per latest requirement: admin signup handled outside this UI
}
// Admin popup logic
function showUsersPopup(){
  openAdminPopup('Users', 'http://localhost:5050/admin/users.json', mapUsersToTable);
}
function showRequestsPopup(){
  openAdminPopup('Signup Requests', 'http://localhost:5050/admin/requests.json', mapRequestsToTable);
}

function openAdminPopup(title, url, mapper){
  let modal = document.getElementById('adminModal');
  if(!modal){
    modal = document.createElement('div');
    modal.id = 'adminModal';
    modal.className = 'admin-modal hidden';
    modal.innerHTML = `
      <div class="admin-modal-content">
        <div class="admin-modal-header">
          <h3 id="adminModalTitle"></h3>
          <button class="admin-modal-close" onclick="closeAdminPopup()">✕</button>
        </div>
        <div class="admin-modal-body" id="adminModalBody"></div>
      </div>`;
    document.body.appendChild(modal);
  }
  document.getElementById('adminModalTitle').textContent = title;
  document.getElementById('adminModalBody').innerHTML = '<div>Loading...</div>';
  modal.classList.remove('hidden');

  fetch(url)
    .then(async res => {
      const ct = res.headers.get('Content-Type') || '';
      if(ct.includes('application/json')){
        const data = await res.json();
        document.getElementById('adminModalBody').innerHTML = mapper ? mapper(data) : `<pre>${JSON.stringify(data,null,2)}</pre>`;
      } else {
        const html = await res.text();
        document.getElementById('adminModalBody').innerHTML = `<iframe style="width:100%;height:70vh;border:0" srcdoc='${html.replace(/'/g,"&#39;")}'></iframe>`;
      }
    })
    .catch(() => {
      document.getElementById('adminModalBody').innerHTML = '<div>Failed to load.</div>';
    });
}
function closeAdminPopup(){
  const modal = document.getElementById('adminModal');
  if(modal) modal.classList.add('hidden');
}
function mapUsersToTable(data){
  const rows = (data.users||[]).map(u => `<tr><td>${u.id}</td><td>${u.username||''}</td><td>${u.email||''}</td><td>${u.created_at||''}</td></tr>`).join('');
  return `
    <div class="admin-table">
      <table>
        <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Created</th></tr></thead>
        <tbody>${rows||'<tr><td colspan="4">No users.</td></tr>'}</tbody>
      </table>
    </div>`;
}
function mapRequestsToTable(data){
  // Hide sensitive/internal columns from UI
  const rawCols = data.columns || ['id','username','email','password_hash','status','created_at'];
  const cols = rawCols.filter(c => c !== 'password_hash');
  const thead = cols.map(c=>`<th>${c}</th>`).join('') + '<th>Actions</th>';
  const rows = (data.requests||[]).map(r => {
    const status = r.status || 'pending';
    const actions = status === 'pending' ? 
      `<button onclick="approveRequest(${r.id}, '${r.email}')" class="cta-btn" style="margin-right:8px;">✅ Approve</button>
       <button onclick="rejectRequest(${r.id}, '${r.email}')" class="cta-btn secondary">❌ Reject</button>` : 
      `<span class="status-${status}">${status.toUpperCase()}</span>`;
    
    return `<tr>${cols.map(c=>`<td>${r[c] ?? ''}</td>`).join('')}<td>${actions}</td></tr>`;
  }).join('');
  
  return `
    <div class="admin-table">
      <table>
        <thead><tr>${thead}</tr></thead>
        <tbody>${rows||`<tr><td colspan="${cols.length + 1}">No requests.</td></tbody>`}</tbody>
      </table>
    </div>
  `;
}

// Admin approval functions
async function approveRequest(requestId, userEmail) {
  try {
    const response = await fetch('http://localhost:5050/admin/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: requestId, email: userEmail })
    });
    
    const data = await response.json();
    if (data.success) {
      // Refresh full-screen list without popup and show updated status
      showAdminRequests();
    } else {
      alert('❌ ' + (data.message || 'Approval failed'));
    }
  } catch (error) {
    alert('❌ Server error during approval');
  }
}

async function rejectRequest(requestId, userEmail) {
  try {
    const response = await fetch('http://localhost:5050/admin/reject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: requestId, email: userEmail })
    });
    
    const data = await response.json();
    if (data.success) {
      showAdminRequests();
    } else {
      alert('❌ ' + (data.message || 'Rejection failed'));
    }
  } catch (error) {
    alert('❌ Server error during rejection');
  }
}

function handleSignup(){
  const username = document.getElementById('signupName').value;
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  
  if (!username || !email || !password) {
    alert("❌ Please fill all required fields.");
    return;
  }

  // Send signup request for admin approval
  fetch("http://localhost:5050/signup", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, email, password })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'pending') {
      const btn = document.getElementById('signupBtn');
      if (btn) btn.style.display = 'none';
      // Switch to login and lock inputs while pending
      showLogin();
      setLoginReadonly(true);
      alert("⏳ Signup sent for admin approval. Login will unlock once approved.");
      window.__signupEmail = email;
      startApprovalPolling(email);
    } else {
      alert("❌ " + (data.message || 'Signup failed'));
    }
  })
  .catch(() => alert("❌ Server error during registration."));
}

function setLoginReadonly(isReadonly){
  const emailInput = document.getElementById('loginEmail');
  const passInput = document.getElementById('loginPassword');
  const signInBtn = document.querySelector('#authLogin .auth-btn');
  if (!emailInput || !passInput || !signInBtn) return;
  if (isReadonly){
    emailInput.setAttribute('readonly', 'true');
    passInput.setAttribute('readonly', 'true');
    signInBtn.setAttribute('disabled', 'true');
    signInBtn.style.opacity = '0.6';
    signInBtn.style.cursor = 'not-allowed';
  } else {
    emailInput.removeAttribute('readonly');
    passInput.removeAttribute('readonly');
    signInBtn.removeAttribute('disabled');
    signInBtn.style.opacity = '';
    signInBtn.style.cursor = '';
  }
}

function startApprovalPolling(email){
  if (!email) return;
  // Poll every 10s to check status
  if (window.__approvalTimer) clearInterval(window.__approvalTimer);
  window.__approvalTimer = setInterval(() => checkSignupStatus(email), 10000);
  // Also do an immediate check
  checkSignupStatus(email);
}

function checkSignupStatus(userEmail){
  fetch("http://localhost:5050/check-status", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: userEmail })
  })
  .then(res => res.json())
  .then(data => {
    const btn = document.getElementById('signupBtn');
    if (data.status === 'approved') {
      if (btn) btn.style.display = 'none';
      try { clearInterval(window.__approvalTimer); } catch(_) {}
      setLoginReadonly(false);
      alert('✅ Your request is approved! Please login.');
      const emailInput = document.getElementById('loginEmail');
      if (emailInput && window.__signupEmail) emailInput.value = window.__signupEmail;
    } else if (data.status === 'rejected') {
      if (btn) btn.style.display = 'block';
      try { clearInterval(window.__approvalTimer); } catch(_) {}
      setLoginReadonly(false);
      alert('❌ Your signup request was denied. You can sign up again.');
    } else if (data.status === 'pending') {
      if (btn) btn.style.display = 'none';
      setLoginReadonly(true);
    } else {
      if (btn) btn.style.display = 'block';
      setLoginReadonly(false);
    }
  })
  .catch(() => {});
}
// Google login removed
function handleLogout(){
  try { localStorage.removeItem('auth'); } catch(_) {}
  showLogin();
}
function sendMessage(){
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(text !== ''){
    const activeId = getActiveChatId();
    if (!activeId) startNewChat();
    const msgContainer = document.getElementById('chatMessages');
    const welcome = document.getElementById('chatWelcome');
    if (welcome) welcome.remove();
    
    // Add user message
    const msg = document.createElement('div');
    msg.classList.add('message', 'user');
    msg.textContent = text;
    msgContainer.appendChild(msg);
    input.value = '';
    msgContainer.scrollTop = msgContainer.scrollHeight;

    // Get document preview for context
    const previewText = document.getElementById('docPreviewText')?.value || 
                       window.documentText || 
                       localStorage.getItem('currentDocumentContent') || '';

    // Send to backend and get response
    fetch("http://localhost:5050/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        question: text,
        document: previewText 
      })
    })
    .then(res => res.json())
    .then(data => {
      const agentMsg = document.createElement('div');
      agentMsg.classList.add('message', 'agent');
      
      // Better error handling with helpful messages
      let responseText = "";
      if (data.answer) {
        responseText = data.answer;
      } else if (data.error) {
        responseText = `❌ Error: ${data.error}\n\nPlease try:\n1. Refreshing the page\n2. Checking your internet connection\n3. Contacting support if the issue persists`;
      } else {
        responseText = "🤖 I'm here to help! I can assist you with:\n\n• **Case Management**: Add and track legal cases\n• **Document Handling**: Upload and analyze documents\n• **Customer Information**: Manage client details\n• **Legal Support**: Get help with your legal work\n\nWhat would you like to do today?";
      }
      
      agentMsg.innerHTML = formatAgentAnswer(responseText);
      msgContainer.appendChild(agentMsg);
      msgContainer.scrollTop = msgContainer.scrollHeight;
      // Persist both messages in history
      appendMessageToHistory('user', text);
      appendMessageToHistory('agent', agentMsg.innerHTML);
    })
    .catch(() => {
      const agentMsg = document.createElement('div');
      agentMsg.classList.add('message', 'agent');
      agentMsg.innerHTML = formatAgentAnswer("Server error. Try again.");
      msgContainer.appendChild(agentMsg);
      msgContainer.scrollTop = msgContainer.scrollHeight;
      appendMessageToHistory('user', text);
      appendMessageToHistory('agent', agentMsg.innerHTML);
    });
  }
}

// Add basic formatting for agent text: headings and bullet points
function formatAgentAnswer(text){
  if(!text) return '';
  let html = text
    // convert bold **text**
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // headings like **Heading:** or markdown ### Heading
    .replace(/^\s*\*\*(.+?)\*\*:?\s*$/gim, '<h4>$1</h4>')
    .replace(/^#{1,6}\s*(.*)$/gim, '<h4>$1</h4>')
    // bullet lines starting with dash or asterisk
    .replace(/^\s*[-\*]\s+(.*)$/gim, '<li>$1</li>');
  // wrap standalone list items in <ul>
  html = html.replace(/(<li>[^<]*<\/li>\s*)+/g, match => `<ul>${match}</ul>`);
  // convert remaining line breaks to paragraphs
  html = html
    .split(/\n\n+/)
    .map(block => /<h4>|<ul>|<li>/.test(block) ? block : `<p>${block.replace(/\n/g,'<br>')}</p>`)
    .join('');
  return html;
}

function ensureChatWelcome() {
  const container = document.getElementById('chatMessages');
  if (!container) return;
  
  // Clear any existing welcome messages first
  const existingWelcome = document.getElementById('chatWelcome');
  if (existingWelcome) {
    existingWelcome.remove();
  }
  
  // Only add welcome if there are no messages
  if (container.children.length === 0) {
    const welcome = document.createElement('div');
    welcome.id = 'chatWelcome';
    welcome.className = 'chat-welcome';
    welcome.innerHTML = `<div>
      <h3 style="margin:0 0 6px 0; color:#111;">Hello Akif</h3>
      <div>Welcome to the chat. Ask anything and I will help you.</div>
    </div>`;
    container.appendChild(welcome);
  }
}

// --- Voice to Agent (uses backend) ---
function addMessage(text, role, options = {}){
  const { skipHistory = false } = options;
  const container = document.getElementById('chatMessages');
  if(!container) return;
  const div = document.createElement('div');
  div.className = `message ${role==='user' ? 'user' : (role==='agent' ? 'agent' : 'system')}`;
  // Agent may include simple formatting
  div.innerHTML = role==='agent' ? formatAgentAnswer(text) : text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  // also persist to current chat
  if(!skipHistory && (role==='agent' || role==='user')) appendMessageToHistory(role, div.innerHTML);
  return div;
}

let documentText = '';
// If your backend already loads a working document into preview, capture it
function refreshDocumentTextFromPreview(){
  const text = document.querySelector('#preview pre')?.textContent || '';
  if(text) documentText = text;
}

function startVoiceToAgent() {
  // ensure there is an active chat thread
  const activeId = getActiveChatId();
  if (!activeId) startNewChat();

  const RecognitionCtor = (window.SpeechRecognition || window.webkitSpeechRecognition);
  if (!RecognitionCtor) {
    addMessage("❌ Voice recognition is not supported in this browser.", "agent");
    return;
  }
  const recognition = new RecognitionCtor();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();

  const listeningEl = addMessage("🎤 Listening... Please speak your question.", "agent", { skipHistory: true });

  recognition.onresult = function(event) {
    if (listeningEl && listeningEl.parentNode) listeningEl.parentNode.removeChild(listeningEl);
    const voiceText = event.results[0][0].transcript;
    addMessage("🎤 " + voiceText, "user");

    // Get document preview for context
    const previewText = document.getElementById('docPreviewText')?.value || 
                       window.documentText || 
                       localStorage.getItem('currentDocumentContent') || '';

    // Use the same chat endpoint/variables as text chat
    fetch("http://localhost:5050/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        question: voiceText,
        document: previewText 
      })
    })
    .then(res => res.json())
    .then(data => {
      addMessage(data.answer || "❌ Agent could not answer the voice question.", "agent");
    })
    .catch(() => {
      addMessage("❌ Voice question failed. Please try again.", "agent");
    });
  };

  recognition.onerror = function(event) {
    if (listeningEl && listeningEl.parentNode) listeningEl.parentNode.removeChild(listeningEl);
    addMessage("❌ Voice recognition error: " + event.error, "agent");
  };
}

function showSecondSidebar(type) {
  const sidebar = document.getElementById('secondSidebar');
  const chatPanel = document.getElementById('chatPanel');
  const documentAssistant = document.getElementById('documentAssistant');
  const voiceAssistant = document.getElementById('voiceAssistant');
  const pdfAutoFillPanel = document.getElementById('pdfAutoFillPanel');
   const draftingPanel = document.getElementById('draftingPanel');

  // Hide all panels initially
  if (chatPanel) chatPanel.style.display = 'none';
  if (documentAssistant) documentAssistant.style.display = 'none';
  if (voiceAssistant) voiceAssistant.style.display = 'none';
  if (pdfAutoFillPanel) pdfAutoFillPanel.style.display = 'none';
  if (draftingPanel) draftingPanel.style.display = 'none';

  // Show the appropriate panel based on type (only if type is specified)
  if(type === 'chat') {
    if (chatPanel) chatPanel.style.display = 'flex';
  } 
  else if(type === 'doc') {
    if (documentAssistant) documentAssistant.style.display = 'flex';
  }
  // If no type is specified, keep all panels hidden (empty screen)
}

function showPdfAutoFillPanel() {
  // Hide all other panels
  document.querySelectorAll('.panel').forEach(panel => {
    panel.style.display = 'none';
  });

  // Show only the PDF Auto Fill panel
  const pdfPanel = document.getElementById('pdfAutoFillPanel');
  if (pdfPanel) {
    pdfPanel.style.display = 'block';
    pdfPanel.classList.add('full-screen'); // optional: full screen styling
  }
}



function setPrimaryActive(el){
  const nav = document.getElementById('primaryNav');
  if(!nav) return;
  Array.from(nav.querySelectorAll('a')).forEach(a=>a.classList.remove('active'));
  el.classList.add('active');
}

function setSecondActive(el){
  const sidebar = document.getElementById('secondSidebar');
  if(!sidebar) return;
  Array.from(sidebar.querySelectorAll('.doc-item')).forEach(a=>a.classList.remove('active'));
  el.classList.add('active');
}

// --- Simple chat history (localStorage) ---
function getActiveChatId(){
  try { return localStorage.getItem('activeChatId') || ''; } catch(_) { return ''; }
}
function setActiveChatId(id){
  try { localStorage.setItem('activeChatId', id); } catch(_) {}
}
function loadChats(){
  try { return JSON.parse(localStorage.getItem('chats')||'[]'); } catch(_) { return []; }
}
function saveChats(chats){
  try { localStorage.setItem('chats', JSON.stringify(chats)); } catch(_) {}
}
function startNewChat(){
  const chats = loadChats();
  const newChat = { id: Date.now().toString(), title: 'New chat', messages: [] };
  chats.unshift(newChat);
  saveChats(chats);
  setActiveChatId(newChat.id);
  // reset UI thread
  const container = document.getElementById('chatMessages');
  if (container){ container.innerHTML = ''; ensureChatWelcome(); }
  renderChatHistory();
}
function appendMessageToHistory(role, content){
  const chats = loadChats();
  const id = getActiveChatId();
  const chat = chats.find(c=>c.id===id);
  if(!chat) return;
  chat.messages.push({ role, content, t: Date.now() });
  if (role==='user' && (!chat.title || chat.title==='New chat')){
    chat.title = content.slice(0, 28);
  }
  saveChats(chats);
  renderChatHistory();
}
function openChat(id){
  setActiveChatId(id);
  const chats = loadChats();
  const chat = chats.find(c=>c.id===id);
  const container = document.getElementById('chatMessages');
  if (!container || !chat) return;
  container.innerHTML = '';
  
  // Only show welcome if there are no messages
  if (chat.messages.length === 0) {
    ensureChatWelcome();
  } else {
    // Show existing messages
  chat.messages.forEach(m=>{
    const div = document.createElement('div');
    div.className = `message ${m.role==='user'?'user':'agent'}`;
    div.innerHTML = m.role==='agent' ? m.content : m.content;
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
  }
  
  renderChatHistory();
}
function renderChatHistory(){
  const list = document.getElementById('chatHistory');
  if(!list) return;
  const chats = loadChats();
  const active = getActiveChatId();
  list.innerHTML = chats.map(c=>
    `<div class="history-item ${c.id===active?'active':''}" onclick="openChat('${c.id}')">
      <span class="history-title">${(c.title||'New chat')}</span>
      <span class="history-actions">
        <i class="fa-solid fa-trash delete-btn" title="Delete" onclick="event.stopPropagation(); deleteChat('${c.id}')"></i>
        <i class="fa-solid fa-chevron-right chev" style="color:#64748b"></i>
      </span>
    </div>`
  ).join('');
}

function deleteChat(id){
  const chats = loadChats();
  const next = chats.filter(c=>c.id!==id);
  saveChats(next);
  if (getActiveChatId() === id){
    setActiveChatId(next[0]?.id || '');
    if (next.length){
      openChat(next[0].id);
    } else {
      const container = document.getElementById('chatMessages');
      if (container){ 
        container.innerHTML = ''; 
        ensureChatWelcome(); 
      }
    }
  }
  renderChatHistory();
}



function showUploadUI() {
  // Hide welcome screen
  const welcomeScreen = document.getElementById('welcomeScreen');
  if (welcomeScreen) {
    welcomeScreen.style.display = 'none';
  }
  
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('documentAssistant').style.display = 'flex';
  document.getElementById('pdfAutoFillPanel').style.display = 'none';
  document.getElementById('draftingPanel').style.display = 'none';
  document.getElementById('casePanel').style.display = 'none';
  document.getElementById('customerPanel').style.display = 'none';
  const voicePanel = document.getElementById('voiceAssistant');
  if (voicePanel) voicePanel.style.display = 'none';

  const pdfPanel = document.getElementById('pdfAutoFillPanel');
  if (pdfPanel) pdfPanel.style.display = 'none';
}

function openVoiceScreen() {
  // Hide welcome screen
  const welcomeScreen = document.getElementById('welcomeScreen');
  if (welcomeScreen) {
    welcomeScreen.style.display = 'none';
  }
  
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('documentAssistant').style.display = 'none';
  document.getElementById('voiceAssistant').style.display = 'flex';
  document.getElementById('draftingPanel').style.display = 'none';
  document.getElementById('pdfAutoFillPanel').style.display = 'none';
  document.getElementById('casePanel').style.display = 'none';
  document.getElementById('customerPanel').style.display = 'none';
  const pdfPanel = document.getElementById('pdfAutoFillPanel');
  if (pdfPanel) pdfPanel.style.display = 'none';
}

function showPdfAutoFillPanel() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('documentAssistant').style.display = 'none';
  document.getElementById('voiceAssistant').style.display = 'none';
  const welcome = document.getElementById('welcomeScreen');
  if (welcome) welcome.style.display = 'none';
  document.getElementById('pdfAutoFillPanel').style.display = 'flex';
  document.getElementById('draftingPanel').style.display = 'none';
  document.getElementById('casePanel').style.display = 'none';
  document.getElementById('customerPanel').style.display = 'none';
}

function draftingPanel() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('documentAssistant').style.display = 'none';
  document.getElementById('voiceAssistant').style.display = 'none';
  const welcome = document.getElementById('welcomeScreen');
  if (welcome) welcome.style.display = 'none';
  document.getElementById('pdfAutoFillPanel').style.display = 'none';
  document.getElementById('draftingPanel').style.display = 'flex';
  document.getElementById('casePanel').style.display = 'none';
  document.getElementById('customerPanel').style.display = 'none';
}

function openCasePanel() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('documentAssistant').style.display = 'none';
  document.getElementById('voiceAssistant').style.display = 'none';
  const welcome = document.getElementById('welcomeScreen');
  if (welcome) welcome.style.display = 'none';
  document.getElementById('pdfAutoFillPanel').style.display = 'none';
  document.getElementById('draftingPanel').style.display = 'none';
  document.getElementById('customerPanel').style.display = 'none';
  document.getElementById('casePanel').style.display = 'flex';
  loadCases(); // load data into table
}

function openCustomerPanel() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('documentAssistant').style.display = 'none';
  document.getElementById('voiceAssistant').style.display = 'none';
  const welcome = document.getElementById('welcomeScreen');
  if (welcome) welcome.style.display = 'none';
  document.getElementById('pdfAutoFillPanel').style.display = 'none';
  document.getElementById('draftingPanel').style.display = 'none';
  document.getElementById('casePanel').style.display = 'none';
  document.getElementById('customerPanel').style.display = 'flex';
  loadCustomers(); // load data into table
}



// Initialize welcome message on first load and restore auth state
try {
  const isAuthed = localStorage.getItem('auth') === '1';
  if (isAuthed) {
    document.getElementById('authOverlay').classList.add('hidden');
    showSecondSidebar();
  } else {
    showLogin();
  }
} catch(_) {
  showLogin();
}

// Document Assistant logic (frontend only)
let uploadedDocumentFiles = []; // array of File
let analyzedBlob = null;
let uploadedCaseFiles = [];
let currentAnalysisText = '';
let uploadedAudioBlob = null;

const dropzoneDoc = document.getElementById('dropzoneDoc');
const fileInputDoc = document.getElementById('fileInputDoc');
const dropzoneCase = document.getElementById('dropzoneCase');
const fileInputCase = document.getElementById('fileInputCase');
// Voice screen elements
const voiceDropzone = document.getElementById('voiceDropzone');
const voiceFileInput = document.getElementById('voiceFileInput');
const voicePreview = document.getElementById('voicePreview');
const voiceSummaryBtn = document.getElementById('voiceSummaryBtn');
const preview = document.getElementById('preview');
const submitBtn = document.getElementById('submitBtn');
const downloadBtn = document.getElementById('downloadBtn');
const downloadName = document.getElementById('downloadName');
const leftActions = document.getElementById('leftActions');
const formatSelect = document.getElementById('formatSelect');

function setPreviewContent(html) {
  preview.innerHTML = html;
}

function setVoicePreviewContent(html) {
  if (voicePreview) voicePreview.innerHTML = html;
}

function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsText(file);
  });
}

function updateSelectedFilesUI(){
  const docEl = document.getElementById('docFileName');
  const caseEl = document.getElementById('caseFileName');
  if (docEl) docEl.textContent = `Document: ${uploadedDocumentFiles.length ? uploadedDocumentFiles.map(f=>f.name).join(', ') : '—'}`;
  if (caseEl) caseEl.textContent = `Case: ${uploadedCaseFiles.length ? uploadedCaseFiles.map(f=>f.name).join(', ') : '—'}`;
}

function handleFiles(files, type) {
  if (!files || files.length === 0) return;
  const fileArray = Array.from(files);
  if (type === 'doc') uploadedDocumentFiles = fileArray; else if (type === 'case') uploadedCaseFiles = fileArray; else if (type === 'audio') uploadedAudioBlob = fileArray[0];
  
  updateSelectedFilesUI();
  // Update preview immediately with a processing state
  updateDocumentPreview();
  
  // Extract text from files first
  const textPromises = fileArray.map(file => extractTextFromFile(file));
  
  Promise.all(textPromises)
    .then(texts => {
      const combinedText = texts.filter(Boolean).join('\n\n');
      console.log('Extracted text for type', type, ':', combinedText.substring(0, 200) + '...');
      
      if (type === 'doc') {
        window.documentText = combinedText;
        console.log('Document text set:', window.documentText ? 'Yes' : 'No');
      } else if (type === 'case') {
        window.caseText = combinedText;
        console.log('Case text set:', window.caseText ? 'Yes' : 'No');
      }
      
      // Refresh preview now that text is available
      updateDocumentPreview();
      // Re-evaluate submit button visibility
      updateSubmitVisibility();
      
      // Also update the document preview field for the agent
      const previewField = document.getElementById('docPreviewText');
      if (previewField) {
        previewField.value = combinedText;
        console.log('Preview field updated with text length:', combinedText.length);
      } else {
        console.error('Preview field not found!');
      }
    })
    .catch(err => {
      console.error('Text extraction failed:', err);
  });

  if (leftActions) leftActions.classList.add('hidden');
  analyzedBlob = null;
}

// Helper function to extract text from files
function extractTextFromFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const content = e.target.result;
        resolve(content);
      } catch (err) {
        reject(err);
      }
    };
    
    reader.onerror = reject;
    
    // Read as text for all file types (backend will handle specific parsing)
    reader.readAsText(file);
  });
}

// When analysis text updates, also show a formatted preview below
function setAnalysisText(text){
  const ta = document.getElementById('docSummaryText');
  const normalizeSummaryText = (raw) => {
    if (!raw) return '';
    let s = String(raw).replace(/\r/g, '');
    // Remove markdown horizontal rules
    s = s.replace(/^\s*[-=_]{3,}\s*$/gm, '');
    // Strip leading markdown heading hashes (##, ###, etc.)
    s = s.replace(/^#{1,6}\s*/gm, '');
    // Convert bullet markers to real bullets
    s = s.replace(/^\s*[-*]\s+/gm, '• ');
    // Remove bold/italic markers ** ** and * *
    s = s.replace(/\*\*([^*]+)\*\*/g, '$1');
    s = s.replace(/\*(?!\s)([^*]+)(?<!\s)\*/g, '$1');
    // Collapse excessive blank lines
    s = s.replace(/\n{3,}/g, '\n\n');
    return s.trim();
  };
  const plain = normalizeSummaryText(text);
  if (ta) ta.value = plain;
  updateSummaryRender();
  const fp = document.getElementById('formattedPreview');
  if (fp) fp.style.display = plain ? 'block' : 'none';
}

function updateDocumentPreview() {
  let previewContent = '';
  
  if (uploadedDocumentFiles.length) {
    previewContent += `<div style="margin-bottom: 20px;">
      <h4 style="margin: 0 0 10px 0; color: #333;">📄 ${uploadedDocumentFiles.map(f=>f.name).join(', ')}</h4>
      <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 4px solid #007bff;">
        <strong>Document Content:</strong><br>
        ${window.documentText ? window.documentText.substring(0, 1000) + '...' : 'Processing...'}
      </div>
    </div>`;
  }
  
  if (uploadedCaseFiles.length) {
    previewContent += `<div style="margin-bottom: 20px;">
      <h4 style="margin: 0 0 10px 0; color: #333;">📋 ${uploadedCaseFiles.map(f=>f.name).join(', ')}</h4>
      <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 4px solid #28a745;">
        <strong>Case Content:</strong><br>
        ${window.caseText ? window.caseText.substring(0, 1000) + '...' : 'Processing...'}
      </div>
    </div>`;
  }
  
  if (!uploadedDocumentFiles.length && !uploadedCaseFiles.length) {
    previewContent = '<div class="placeholder">Upload documents to see preview...</div>';
  }
  
  setPreviewContent(previewContent);
}

function wireDropzone(zoneEl, inputEl, kind) {
  if (!zoneEl || !inputEl) return;
  zoneEl.addEventListener('click', () => inputEl.click());
  zoneEl.addEventListener('dragover', e => { e.preventDefault(); zoneEl.classList.add('drag'); });
  zoneEl.addEventListener('dragleave', () => zoneEl.classList.remove('drag'));
  zoneEl.addEventListener('drop', e => {
    e.preventDefault();
    zoneEl.classList.remove('drag');
    handleFiles(e.dataTransfer.files, kind);
  });
  inputEl.addEventListener('change', e => handleFiles(e.target.files, kind));
}

wireDropzone(dropzoneDoc, fileInputDoc, 'doc');
wireDropzone(dropzoneCase, fileInputCase, 'case');
// Voice screen wiring
function wireVoice(zone, input){
  if(!zone || !input) return;
  zone.addEventListener('click', ()=> input.click());
  zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', ()=> zone.classList.remove('drag'));
  zone.addEventListener('drop', e=>{ e.preventDefault(); zone.classList.remove('drag'); handleVoiceFiles(e.dataTransfer.files); });
  input.addEventListener('change', e=> handleVoiceFiles(e.target.files));
}
wireVoice(voiceDropzone, voiceFileInput);

function handleVoiceFiles(files){
  if(!files || files.length===0) return;
  uploadedAudioBlob = files[0];
  setVoicePreviewContent(`<pre>${uploadedAudioBlob.name} (${(uploadedAudioBlob.size/1024).toFixed(1)} KB)\n\nReady to summarize.</pre>`);
  if (voiceSummaryBtn) voiceSummaryBtn.classList.remove('hidden');
}

if (voiceSummaryBtn) {
  voiceSummaryBtn.addEventListener('click', ()=>{
    if(!uploadedAudioBlob) return;
    voiceSummaryBtn.disabled = true;
    voiceSummaryBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Summarizing...';
    
    const formData = new FormData();
    formData.append("audio", uploadedAudioBlob);
    
    fetch("http://localhost:5050/upload-voice", {
      method: "POST",
      body: formData
    })
    .then((res) => res.json())
    .then((data) => {
      if (data.voice_id) {
        // Fetch summary from DB
        return fetch(`http://localhost:5050/voice-summary/${data.voice_id}`);
      } else {
        throw new Error(data.error || "Voice upload failed");
      }
    })
    .then(res => res.json())
    .then(data => {
      const summary = data.summary || `Audio summary for: ${uploadedAudioBlob.name}\n\n❌ Summary generation failed.`;
      const voiceSummaryText = document.getElementById('voiceSummaryText');
      if (voiceSummaryText) voiceSummaryText.value = summary;
    })
    .catch((err) => {
      const summary = `Audio summary for: ${uploadedAudioBlob.name}\n\n❌ ${err.message}`;
      const voiceSummaryText = document.getElementById('voiceSummaryText');
      if (voiceSummaryText) voiceSummaryText.value = summary;
    })
    .finally(() => {
      voiceSummaryBtn.disabled = false;
      voiceSummaryBtn.innerHTML = '<i class="fa-solid fa-align-left"></i> Generate Summary';
    });
  });
}

function updateSubmitVisibility() {
  if (!submitBtn) return;
  if (uploadedDocumentFiles.length || uploadedCaseFiles.length) {
    submitBtn.classList.remove('hidden');
    submitBtn.disabled = false;
  } else {
    submitBtn.classList.add('hidden');
    submitBtn.disabled = true;
  }
}

if (submitBtn) {
  submitBtn.addEventListener('click', async () => {
    if (!(uploadedDocumentFiles.length || uploadedCaseFiles.length)) return;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

    try {
      // First, upload files to get proper text extraction
    let combinedContent = '';
    let summaryTitle = '';
      
      // Upload document files if any
      if (uploadedDocumentFiles.length > 0) {
        console.log('Uploading document files:', uploadedDocumentFiles.map(f => f.name));
        const docFormData = new FormData();
        uploadedDocumentFiles.forEach(file => docFormData.append('files[]', file));
        
        const docResponse = await fetch('http://localhost:5050/upload', {
          method: 'POST',
          body: docFormData
        });
        
        console.log('Document upload response status:', docResponse.status);
        const docData = await docResponse.json();
        console.log('Document upload response:', docData);
        
        if (docData.results) {
          const docText = docData.results.map(r => r.text || '').filter(Boolean).join('\n\n');
          combinedContent += 'DOCUMENT:\n' + docText + '\n\n';
          summaryTitle += uploadedDocumentFiles.map(f => f.name).join(', ');
          window.documentText = docText;
          console.log('Document text extracted:', docText.substring(0, 200) + '...');
        }
      }
      
      // Upload case files if any
      if (uploadedCaseFiles.length > 0) {
        console.log('Uploading case files:', uploadedCaseFiles.map(f => f.name));
        const caseFormData = new FormData();
        uploadedCaseFiles.forEach(file => caseFormData.append('cases[]', file));
        
        const caseResponse = await fetch('http://localhost:5050/upload-case', {
          method: 'POST',
          body: caseFormData
        });
        
        console.log('Case upload response status:', caseResponse.status);
        const caseData = await caseResponse.json();
        console.log('Case upload response:', caseData);
        
        if (caseData.results) {
          const caseText = caseData.results.map(r => r.text || '').filter(Boolean).join('\n\n');
          combinedContent += 'CASE:\n' + caseText;
      if (summaryTitle) summaryTitle += ' + ';
          summaryTitle += uploadedCaseFiles.map(f => f.name).join(', ');
          window.caseText = caseText;
          console.log('Case text extracted:', caseText.substring(0, 200) + '...');
    }
      }
      
    if (!combinedContent) {
        combinedContent = 'No valid content to analyze.';
        summaryTitle = 'No content';
      }
      
      // Save document preview for agent
      const previewText = document.getElementById('docPreviewText');
      if (previewText) {
        previewText.value = combinedContent;
      }
      
            // Now analyze the content
      console.log('Sending content to analyze:', combinedContent.substring(0, 200) + '...');
      
      const analyzeResponse = await fetch("http://localhost:5050/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: combinedContent })
      });
      
      console.log('Analyze response status:', analyzeResponse.status);
      
      const data = await analyzeResponse.json();
      console.log('Analyze response data:', data);
      
      let analysisText;
      if (data.analysis) {
        analysisText = data.analysis;
        console.log('Analysis received:', analysisText.substring(0, 200) + '...');
      } else {
        analysisText = `Summary for: ${summaryTitle}\n\n❌ Analysis failed. Response: ${JSON.stringify(data)}`;
        console.error('Analysis failed:', data);
      }
      
      setAnalysisText(analysisText);
      analyzedBlob = new Blob([analysisText], { type: 'text/plain' });
      if (leftActions) leftActions.classList.remove('hidden');
      
      // Show analysis panel and collapse table
      console.log('Calling showAnalysisPanel with:', analysisText);
      showAnalysisPanel(analysisText);
      
    } catch (error) {
      console.error('Error during analysis:', error);
      const analysisText = `Summary for: ${summaryTitle || 'Unknown'}\n\n❌ Server error during analysis: ${error.message}`;
      setAnalysisText(analysisText);
      analyzedBlob = new Blob([analysisText], { type: 'text/plain' });
      if (leftActions) leftActions.classList.remove('hidden');
      
      // Show analysis panel even on error
      showAnalysisPanel(analysisText);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Submit & Analyze';
    }
  });
}

if (downloadBtn) {
  downloadBtn.addEventListener('click', async () => {
    const chosenFormat = (formatSelect?.value || 'txt');
    const suggestedBase = (uploadedDocumentFiles[0]?.name || 'document').replace(/\.[^/.]+$/, '') + '-summary';
    const suggested = `${suggestedBase}.${chosenFormat}`;
    
    const analysis = document.getElementById('docSummaryText')?.value || '';
    if (!analysis.trim()) { alert('Summary is empty.'); return; }

    const setBusy = (busy) => {
      if (!downloadBtn) return;
      downloadBtn.disabled = busy;
      downloadBtn.innerHTML = busy ? '<i class="fa-solid fa-spinner fa-spin"></i> Download' : '<i class="fa-solid fa-download"></i> Download';
    };

    // Client-side TXT generation
    if (chosenFormat === 'txt') {
      const blob = new Blob([analysis], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = suggested;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      return;
    }

    // Server generation for pdf/docx with fallback
    try {
      setBusy(true);
      const response = await fetch('http://localhost:5050/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ original: '', analysis, format: chosenFormat })
      });
      if (!response.ok) {
        let msg = 'Download failed.';
        try { const err = await response.json(); if (err?.error) msg = err.error; } catch(_) {}
        throw new Error(msg);
      }
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = suggested;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error('Server download failed, falling back to TXT:', err);
      // Fallback: provide TXT immediately so user gets the content
      const fallbackName = `${suggestedBase}.txt`;
      const blob = new Blob([analysis], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fallbackName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      alert('Server download failed. Provided TXT version instead.');
    } finally {
      setBusy(false);
    }
  });
}

// Removed duplicate older definitions below to prevent UI conflicts. Single versions are defined above.

// ✅ Toggle the dropdown menu
function toggleDropdown() {
  const menu = document.getElementById("dropdownMenu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

// ✅ Handle voice file upload
function uploadVoiceFile() {
  const input = document.getElementById("voiceUpload");
  const file = input.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("audio", file);

  addMessage("📄 Summary will be generated...", "agent");

  fetch("http://localhost:5050/upload-voice", {
    method: "POST",
    body: formData
  })
  .then((res) => res.json())
  .then((data) => {
    if (data.voice_id) {
      // Now fetch summary from DB
      getVoiceSummaryFromDB(data.voice_id);
    } else {
      addMessage("❌ Voice upload failed: " + (data.error || "Unknown error"), "agent");
    }
  })
  .catch((err) => {
    addMessage("❌ Voice upload failed.", "agent");
    console.error(err);
  });

  input.value = "";
}

function getVoiceSummaryFromDB(voiceId) {
  fetch(`http://localhost:5050/voice-summary/${voiceId}`)
    .then(res => res.json())
    .then(data => {
      if (data.summary) {
        addMessage(`📄 Summary: ${data.summary}`, "agent");
      } else {
        addMessage("❌ Summary generation failed: " + (data.error || "Unknown error"), "agent");
      }
    })
    .catch(() => {
      addMessage("❌ Failed to fetch summary from DB.", "agent");
    });
}


// ...existing code...
if (voiceSummaryBtn) {
  voiceSummaryBtn.addEventListener('click', ()=>{
    if(!uploadedAudioBlob) return;
    voiceSummaryBtn.disabled = true;
    voiceSummaryBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Summarizing...';
    
    const formData = new FormData();
    formData.append("audio", uploadedAudioBlob);
    
    fetch("http://localhost:5050/upload-voice", {
      method: "POST",
      body: formData
    })
    .then((res) => res.json())
    .then((data) => {
      if (data.voice_id) {
        // Fetch summary from DB
        return fetch(`http://localhost:5050/voice-summary/${data.voice_id}`);
      } else {
        throw new Error(data.error || "Voice upload failed");
      }
    })
    .then(res => res.json())
    .then(data => {
      const summary = data.summary || `Audio summary for: ${uploadedAudioBlob.name}\n\n❌ Summary generation failed.`;
      const voiceSummaryText = document.getElementById('voiceSummaryText');
      if (voiceSummaryText) voiceSummaryText.value = summary;
    })
    .catch((err) => {
      const summary = `Audio summary for: ${uploadedAudioBlob.name}\n\n❌ ${err.message}`;
      const voiceSummaryText = document.getElementById('voiceSummaryText');
      if (voiceSummaryText) voiceSummaryText.value = summary;
    })
    .finally(() => {
      voiceSummaryBtn.disabled = false;
      voiceSummaryBtn.innerHTML = '<i class="fa-solid fa-align-left"></i> Generate Summary';
    });
  });
}

// Download logic for audio summary
const voiceDownloadBtn = document.getElementById('voiceDownloadBtn');
const voiceFormatSelect = document.getElementById('voiceFormatSelect');
if (voiceDownloadBtn) {
  voiceDownloadBtn.addEventListener('click', () => {
    const summary = document.getElementById('voiceSummaryText')?.value || '';
    if (!summary) return;
    const format = voiceFormatSelect?.value || 'txt';
    const filenameBase = uploadedAudioBlob?.name?.replace(/\.[^/.]+$/, '') || 'audio';
    const filename = `${filenameBase}-summary.${format}`;

    if (format === 'txt') {
      const blob = new Blob([summary], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } else {
      // For pdf/docx, request backend conversion
      fetch("http://localhost:5050/download-voice-summary", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ summary, format })
      })
      .then(async (response) => {
        if (!response.ok) throw new Error("❌ Download failed.");
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      })
      .catch((err) => {
        alert("❌ Error downloading file.");
      });
    }
  });
}


// For PDF Auto Fill Form
document.addEventListener('DOMContentLoaded', function() {
const uploadForm = document.getElementById('upload-form');
const pdfForm = document.getElementById('pdf-form');
const uploadSection = document.getElementById('upload-section');
const reviewSection = document.getElementById('review-section');
const successSection = document.getElementById('success-section');
const errorSection = document.getElementById('error-section');
const errorMessage = document.getElementById('error-message');
const fieldsContainer = document.getElementById('fields-container');
const templatePathField = document.getElementById('template_path');

// Upload form submit
uploadForm.addEventListener('submit', async (e) => {
     console.log('Form submit event triggered');
  e.preventDefault();
     console.log('Default prevented');
  
  // Hide upload section
    uploadSection.classList.add('hidden');
     console.log('Upload section hidden');
  
  // Show review section
    reviewSection.classList.remove('hidden');
     console.log('Review section shown');

  // Prevent scrolling when review form is open
  document.body.classList.add('review-open');
  
  // For demo purposes, populate with sample data
  // In a real application, you would send the form data to your backend
  fieldsContainer.innerHTML = `
    <div class="form-field">
      <label>Name</label>
      <input type="text" name="name" value="John Doe Email">
    </div>
    <div class="form-field">
      <label>Address</label>
      <input type="text" name="address" value="123 Main Street, City, Country">
    </div>
    <div class="form-field">
      <label>Dob</label>
      <input type="text" name="dob" value="">
    </div>
    <div class="form-field">
      <label>Email</label>
      <input type="text" name="email" value="john.doe@example.com">
    </div>
    <div class="form-field">
      <label>Employment</label>
      <input type="text" name="employment" value="Full time">
    </div>
    <div class="form-field">
      <label>Income</label>
      <input type="text" name="income" value="">
    </div>
    <div class="form-field">
      <label>Phonenumber</label>
      <input type="text" name="phonenumber" value="+1 234 567 890">
    </div>
  `;
});

// PDF generation form submit
pdfForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(pdfForm);

  try {
    const res = await fetch("/generate_pdf", { method: "POST", body: formData });
    const html = await res.text();
    if (html.includes("Download PDF")) {
      reviewSection.classList.add('hidden');
      successSection.classList.remove('hidden');
      
      // Re-enable scrolling when showing success section
      document.body.classList.remove('review-open');
    } else {
      showError("PDF generation failed.");
    }
  } catch (err) {
    showError("Error generating PDF.");
  }
});

// Error display helper
function showError(msg) {
  [uploadSection, reviewSection, successSection].forEach(el => el.classList.add('hidden'));
  errorSection.classList.remove('hidden');
  errorMessage.innerText = msg;
  
  // Re-enable scrolling when showing error
  document.body.classList.remove('review-open');
}

// Function to show upload form again
function showUploadForm() {
  reviewSection.classList.add('hidden');
  uploadSection.classList.remove('hidden');

  // Re-enable scrolling when returning to upload form
  document.body.classList.remove('review-open');
}

  // Make showUploadForm globally accessible
  window.showUploadForm = showUploadForm;
});



// This duplicate event listener has been removed to prevent conflicts




// for document drafting 
function closeDraftingResults() {
  document.getElementById('draftingResults').style.display = 'none';
}

function toggleDropdown() {
  const menu = document.getElementById("dropdownMenu");
  menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

function closeDraftingModal() {
  const modal = document.getElementById("draftingModal");
  modal.style.display = "none";
}

function showDraftingModal() {
  const modal = document.getElementById("draftingModal");
  modal.style.display = "block";
}

// 📤 Main upload + generate function
async function uploadFile() {
  const fileInput = document.getElementById("draftingFile");
  const file = fileInput.files[0];

  if (!file) {
    alert("Please select a file first.");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);

  // Show placeholder text while processing
  document.getElementById("coverLetter").value = "⏳ Generating cover letter...";
  document.getElementById("formData").value = "⏳ Extracting form data...";
  document.getElementById("supporting").value = "⏳ Creating supporting statement...";

  // Show results section
  document.getElementById("draftingResults").style.display = "block";

  try {
    const res = await axios.post("/generate-drafts", formData);
    const data = res.data;

    document.getElementById("coverLetter").value = data.cover_letter || "";
    document.getElementById("formData").value = data.form_data || "";
    document.getElementById("supporting").value = data.supporting || "";
  } catch (err) {
    console.error(err);
    alert("❌ Error: " + (err.response?.data?.error || err.message));
  }
}

async function downloadPDF(title, content) {
  if (!content.trim()) {
    alert("❌ Empty content!");
    return;
  }

  try {
    const res = await axios.post("/generate-pdf", { title, content });
    window.open(res.data.url, "_blank");
  } catch (err) {
    alert("❌ Failed to download PDF.");
  }
}

// ... existing code ...

// Analysis Panel Functions
function showAnalysisPanel(analysisText) {
  console.log('showAnalysisPanel called with:', analysisText);
  
  // Parse analysis text and populate sections
  const sections = parseAnalysisText(analysisText);
  console.log('Parsed sections:', sections);
  
  // Update modal analysis content
  const summaryEl = document.getElementById('modalAnalysisSummary');
  const missingEl = document.getElementById('modalAnalysisMissingClauses');
  const riskyEl = document.getElementById('modalAnalysisRiskyLanguage');
  const suggestionsEl = document.getElementById('modalAnalysisSuggestions');
  
  console.log('Modal elements found:', {
    summary: !!summaryEl,
    missing: !!missingEl,
    risky: !!riskyEl,
    suggestions: !!suggestionsEl
  });
  
  if (summaryEl) {
    const summaryContent = sections.summary || 'No summary available';
    summaryEl.textContent = summaryContent;
    console.log('Modal summary updated:', summaryContent.substring(0, 100) + '...');
  } else {
    console.error('Modal summary element not found!');
  }
  
  if (missingEl) {
    const missingContent = sections.missingClauses || 'No missing clauses identified';
    missingEl.textContent = missingContent;
    console.log('Modal missing clauses updated:', missingContent.substring(0, 100) + '...');
  } else {
    console.error('Modal missing clauses element not found!');
  }
  
  if (riskyEl) {
    const riskyContent = sections.riskyLanguage || 'No risky language identified';
    riskyEl.textContent = riskyContent;
    console.log('Modal risky language updated:', riskyContent.substring(0, 100) + '...');
  } else {
    console.error('Modal risky language element not found!');
  }
  
  if (suggestionsEl) {
    const suggestionsContent = sections.suggestions || 'No suggestions available';
    suggestionsEl.textContent = suggestionsContent;
    console.log('Modal suggestions updated:', suggestionsContent.substring(0, 100) + '...');
  } else {
    console.error('Modal suggestions element not found!');
  }
  
  // Show the analysis modal
  const analysisModal = document.getElementById('analysisModal');
  console.log('Looking for analysis modal element...');
  console.log('Modal element found:', !!analysisModal);
  
  if (analysisModal) {
    console.log('Found analysis modal, showing it...');
    console.log('Modal current classes:', analysisModal.className);
    console.log('Modal current style:', analysisModal.style.cssText);
    
    // Force remove hidden class and set display
    analysisModal.classList.remove('hidden');
    analysisModal.style.cssText = `
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: rgba(0, 0, 0, 0.5) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 10000 !important;
      opacity: 1 !important;
      visibility: visible !important;
    `;
    
    console.log('Modal style after update:', analysisModal.style.cssText);
    console.log('Modal classes after update:', analysisModal.className);
    
    // Add a small delay to ensure the modal is visible before adding the show class
    setTimeout(() => {
      analysisModal.classList.add('show');
      console.log('Modal show class added');
      console.log('Final modal state:', {
        display: analysisModal.style.display,
        visibility: analysisModal.style.visibility,
        opacity: analysisModal.style.opacity,
        classes: analysisModal.className
      });
    }, 10);
    console.log('Analysis modal displayed');
  } else {
    console.error('Analysis modal not found!');
  }
}

function closeAnalysisPanel() {
  // Hide analysis panel and expand table
  document.getElementById('analysisPanel').style.display = 'none';
  document.getElementById('casesTableSection').classList.remove('collapsed');
}

function closeAnalysisModal() {
  const analysisModal = document.getElementById('analysisModal');
  if (analysisModal) {
    console.log('Closing analysis modal...');
    analysisModal.classList.remove('show');
    // Add a small delay before hiding to allow the transition to complete
    setTimeout(() => {
      analysisModal.classList.add('hidden');
      analysisModal.style.display = 'none';
      console.log('Analysis modal hidden');
    }, 300);
    console.log('Analysis modal closed');
  }
}

// Add click outside to close functionality
document.addEventListener('DOMContentLoaded', function() {
  const analysisModal = document.getElementById('analysisModal');
  if (analysisModal) {
    analysisModal.addEventListener('click', function(e) {
      if (e.target === analysisModal) {
        closeAnalysisModal();
      }
    });
    
    // Add ESC key to close modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !analysisModal.classList.contains('hidden')) {
        closeAnalysisModal();
      }
    });
  }
});

function downloadAnalysisFromModal() {
  // Get the analysis content from the modal
  const summaryEl = document.getElementById('modalAnalysisSummary');
  const missingEl = document.getElementById('modalAnalysisMissingClauses');
  const riskyEl = document.getElementById('modalAnalysisRiskyLanguage');
  const suggestionsEl = document.getElementById('modalAnalysisSuggestions');
  
  if (!summaryEl || !missingEl || !riskyEl || !suggestionsEl) {
    alert('Analysis content not found.');
    return;
  }
  
  const analysisContent = `Document Analysis Results

1. Summary:
${summaryEl.textContent || 'No summary available'}

2. Missing Clauses:
${riskyEl.textContent || 'No missing clauses identified'}

3. Risky Language:
${riskyEl.textContent || 'No risky language identified'}

4. Suggestions:
${suggestionsEl.textContent || 'No suggestions available'}`;
  
  const blob = new Blob([analysisContent], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'document-analysis.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  window.URL.revokeObjectURL(url);
}

// Function to analyze case document and show modal
async function analyzeCaseDocument() {
  console.log('Analyze case document function called');
  
  // Prefer preview text if available; if not, require upload
  const caseFileInput = document.getElementById('caseFile');
  
  // Show loading state
  const analyzeBtn = document.getElementById('analyzeCaseBtn');
  const originalText = analyzeBtn.innerHTML;
  analyzeBtn.disabled = true;
  analyzeBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...';
  
  try {
    // Get the already extracted text from the preview field
    const previewField = document.getElementById('caseDocumentPreview');
    let combinedContent = '';
    
    if (previewField && previewField.value) {
      // Use the text that was already extracted and saved
      combinedContent = previewField.value || currentAnalysisText || '';
      console.log('Using saved text from preview field:', combinedContent.substring(0, 200) + '...');
    } else {
      // Fallback: Extract text from uploaded files if preview field is empty
      console.log('Preview field empty, extracting text from files...');
      
      for (let i = 0; i < caseFileInput.files.length; i++) {
        const file = caseFileInput.files[i];
        console.log('Processing case file for analysis:', file.name);
        
        // Create FormData for text extraction
        const formData = new FormData();
        formData.append('files[]', file);
        
        try {
          const response = await fetch('http://localhost:5050/upload', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          console.log('Text extraction response:', data);
          
          if (data.results) {
            const fileText = data.results.map(r => r.text || '').filter(Boolean).join('\n\n');
            combinedContent += fileText + '\n\n';
          }
        } catch (error) {
          console.error('Error extracting text from file:', error);
        }
      }
    }
    
    if (!combinedContent) {
      alert('No text content available for analysis. Please upload a document first.');
      return;
    }
    
    console.log('Analyzing case document content:', combinedContent.substring(0, 200) + '...');
    
    // Send to analysis endpoint
    // Extract case_id from form if available
    const caseIdEl = document.getElementById('caseId');
    const case_id = caseIdEl && caseIdEl.value ? parseInt(caseIdEl.value) : undefined;
    const analyzeResponse = await fetch("/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: combinedContent, case_id })
    });
    
    const analyzeData = await analyzeResponse.json();
    console.log('Analysis response:', analyzeData);
    
    if (analyzeData.analysis) {
      // Parse and display the analysis in the modal
      const sections = parseAnalysisText(analyzeData.analysis);
      console.log('Parsed sections for modal:', sections);
      
      // Update modal content
      const summaryEl = document.getElementById('modalAnalysisSummary');
      const missingEl = document.getElementById('modalAnalysisMissingClauses');
      const riskyEl = document.getElementById('modalAnalysisRiskyLanguage');
      const suggestionsEl = document.getElementById('modalAnalysisSuggestions');
      
      console.log('Modal elements found:', {
        summary: !!summaryEl,
        missing: !!missingEl,
        risky: !!riskyEl,
        suggestions: !!suggestionsEl
      });
      
      if (summaryEl) {
        const summaryContent = sections.summary || 'No summary available';
        summaryEl.innerHTML = renderAnalysisHtml(summaryContent);
        console.log('Summary updated with:', summaryContent.substring(0, 100) + '...');
      } else {
        console.error('Summary element not found!');
      }
      
      if (missingEl) {
        const missingContent = sections.missingClauses || 'No missing clauses identified';
        missingEl.innerHTML = renderAnalysisHtml(missingContent);
        console.log('Missing clauses updated with:', missingContent.substring(0, 100) + '...');
      } else {
        console.error('Missing clauses element not found!');
      }
      
      if (riskyEl) {
        const riskyContent = sections.riskyLanguage || 'No risky language identified';
        riskyEl.innerHTML = renderAnalysisHtml(riskyContent);
        console.log('Risky language updated with:', riskyContent.substring(0, 100) + '...');
      } else {
        console.error('Risky language element not found!');
      }
      
      if (suggestionsEl) {
        const suggestionsContent = sections.suggestions || 'No suggestions available';
        suggestionsEl.innerHTML = renderAnalysisHtml(suggestionsContent);
        console.log('Suggestions updated with:', suggestionsContent.substring(0, 100) + '...');
      } else {
        console.error('Suggestions element not found!');
      }
      
      // Show the modal
      const analysisModal = document.getElementById('analysisModal');
      if (analysisModal) {
        console.log('Found analysis modal, showing case analysis results...');
        
        // Force remove hidden class and set display
        analysisModal.classList.remove('hidden');
        analysisModal.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100% !important;
          height: 100% !important;
          background: rgba(0, 0, 0, 0.5) !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          z-index: 10000 !important;
          opacity: 1 !important;
          visibility: visible !important;
        `;
        
        // Add a small delay to ensure the modal is visible before adding the show class
        setTimeout(() => {
          analysisModal.classList.add('show');
          console.log('Case analysis modal show class added');
        }, 10);
        console.log('Case analysis modal displayed with real content');
      } else {
        console.error('Analysis modal not found!');
      }
    } else {
      alert('Analysis failed. Please try again.');
    }
    
  } catch (error) {
    console.error('Error during case analysis:', error);
    alert('Error during analysis: ' + error.message);
  } finally {
    // Restore button state
    analyzeBtn.disabled = false;
    analyzeBtn.innerHTML = originalText;
  }
}



// Test function to manually trigger the modal with real document analysis
async function testModal() {
  console.log('Test modal function called');
  
  // Check if there are uploaded files
  const uploadedFiles = [...(uploadedDocumentFiles || []), ...(uploadedCaseFiles || [])];
  
  if (uploadedFiles.length === 0) {
    alert('Please upload a document first before testing the analysis modal.');
    return;
  }
  
  // Show loading state
  const testBtn = document.getElementById('testModalBtn');
  const originalText = testBtn.innerHTML;
  testBtn.disabled = true;
  testBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...';
  
  try {
    // Extract text from uploaded files
    let combinedContent = '';
    
    for (const file of uploadedFiles) {
      console.log('Processing file for analysis:', file.name);
      
      // Create FormData for text extraction
      const formData = new FormData();
      formData.append('files[]', file);
      
      try {
        const response = await fetch('http://localhost:5050/upload', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        console.log('Text extraction response:', data);
        
        if (data.results) {
          const fileText = data.results.map(r => r.text || '').filter(Boolean).join('\n\n');
          combinedContent += fileText + '\n\n';
        }
      } catch (error) {
        console.error('Error extracting text from file:', error);
      }
    }
    
    if (!combinedContent) {
      alert('No text content could be extracted from the uploaded files.');
      return;
    }
    
    console.log('Analyzing combined content:', combinedContent.substring(0, 200) + '...');
    
    // Send to analysis endpoint
    const analyzeResponse = await fetch("http://localhost:5050/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: combinedContent })
    });
    
    const analyzeData = await analyzeResponse.json();
    console.log('Analysis response:', analyzeData);
    
    if (analyzeData.analysis) {
      // Parse and display the analysis in the modal
      const sections = parseAnalysisText(analyzeData.analysis);
      
      // Update modal content
      const summaryEl = document.getElementById('modalAnalysisSummary');
      const missingEl = document.getElementById('modalAnalysisMissingClauses');
      const riskyEl = document.getElementById('modalAnalysisRiskyLanguage');
      const suggestionsEl = document.getElementById('modalAnalysisSuggestions');
      
      if (summaryEl) summaryEl.textContent = sections.summary || 'No summary available';
      if (missingEl) missingEl.textContent = sections.missingClauses || 'No missing clauses identified';
      if (riskyEl) riskyEl.textContent = sections.riskyLanguage || 'No risky language identified';
      if (suggestionsEl) suggestionsEl.textContent = sections.suggestions || 'No suggestions available';
      
      // Show the modal
      const analysisModal = document.getElementById('analysisModal');
      if (analysisModal) {
        console.log('Found analysis modal, showing analysis results...');
        
        // Force remove hidden class and set display
        analysisModal.classList.remove('hidden');
        analysisModal.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100% !important;
          height: 100% !important;
          background: rgba(0, 0, 0, 0.5) !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          z-index: 10000 !important;
          opacity: 1 !important;
          visibility: visible !important;
        `;
        
        // Add a small delay to ensure the modal is visible before adding the show class
        setTimeout(() => {
          analysisModal.classList.add('show');
          console.log('Analysis modal show class added');
        }, 10);
        console.log('Analysis modal displayed with real content');
      } else {
        console.error('Analysis modal not found!');
      }
    } else {
      alert('Analysis failed. Please try again.');
    }
    
  } catch (error) {
    console.error('Error during test analysis:', error);
    alert('Error during analysis: ' + error.message);
  } finally {
    // Restore button state
    testBtn.disabled = false;
    testBtn.innerHTML = originalText;
  }
}



async function handleCaseFileSelection() {
  const fileInput = document.getElementById('caseFile');
  const previewField = document.getElementById('caseDocumentPreview');
  const analyzeBtn = document.getElementById('analyzeCaseBtn');
  
  if (!fileInput || !fileInput.files.length || !previewField) return;
  
  console.log('Handling case file selection...');
  // Reset any previously selected case files and preview to avoid mixing documents
  uploadedCaseFiles = Array.from(fileInput.files);
  previewField.value = '⏳ Extracting text...';
  let combinedContent = '';
  
  for (let i = 0; i < fileInput.files.length; i++) {
    const file = fileInput.files[i];
    console.log('Processing file:', file.name);
    
    // Create FormData for text extraction
    const formData = new FormData();
    formData.append('files[]', file);
    
    try {
      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      console.log('Text extraction response:', data);
      
      if (data.results) {
        const fileText = data.results.map(r => r.text || '').filter(Boolean).join('\n\n');
        combinedContent += fileText + '\n\n';
      }
    } catch (error) {
      console.error('Error extracting text from file:', error);
    }
  }
  
  // Client-side fallback for plain text files if server returned empty
  if (!combinedContent) {
    try {
      for (let i = 0; i < fileInput.files.length; i++) {
        const file = fileInput.files[i];
        const name = (file.name || '').toLowerCase();
        const isPlain = file.type.startsWith('text/') || /\.(txt|md|csv|log|json|html?)$/.test(name);
        if (isPlain && typeof file.text === 'function') {
          const txt = await file.text();
          if (txt && txt.trim()) {
            combinedContent += txt + '\n\n';
          }
        }
      }
    } catch (e) {
      console.warn('Plain-text fallback failed:', e);
    }
  }
  
  if (combinedContent) {
    previewField.value = combinedContent;
    currentAnalysisText = combinedContent;
    console.log('Case preview field updated with extracted text');
    // Show analyze button when we have text
    const analyzeBtn = document.getElementById('analyzeCaseBtn');
    if (analyzeBtn) analyzeBtn.style.display = 'inline-block';
  }
  else {
    previewField.value = '⚠️ No text extracted from the selected file(s).\n\nTips:\n• Try a TXT/DOCX/PDF with readable text (not scanned images).\n• For images, ensure Tesseract OCR is installed and configured.\n• Check /upload response in Network tab for errors.';
    console.warn('No text extracted from selected files.');
    const analyzeBtn = document.getElementById('analyzeCaseBtn');
    if (analyzeBtn) analyzeBtn.style.display = 'none';
  }

  // Show selected file names under the upload field
  const nameEl = document.getElementById('caseSelectedName');
  if (nameEl) {
    const names = Array.from(fileInput.files).map(f => f.name).join(', ');
    nameEl.textContent = names ? ('Selected: ' + names) : '';
  }
  // Re-enable analyze button if it exists
  if (analyzeBtn) analyzeBtn.disabled = !combinedContent;
}

function parseAnalysisText(text) {
  const sections = {
    summary: '',
    missingClauses: '',
    riskyLanguage: '',
    suggestions: ''
  };
  
  if (!text) return sections;
  
  console.log('Parsing analysis text:', text.substring(0, 200) + '...');
  
  // Split text into lines and parse sections
  const lines = text.split('\n');
  let currentSection = '';
  
  for (const line of lines) {
    const trimmedLine = line.trim();
    
    // Check for section headers
    if (trimmedLine.toLowerCase().includes('summary') || 
        trimmedLine.toLowerCase().includes('1.') ||
        trimmedLine.toLowerCase().includes('**summary**')) {
      currentSection = 'summary';
      console.log('Found summary section');
    } else if (trimmedLine.toLowerCase().includes('missing') || 
               trimmedLine.toLowerCase().includes('clauses') || 
               trimmedLine.toLowerCase().includes('2.') ||
               trimmedLine.toLowerCase().includes('**missing**')) {
      currentSection = 'missingClauses';
      console.log('Found missing clauses section');
    } else if (trimmedLine.toLowerCase().includes('risky') || 
               trimmedLine.toLowerCase().includes('unclear') || 
               trimmedLine.toLowerCase().includes('3.') ||
               trimmedLine.toLowerCase().includes('**risky**')) {
      currentSection = 'riskyLanguage';
      console.log('Found risky language section');
    } else if (trimmedLine.toLowerCase().includes('suggestions') || 
               trimmedLine.toLowerCase().includes('improvement') || 
               trimmedLine.toLowerCase().includes('4.') ||
               trimmedLine.toLowerCase().includes('**suggestions**')) {
      currentSection = 'suggestions';
      console.log('Found suggestions section');
    } else if (trimmedLine && currentSection) {
      // Add content to current section
      if (sections[currentSection]) {
        sections[currentSection] += '\n' + trimmedLine;
      } else {
        sections[currentSection] = trimmedLine;
      }
    }
  }
  
  // If no sections were found, try to split the text differently
  if (!sections.summary && !sections.missingClauses && !sections.riskyLanguage && !sections.suggestions) {
    console.log('No sections found, trying alternative parsing...');
    
    // Split by common patterns
    const parts = text.split(/(?=1\.|2\.|3\.|4\.|Summary|Missing|Risky|Suggestions)/i);
    
    if (parts.length >= 2) {
      sections.summary = parts[1] || 'Summary content not found';
      if (parts.length >= 3) sections.missingClauses = parts[2] || 'Missing clauses not found';
      if (parts.length >= 4) sections.riskyLanguage = parts[3] || 'Risky language not found';
      if (parts.length >= 5) sections.suggestions = parts[4] || 'Suggestions not found';
    } else {
      // If still no sections, just put everything in summary
      sections.summary = text;
    }
  }
  
  console.log('Parsed sections:', sections);
  return sections;
}

// Render analysis text with headings bold and bullets parsed
function renderAnalysisHtml(raw) {
  if (!raw) return '';
  // Normalize line breaks
  let text = String(raw).replace(/\r\n?/g, '\n');
  const lines = text.split('\n');
  let html = '';
  let inUl = false;
  const flushUl = () => { if (inUl) { html += '</ul>'; inUl = false; } };
  const esc = (s) => s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  for (let line of lines) {
    const t = line.trim();
    if (!t) { flushUl(); html += '<p></p>'; continue; }
    // Markdown-style bullets -> <li>
    if (/^[-*•]\s+/.test(t)) {
      if (!inUl) { flushUl(); html += '<ul>'; inUl = true; }
      html += '<li>' + esc(t.replace(/^[-*•]\s+/, '')) + '</li>';
      continue;
    }
    // Headings patterns
    if (/^(\d+\.|summary|missing clauses|risky( or unclear)? language|suggestions)[:\s]/i.test(t)) {
      flushUl();
      const title = t.replace(/^\d+\.\s*/, '').replace(/\*\*/g, '').replace(/:$/, '');
      html += '<h4>' + esc(title) + '</h4>';
      continue;
    }
    // Remove leading **bold** markers from content lines but keep text
    const cleaned = t.replace(/^\*\*([^*]+)\*\*:?\s*/g, '$1: ');
    flushUl();
    html += '<p>' + esc(cleaned) + '</p>';
  }
  flushUl();
  return html;
}

function downloadAnalysis() {
  const analysisText = document.getElementById('docSummaryText').value;
  if (!analysisText.trim()) {
    alert('No analysis content to download.');
    return;
  }
  
  const blob = new Blob([analysisText], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'document-analysis.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  window.URL.revokeObjectURL(url);
}

function renderFormattedSummary(raw) {
  if (!raw) return '';
  let html = raw.trim();
  // Normalize line endings
  html = html.replace(/\r\n?/g, '\n');
  // Headings like **1. Title:** -> <h3>1. Title</h3>
  html = html.replace(/\*\*\s*(\d+\.[^*\n:]+):?\s*\*\*/g, '<h3>$1</h3>');
  // Bold **text**
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  // Simple plain headings at line start (Summary:, Key Points:, etc.)
  html = html.replace(/^\s*(Summary|Key Points|Conclusion|Findings|Missing Clauses|Risky or Unclear Language|Suggestions for Improvement)\s*:\s*$/gim, (_m, h) => `<h3>${h}</h3>`);
  // Convert bullet lines starting with * or - to list items
  const lines = html.split('\n');
  const out = [];
  let inUl = false; let inOl = false;
  const flushLists = () => {
    if (inUl) { out.push('</ul>'); inUl = false; }
    if (inOl) { out.push('</ol>'); inOl = false; }
  };
  const normalizeHeading = (s) => s
      .replace(/^['"()]+|['"()]+$/g, '') // trim quotes/parens
      .replace(/^\d+\.\s*/, '')        // drop leading numbering
      .replace(/:$/, '')                  // drop trailing colon
      .trim();
  const isKnownHeading = (s) => {
    const h = normalizeHeading(s).toLowerCase();
    return h === 'summary' || h === 'any missing clauses' || h === 'missing clauses' || h === 'risky or unclear language' || h === 'suggestions for improvement' || h === 'analysis' || h === 'recommendations';
  };
  for (const line of lines) {
    const trimmed = line.trim();
    // Numeric headings like "1. Summary"
    if (/^\d+\.\s+/.test(trimmed)) {
      flushLists();
      out.push('<h3>' + normalizeHeading(trimmed) + '</h3>');
      continue;
    }
    // Known headings (robust)
    if (isKnownHeading(trimmed)) {
      flushLists();
      out.push('<h3>' + normalizeHeading(trimmed) + '</h3>');
      continue;
    }
    if (/^[-*]\s+/.test(trimmed)) {
      if (!inUl) { flushLists(); out.push('<ul>'); inUl = true; }
      out.push('<li>' + trimmed.replace(/^[-*]\s+/, '') + '</li>');
    } else if (/^•\s+/.test(trimmed)) {
      if (!inUl) { flushLists(); out.push('<ul>'); inUl = true; }
      out.push('<li>' + trimmed.replace(/^•\s+/, '') + '</li>');
    } else if (/^\d+\.\s+/.test(trimmed)) {
      if (!inOl) { flushLists(); out.push('<ol>'); inOl = true; }
      out.push('<li>' + trimmed.replace(/^\d+\.\s+/, '') + '</li>');
    } else if (trimmed.length === 0) {
      flushLists();
      out.push('<p></p>');
    } else if (/^---+$/.test(trimmed)) {
      flushLists();
      out.push('<hr/>');
    } else {
      flushLists();
      // Headings with trailing colon at start of line
      const m = trimmed.match(/^([A-Z][A-Za-z0-9 ,\"'()\-]+):$/);
      if (m) {
        out.push('<h3>' + m[1] + '</h3>');
      } else {
        out.push('<p>' + trimmed + '</p>');
      }
    }
  }
  flushLists();
  return out.join('\n');
}

// Render formatting directly into textarea when needed (no double summary box)
function updateSummaryRender() {
  // Intentionally left minimal since we keep plain textarea only now
}






</script>
</script>
<script>
  (function(){
    const second = document.getElementById('secondSidebar');
    const btn = document.getElementById('toggleSecondBtn');
    const main = document.querySelector('.main');
    if (!second || !btn || !main) return;

    function setCollapsed(collapsed){
      if (collapsed){
        second.classList.add('collapsed');
        main.style.marginLeft = '16px';
        btn.innerText = '⟩';
      } else {
        second.classList.remove('collapsed');
        main.style.marginLeft = '0';
        btn.innerText = '⟨⟩';
      }
    }

    let collapsed = false;
    btn.addEventListener('click', function(){
      collapsed = !collapsed;
      setCollapsed(collapsed);
    });
  })();

  // Show selected file name under drafting upload box
  (function(){
    const input = document.getElementById('draftingFile');
    const label = document.getElementById('draftingSelectedName');
    if (!input || !label) return;
    input.addEventListener('change', function(){
      const file = input.files && input.files[0];
      if (file){
        label.textContent = 'Selected: ' + file.name;
        label.style.display = 'block';
      } else {
        label.textContent = '';
        label.style.display = 'none';
      }
    });
  })();



  // Show drafting panel
  function showDraftingPanel() {
    // Hide welcome screen
    const welcomeScreen = document.getElementById('welcomeScreen');
    if (welcomeScreen) {
      welcomeScreen.style.display = 'none';
    }
    
    // Hide all other panels
    document.querySelectorAll('.chat-panel').forEach(panel => {
      panel.style.display = 'none';
    });
    
    // Show drafting panel
    const draftingPanel = document.getElementById('draftingPanel');
    if (draftingPanel) {
      draftingPanel.style.display = 'block';
    }
  }



// case






// ==================== CASE PANEL ====================

// Helper
function hideAllPanels() {
  document.querySelectorAll(".chat-panel").forEach(p => p.style.display = "none");
}

// CASE FUNCTIONS
function openCasePanel() {
  hideAllPanels();
  document.getElementById("casePanel").style.display = "flex";
  loadCases();
}

function openCaseForm(caseData = null) {
  const modal = document.getElementById("caseModal");
  modal.style.display = "flex";
  modal.classList.remove("hidden");

  if (caseData) {
    document.getElementById("caseModalTitle").innerText = "Edit Case";
    document.getElementById("caseId").value = caseData.id || "";
    document.getElementById("caseName").value = caseData.name || "";
    document.getElementById("caseType").value = caseData.case_type || "";
    document.getElementById("caseStatus").value = caseData.status || "";
    document.getElementById("casePriority").value = caseData.priority || "";
    document.getElementById("openedDate").value = caseData.opened_date || "";
    document.getElementById("closedDate").value = caseData.closed_date || "";
    document.getElementById("dueDate").value = caseData.due_date || "";
    document.getElementById("courtName").value = caseData.court || "";
    document.getElementById("hearingDate").value = caseData.hearing_date || "";
    document.getElementById("judgeName").value = caseData.judge_name || "";
    document.getElementById("caseCategory").value = caseData.case_category || "";
    document.getElementById("jurisdiction").value = caseData.jurisdiction || "";
    document.getElementById("caseFee").value = caseData.case_fee || "";
    document.getElementById("billingStatus").value = caseData.billing_status || "";
    document.getElementById("customerId").value = caseData.customer_id || "";
    document.getElementById("caseDocumentType").value = caseData.document_type || "";
    document.getElementById("caseDescription").value = caseData.description || "";
    document.getElementById("caseDocumentPreview").value = caseData.document_preview || "";
    document.getElementById("caseSubmitBtn").innerText = "Update";
  } else {
    document.getElementById("caseModalTitle").innerText = "Add New Case";
    document.getElementById("caseForm").reset();
    document.getElementById("caseSubmitBtn").innerText = "Submit";
  }
}

function closeCaseForm() {
  const modal = document.getElementById("caseModal");
  modal.style.display = "none";
  modal.classList.add("hidden");
}

async function loadCases() {
  const tbody = document.getElementById("caseTableBody");
  if (!tbody) {
    console.error("Case table body not found!");
    return;
  }
  
  tbody.innerHTML = "";
  console.log("Loading cases...");
  
  try {
    let res = await fetch("http://127.0.0.1:5050/cases"); // Flask backend
    console.log("Response status:", res.status);
    
    if (!res.ok) {
      console.error("Failed to fetch cases. Status:", res.status);
      const errorText = await res.text();
      console.error("Error response:", errorText);
      return;
    }
    
    let data = await res.json();
    console.log("Cases data received:", data);
    console.log("Number of cases:", data.length);
    
    window.__cases = data;
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No cases found</td></tr>';
      return;
    }
    
    data.forEach((c, index) => {
      console.log(`Processing case ${index + 1}:`, c);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.name || 'N/A'}</td>
        <td>${c.status || 'N/A'}</td>
        <td>${c.case_type || '-'}</td>
        <td>${c.document_type || '-'}</td>
        <td>${c.due_date || '-'}</td>
        <td>${c.court || '-'}</td>
        <td>
          <button onclick='openCaseForm(${JSON.stringify(c)})' class="action-btn edit-btn" title="Edit">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <button onclick='deleteCase(${c.id})' class="action-btn delete-btn" title="Delete">
            <i class="fa-solid fa-trash"></i>
          </button>
        </td>`;
      tbody.appendChild(tr);
    });
    
    console.log("Cases loaded successfully");
  } catch (err) {
    console.error("Failed to load cases:", err);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ff0000;">Error loading cases. Please check console for details.</td></tr>';
  }
}

function filterCases(){
  const q = (document.getElementById('caseSearch')?.value || '').toLowerCase();
  const tbody = document.getElementById('caseTableBody');
  if(!tbody) return;
  const src = window.__cases || [];
  tbody.innerHTML = '';
  src.filter(c => {
    const text = [c.name, c.status, c.case_type, c.document_type, c.due_date, c.court]
      .map(v => (v||'').toString().toLowerCase()).join(' ');
    return text.includes(q);
  }).forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.name}</td>
      <td>${c.status}</td>
      <td>${c.case_type || '-'}</td>
      <td>${c.document_type || '-'}</td>
      <td>${c.due_date || '-'}</td>
      <td>${c.court || '-'}</td>
      <td>
        <button onclick='openCaseForm(${JSON.stringify(c)})' class="action-btn edit-btn" title="Edit">
          <i class="fa-solid fa-pen-to-square"></i>
        </button>
        <button onclick='deleteCase(${c.id})' class="action-btn delete-btn" title="Delete">
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// CUSTOMER FUNCTIONS
function openCustomerPanel() {
  hideAllPanels();
  document.getElementById("customerPanel").style.display = "flex";
  loadCustomers();
}

function openCustomerForm(customerData = null) {
  const modal = document.getElementById("customerModal");
  modal.style.display = "flex";
  modal.classList.remove("hidden");

  if (customerData) {
    document.getElementById("customerModalTitle").innerText = "Edit Customer";
    document.getElementById("customerId").value = customerData.id || "";
    document.getElementById("customerName").value = customerData.name || "";
    document.getElementById("customerPhone").value = customerData.phone || "";
    document.getElementById("customerEmail").value = customerData.email || "";
    document.getElementById("customerCNIC").value = customerData.cnic || "";
    document.getElementById("customerDOB").value = customerData.dob || "";
    document.getElementById("customerGender").value = customerData.gender || "";
    document.getElementById("customerOccupation").value = customerData.occupation || "";
    document.getElementById("customerCompany").value = customerData.company_name || "";
    document.getElementById("customerEmergencyName").value = customerData.emergency_contact_name || "";
    document.getElementById("customerEmergencyPhone").value = customerData.emergency_contact_phone || "";
    document.getElementById("customerAddress").value = customerData.address || "";
    document.getElementById("customerContactInfo").value = customerData.contact_info || "";
    document.getElementById("customerNotes").value = customerData.notes || "";
    document.getElementById("customerDocumentType").value = customerData.document_type || "";
    document.getElementById("customerSubmitBtn").innerText = "Update";
  } else {
    document.getElementById("customerModalTitle").innerText = "Add New Customer";
    document.getElementById("customerForm").reset();
    document.getElementById("customerSubmitBtn").innerText = "Submit";
  }
}

function closeCustomerForm() {
  const modal = document.getElementById("customerModal");
  modal.style.display = "none";
  modal.classList.add("hidden");
}

async function loadCustomers() {
  const tbody = document.getElementById("customerTableBody");
  if (!tbody) {
    console.error("Customer table body not found!");
    return;
  }
  
  tbody.innerHTML = "";
  console.log("Loading customers...");
  
  try {
    let res = await fetch("http://127.0.0.1:5050/customers");
    console.log("Customer response status:", res.status);
    
    if (!res.ok) {
      console.error("Failed to fetch customers. Status:", res.status);
      const errorText = await res.text();
      console.error("Customer error response:", errorText);
      return;
    }
    
    let data = await res.json();
    console.log("Customers data received:", data);
    console.log("Number of customers:", data.length);
    
    window.__customers = data;
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No customers found</td></tr>';
      return;
    }
    
    data.forEach((c, index) => {
      console.log(`Processing customer ${index + 1}:`, c);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.name || 'N/A'}</td>
        <td>${c.phone || '-'}</td>
        <td>${c.email || '-'}</td>
        <td>${c.cnic || '-'}</td>
        <td>${c.occupation || '-'}</td>
        <td>${c.company_name || '-'}</td>
        <td>
          <button onclick='openCustomerForm(${JSON.stringify(c)})' class="action-btn edit-btn" title="Edit">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <button onclick='deleteCustomer(${c.id})' class="action-btn delete-btn" title="Delete">
            <i class="fa-solid fa-trash"></i>
          </button>
        </td>`;
      tbody.appendChild(tr);
    });
    
    console.log("Customers loaded successfully");
  } catch (err) {
    console.error("Failed to load customers:", err);
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ff0000;">Error loading customers. Please check console for details.</td></tr>';
  }
}

function filterCustomers(){
  const q = (document.getElementById('customerSearch')?.value || '').toLowerCase();
  const tbody = document.getElementById('customerTableBody');
  if(!tbody) return;
  const src = window.__customers || [];
  tbody.innerHTML = '';
  src.filter(c => {
    const text = [c.name, c.phone, c.email, c.cnic, c.occupation, c.company_name]
      .map(v => (v||'').toString().toLowerCase()).join(' ');
    return text.includes(q);
  }).forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.name}</td>
      <td>${c.phone || '-'}</td>
      <td>${c.email || '-'}</td>
      <td>${c.cnic || '-'}</td>
      <td>${c.occupation || '-'}</td>
      <td>${c.company_name || '-'}</td>
      <td>
        <button onclick='openCustomerForm(${JSON.stringify(c)})' class="action-btn edit-btn" title="Edit">
          <i class="fa-solid fa-pen-to-square"></i>
        </button>
        <button onclick='deleteCustomer(${c.id})' class="action-btn delete-btn" title="Delete">
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// Attach button listeners safely
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("addCaseBtn").addEventListener("click", () => openCaseForm());
  document.getElementById("addCustomerBtn").addEventListener("click", () => openCustomerForm());
  
  // Add form submit event listeners
  document.getElementById("caseForm").addEventListener("submit", saveCase);
  document.getElementById("customerForm").addEventListener("submit", saveCustomer);
});



async function saveCase(event) {
  event.preventDefault();
  
  try {
  const caseData = {
    name: document.getElementById("caseName").value,
    description: document.getElementById("caseDescription").value,
    type: document.getElementById("caseType").value,
    status: document.getElementById("caseStatus").value,
    priority: document.getElementById("casePriority").value,
    upload_file: document.getElementById("caseFile").files.length > 0 ? document.getElementById("caseFile").files[0].name : null,
    opened_date: document.getElementById("openedDate").value || null,
    closed_date: document.getElementById("closedDate").value || null,
    due_date: document.getElementById("dueDate").value || null,
    court: document.getElementById("courtName").value,
    hearing_date: document.getElementById("hearingDate").value || null,
    judge: document.getElementById("judgeName").value,
    category: document.getElementById("caseCategory").value,
    jurisdiction: document.getElementById("jurisdiction").value,
    fee: document.getElementById("caseFee").value ? parseFloat(document.getElementById("caseFee").value) : null,
    billing_status: document.getElementById("billingStatus").value,
    customer_id: parseInt(document.getElementById("customerId").value),
    document_type: document.getElementById("caseDocumentType").value,
    document_preview: document.getElementById("caseDocumentPreview").value || null
    };

    // Check if this is an update or new case
    const caseId = document.getElementById("caseId").value;
    const isUpdate = caseId && caseId.trim() !== "";
    
    const url = isUpdate ? `http://127.0.0.1:5050/cases/${caseId}` : "http://127.0.0.1:5050/cases";
    const method = isUpdate ? "PUT" : "POST";

    const response = await fetch(url, {
    method: method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(caseData)
  });

    if (response.ok) {
      const result = await response.json();
      const caseId = isUpdate ? document.getElementById("caseId").value : result.id;
      
      // Handle file uploads if any files are selected
      const caseFileInput = document.getElementById("caseFile");
      if (caseFileInput && caseFileInput.files.length > 0) {
        const formData = new FormData();
        formData.append('case_id', caseId);
        
        for (let i = 0; i < caseFileInput.files.length; i++) {
          formData.append('files[]', caseFileInput.files[i]);
        }
        
        try {
          const fileResponse = await fetch("http://127.0.0.1:5050/upload-case-files", {
            method: "POST",
            body: formData
          });
          
          if (fileResponse.ok) {
            const fileResult = await fileResponse.json();
            console.log("Files uploaded successfully:", fileResult);
            
            // Extract text from uploaded files for analysis
            let combinedContent = '';
            let summaryTitle = '';
            
            // The upload-case-files endpoint already extracts text, so we can use the response
            if (fileResult.results) {
              console.log('Using extracted text from upload-case-files response');
              
              for (const result of fileResult.results) {
                if (result.text) {
                  combinedContent += `FILE: ${result.filename}\n${result.text}\n\n`;
                  if (summaryTitle) summaryTitle += ' + ';
                  summaryTitle += result.filename;
                  console.log('Added text from file:', result.filename);
                }
              }
            } else {
              console.log('No text extracted from upload-case-files, trying manual extraction');
              
              // Fallback: Process each uploaded file manually
              for (let i = 0; i < caseFileInput.files.length; i++) {
                const file = caseFileInput.files[i];
                console.log('Processing file for analysis:', file.name);
                
                // Create FormData for text extraction
                const extractFormData = new FormData();
                extractFormData.append('files[]', file);
                
                try {
                  const extractResponse = await fetch('http://localhost:5050/upload', {
                    method: 'POST',
                    body: extractFormData
                  });
                  
                  const extractData = await extractResponse.json();
                  console.log('Text extraction response:', extractData);
                  
                                  if (extractData.results) {
                  const fileText = extractData.results.map(r => r.text || '').filter(Boolean).join('\n\n');
                  combinedContent += fileText + '\n\n';
                  if (summaryTitle) summaryTitle += ' + ';
                  summaryTitle += file.name;
                }
                } catch (extractError) {
                  console.error('Error extracting text from file:', extractError);
                }
              }
            }
            
            // Analyze the extracted content
            if (combinedContent) {
              console.log('Analyzing combined content:', combinedContent.substring(0, 200) + '...');
              
              const analyzeResponse = await fetch("http://localhost:5050/analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: combinedContent })
              });
              
              const analyzeData = await analyzeResponse.json();
              console.log('Analysis response:', analyzeData);
              
              if (analyzeData.analysis) {
                // Show analysis panel with results
                console.log('About to call showAnalysisPanel with:', analyzeData.analysis.substring(0, 200) + '...');
                showAnalysisPanel(analyzeData.analysis);
                
                // Also update the document preview for the agent
                const previewText = document.getElementById('docPreviewText');
                if (previewText) {
                  previewText.value = combinedContent;
                  console.log('Document preview updated for agent');
                }
                
                // Store the document content globally for the agent
                window.documentText = combinedContent;
                window.caseText = combinedContent;
                
                // Also store in localStorage for persistence
                try {
                  localStorage.setItem('currentDocumentContent', combinedContent);
                  console.log('Document content saved to localStorage');
                } catch (e) {
                  console.error('Error saving to localStorage:', e);
                }
                
                // Update the case form preview field
                const casePreviewField = document.getElementById('caseDocumentPreview');
                if (casePreviewField) {
                  casePreviewField.value = combinedContent;
                  console.log('Case form preview field updated');
                }
                
                console.log('Analysis completed and panel shown');
                console.log('Document content stored for agent:', combinedContent.substring(0, 200) + '...');
                
                // Show a notification that analysis is complete
                setTimeout(() => {
                  const notification = document.createElement('div');
                  notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                  `;
                  notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <i class="fa-solid fa-check-circle"></i>
                      <div>
                        <div style="font-weight: 600;">Document Analysis Complete!</div>
                        <div style="font-size: 14px; opacity: 0.9;">Analysis modal is now displayed.</div>
                      </div>
                    </div>
                  `;
                  document.body.appendChild(notification);
                  
                  // Remove notification after 5 seconds
                  setTimeout(() => {
                    if (notification.parentNode) {
                      notification.parentNode.removeChild(notification);
                    }
                  }, 5000);
                }, 1000);
              } else {
                console.error('Analysis failed:', analyzeData);
              }
            }
            
          } else {
            console.error("Error uploading files:", await fileResponse.text());
          }
        } catch (fileError) {
          console.error("Error uploading files:", fileError);
        }
      }
      
      if (caseFileInput && caseFileInput.files.length > 0) {
        alert(isUpdate ? "Case updated successfully! Document analysis has been performed and is displayed in a modal." : "Case uploaded successfully! Document analysis has been performed and is displayed in a modal.");
      } else {
      alert(isUpdate ? "Case updated successfully!" : "Case uploaded successfully!");
      }
  closeCaseForm();
  loadCases();
    } else {
      const error = await response.json();
      alert("Error saving case: " + error.error);
    }
  } catch (error) {
    console.error("Error saving case:", error);
    alert("Error saving case. Please try again.");
  }
}


async function deleteCase(caseId) {
  if (confirm('Are you sure you want to delete this case?')) {
    try {
      const response = await fetch(`http://127.0.0.1:5050/cases/${caseId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        alert('Case deleted successfully!');
        loadCases();
      } else {
        alert('Error deleting case');
      }
    } catch (error) {
      console.error('Error deleting case:', error);
      alert('Error deleting case');
    }
  }
}

async function deleteCustomer(customerId) {
  if (confirm('Are you sure you want to delete this customer?')) {
    try {
      const response = await fetch(`http://127.0.0.1:5050/customers/${customerId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        alert('Customer deleted successfully!');
        loadCustomers();
      } else {
        alert('Error deleting customer');
      }
    } catch (error) {
      console.error('Error deleting customer:', error);
      alert('Error deleting customer');
    }
  }
}

async function saveCustomer(event) {
  event.preventDefault();
  
  try {
  const customerData = {
    name: document.getElementById("customerName").value,
    contact_info: document.getElementById("customerContactInfo").value,
    phone: document.getElementById("customerPhone").value,
    email: document.getElementById("customerEmail").value,
    address: document.getElementById("customerAddress").value,
    profile_file: document.getElementById("customerFile").files.length > 0 ? document.getElementById("customerFile").files[0].name : null,
    date_of_birth: document.getElementById("customerDOB").value || null,
    gender: document.getElementById("customerGender").value,
    cnic: document.getElementById("customerCNIC").value,
    occupation: document.getElementById("customerOccupation").value,
    company_name: document.getElementById("customerCompany").value,
    emergency_contact_name: document.getElementById("customerEmergencyName").value,
    emergency_contact_phone: document.getElementById("customerEmergencyPhone").value,
    notes: document.getElementById("customerNotes").value,
    document_type: document.getElementById("customerDocumentType").value
  };

    // Check if this is an update or new customer
    const customerId = document.getElementById("customerId").value;
    const isUpdate = customerId && customerId.trim() !== "";
    
    const url = isUpdate ? `http://127.0.0.1:5050/customers/${customerId}` : "http://127.0.0.1:5050/customers";
    const method = isUpdate ? "PUT" : "POST";

    const response = await fetch(url, {
    method: method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(customerData)
  });

    if (response.ok) {
      const result = await response.json();
      const customerId = result.id;
      
      // Handle file uploads if any files are selected
      const customerFileInput = document.getElementById("customerFile");
      if (customerFileInput && customerFileInput.files.length > 0) {
        const formData = new FormData();
        formData.append('customer_id', customerId);
        
        for (let i = 0; i < customerFileInput.files.length; i++) {
          formData.append('files[]', customerFileInput.files[i]);
        }
        
        try {
          const fileResponse = await fetch("http://127.0.0.1:5050/upload-customer-files", {
            method: "POST",
            body: formData
          });
          
          if (fileResponse.ok) {
            const fileResult = await fileResponse.json();
            console.log("Files uploaded successfully:", fileResult);
          } else {
            console.error("Error uploading files:", await fileResponse.text());
          }
        } catch (fileError) {
          console.error("Error uploading files:", fileError);
        }
      }
      
      alert(isUpdate ? "Customer updated successfully!" : "Customer saved successfully!");
  closeCustomerForm();
  loadCustomers();
    } else {
      const error = await response.json();
      alert("Error saving customer: " + error.error);
    }
  } catch (error) {
    console.error("Error saving customer:", error);
    alert("Error saving customer. Please try again.");
  }
}

// ================= CHAT MODAL FUNCTIONS =================

function openChatModal() {
  const modal = document.getElementById('chatModal');
  modal.classList.remove('hidden');
  
  // Clear any existing messages and show welcome
  const container = document.getElementById('modalChatMessages');
  if (container) {
    container.innerHTML = '';
    ensureModalChatWelcome();
  }
  
  renderModalChatHistory();
}

function closeChatModal() {
  const modal = document.getElementById('chatModal');
  modal.classList.add('hidden');
}

function startNewChatInModal() {
  const chats = loadChats();
  const newChat = { id: Date.now().toString(), title: 'New chat', messages: [] };
  chats.unshift(newChat);
  saveChats(chats);
  setActiveChatId(newChat.id);
  
  // Reset modal chat messages
  const container = document.getElementById('modalChatMessages');
  if (container) {
    container.innerHTML = '';
    ensureModalChatWelcome();
  }
  renderModalChatHistory();
}

function toggleChatHistory() {
  const historyPanel = document.getElementById('chatHistoryPanel');
  const messagesContainer = document.getElementById('modalChatMessages');
  
  if (historyPanel.classList.contains('hidden')) {
    historyPanel.classList.remove('hidden');
    messagesContainer.style.display = 'none';
  } else {
    historyPanel.classList.add('hidden');
    messagesContainer.style.display = 'block';
  }
}

function ensureModalChatWelcome() {
  const container = document.getElementById('modalChatMessages');
  if (!container) return;
  
  // Clear any existing welcome messages first
  const existingWelcome = document.getElementById('modalChatWelcome');
  if (existingWelcome) {
    existingWelcome.remove();
  }
  
  // Only add welcome if there are no messages
  if (container.children.length === 0) {
    const welcome = document.createElement('div');
    welcome.id = 'modalChatWelcome';
    welcome.className = 'chat-welcome';
    welcome.innerHTML = `<div>
      <h3 style="margin:0 0 6px 0; color:#111;">Hello Akif</h3>
      <div>Welcome to the chat. Ask anything and I will help you.</div>
    </div>`;
    container.appendChild(welcome);
  }
}

function renderModalChatHistory() {
  const list = document.getElementById('modalChatHistory');
  if (!list) return;
  const chats = loadChats();
  const active = getActiveChatId();
  list.innerHTML = chats.map(c =>
    `<div class="history-item ${c.id === active ? 'active' : ''}" onclick="openModalChat('${c.id}')">
      <span class="history-title">${(c.title || 'New chat')}</span>
      <span class="history-actions">
        <i class="fa-solid fa-trash delete-btn" title="Delete" onclick="event.stopPropagation(); deleteChat('${c.id}')"></i>
        <i class="fa-solid fa-chevron-right chev" style="color:#64748b"></i>
      </span>
    </div>`
  ).join('');
}

function openModalChat(id) {
  setActiveChatId(id);
  const chats = loadChats();
  const chat = chats.find(c => c.id === id);
  const container = document.getElementById('modalChatMessages');
  if (!container || !chat) return;
  
  container.innerHTML = '';
  
  // Only show welcome if there are no messages
  if (chat.messages.length === 0) {
    ensureModalChatWelcome();
  } else {
    // Show existing messages
    chat.messages.forEach(m => {
      const div = document.createElement('div');
      div.className = `message ${m.role === 'user' ? 'user' : 'agent'}`;
      div.innerHTML = m.role === 'agent' ? m.content : m.content;
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  }
  
  renderModalChatHistory();
  
  // Hide history panel and show messages
  const historyPanel = document.getElementById('chatHistoryPanel');
  if (historyPanel) historyPanel.classList.add('hidden');
  container.style.display = 'block';
}

function sendModalMessage() {
  const input = document.getElementById('modalChatInput');
  const text = input.value.trim();
  if (text !== '') {
    const activeId = getActiveChatId();
    if (!activeId) startNewChatInModal();
    
    const container = document.getElementById('modalChatMessages');
    const welcome = document.getElementById('modalChatWelcome');
    if (welcome) welcome.remove();
    
    // Add user message
    const msg = document.createElement('div');
    msg.classList.add('message', 'user');
    msg.textContent = text;
    container.appendChild(msg);
    input.value = '';
    container.scrollTop = container.scrollHeight;

    // Get document preview for context
    const previewText = document.getElementById('docPreviewText')?.value || 
                       window.documentText || 
                       localStorage.getItem('currentDocumentContent') || '';

    // Send to backend and get response
    fetch("http://localhost:5050/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        question: text,
        document: previewText 
      })
    })
    .then(res => res.json())
    .then(data => {
      const agentMsg = document.createElement('div');
      agentMsg.classList.add('message', 'agent');
      
      // Better error handling with helpful messages
      let responseText = "";
      if (data.answer) {
        responseText = data.answer;
      } else if (data.error) {
        responseText = `❌ Error: ${data.error}\n\nPlease try:\n1. Refreshing the page\n2. Checking your internet connection\n3. Contacting support if the issue persists`;
      } else {
        responseText = "🤖 I'm here to help! I can assist you with:\n\n• **Case Management**: Add and track legal cases\n• **Document Handling**: Upload and analyze documents\n• **Customer Information**: Manage client details\n• **Legal Support**: Get help with your legal work\n\nWhat would you like to do today?";
      }
      
      agentMsg.innerHTML = formatAgentAnswer(responseText);
      container.appendChild(agentMsg);
      container.scrollTop = container.scrollHeight;
      // Persist both messages in history
      appendMessageToHistory('user', text);
      appendMessageToHistory('agent', agentMsg.innerHTML);
    })
    .catch(() => {
      const agentMsg = document.createElement('div');
      agentMsg.classList.add('message', 'agent');
      agentMsg.innerHTML = formatAgentAnswer("Server error. Try again.");
      container.appendChild(agentMsg);
      container.scrollTop = container.scrollHeight;
      appendMessageToHistory('user', text);
      appendMessageToHistory('agent', agentMsg.innerHTML);
    });
  }
}

function startVoiceToModal() {
  const activeId = getActiveChatId();
  if (!activeId) startNewChatInModal();

  const RecognitionCtor = (window.SpeechRecognition || window.webkitSpeechRecognition);
  if (!RecognitionCtor) {
    addModalMessage("❌ Voice recognition is not supported in this browser.", "agent");
    return;
  }
  
  const recognition = new RecognitionCtor();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();

  const listeningEl = addModalMessage("🎤 Listening... Please speak your question.", "agent", { skipHistory: true });

  recognition.onresult = function(event) {
    if (listeningEl && listeningEl.parentNode) listeningEl.parentNode.removeChild(listeningEl);
    const voiceText = event.results[0][0].transcript;
    addModalMessage("🎤 " + voiceText, "user");

    // Get document preview for context
    const previewText = document.getElementById('docPreviewText')?.value || 
                       window.documentText || 
                       localStorage.getItem('currentDocumentContent') || '';

    fetch("http://localhost:5050/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        question: voiceText,
        document: previewText 
      })
    })
    .then(res => res.json())
    .then(data => {
      let responseText = "";
      if (data.answer) {
        responseText = data.answer;
      } else if (data.error) {
        responseText = `❌ Error: ${data.error}\n\nPlease try:\n1. Refreshing the page\n2. Checking your internet connection\n3. Contacting support if the issue persists`;
      } else {
        responseText = "🤖 I'm here to help! I can assist you with:\n\n• **Case Management**: Add and track legal cases\n• **Document Handling**: Upload and analyze documents\n• **Customer Information**: Manage client details\n• **Legal Support**: Get help with your legal work\n\nWhat would you like to do today?";
      }
      addModalMessage(responseText, "agent");
    })
    .catch(() => {
      addModalMessage("❌ Voice question failed. Please try again.", "agent");
    });
  };

  recognition.onerror = function(event) {
    if (listeningEl && listeningEl.parentNode) listeningEl.parentNode.removeChild(listeningEl);
    addModalMessage("❌ Voice recognition error: " + event.error, "agent");
  };
}

function addModalMessage(text, role, options = {}) {
  const { skipHistory = false } = options;
  const container = document.getElementById('modalChatMessages');
  if (!container) return;
  
  const div = document.createElement('div');
  div.className = `message ${role === 'user' ? 'user' : (role === 'agent' ? 'agent' : 'system')}`;
  div.innerHTML = role === 'agent' ? formatAgentAnswer(text) : text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  
  if (!skipHistory && (role === 'agent' || role === 'user')) {
    appendMessageToHistory(role, div.innerHTML);
  }
  return div;
}

// Update initialization to show empty screen by default
try {
  const isAuthed = localStorage.getItem('auth') === '1';
  if (isAuthed) {
    document.getElementById('authOverlay').classList.add('hidden');
    // Show empty screen by default
    showSecondSidebar();
  } else {
    showLogin();
  }
} catch(_) {
  showLogin();
}



</script>
</html>
